import { __assign, __awaiter, __extends, __generator } from "tslib";
import { ObservableContextService } from '../api/observable-context/observable-context.service';
import { Subject, BehaviorSubject, } from 'rxjs';
import { RealTimeConnection } from './../api/real-time/real-time.connection';
import { LCUServiceSettings } from '../api/lcu-service-settings';
import { HttpClient } from '@angular/common/http';
//  TODO:  Need to manage reconnection to hub scenarios here
var StateContext = /** @class */ (function (_super) {
    __extends(StateContext, _super);
    //  Constructors
    function StateContext(injector) {
        var _this = _super.call(this) || this;
        _this.injector = injector;
        _this.connectedToState = new BehaviorSubject({
            Code: -1,
            Message: 'Initialized',
        });
        _this.ConnectedToState = _this.connectedToState.asObservable();
        _this.http = injector.get(HttpClient);
        _this.ReconnectionAttempt = new Subject();
        _this.Settings = injector.get(LCUServiceSettings);
        var rtUrl = _this.buildHubUrl('');
        var actionUrl = _this.loadActionUrl('');
        _this.rt = new RealTimeConnection(_this.http, rtUrl, actionUrl);
        _this.rt.ReconnectionAttempt.subscribe(function (val) {
            _this.ReconnectionAttempt.next(val);
        });
        _this.setup();
        return _this;
    }
    //  API Methods
    StateContext.prototype.Execute = function (action) {
        return this.executeAction(action);
    };
    StateContext.prototype.$Refresh = function (args) {
        if (args === void 0) { args = {}; }
        this.Execute({
            Arguments: args,
            Type: 'Refresh',
        });
    };
    StateContext.prototype.Start = function (shouldUpdate) {
        return __awaiter(this, void 0, void 0, function () {
            var _this = this;
            return __generator(this, function (_a) {
                if (!this.startSub) {
                    this.startSub = this.rt.Started.subscribe(function () { return __awaiter(_this, void 0, void 0, function () {
                        var groupName;
                        return __generator(this, function (_a) {
                            switch (_a.label) {
                                case 0: return [4 /*yield*/, this.connectToState(shouldUpdate)];
                                case 1:
                                    groupName = _a.sent();
                                    this.setupReceiveState(groupName);
                                    this.connectedToState.next({ Code: 0, Message: 'Success' });
                                    this.callRefresh();
                                    return [2 /*return*/];
                            }
                        });
                    }); });
                    this.rt.Start();
                }
                return [2 /*return*/];
            });
        });
    };
    //  Helpers
    StateContext.prototype.buildActionUrl = function (urlRoot) {
        var url = this.loadActionUrl(urlRoot);
        return url;
    };
    StateContext.prototype.buildHubUrl = function (urlRoot) {
        var url = this.loadHubUrl(urlRoot);
        return url;
    };
    StateContext.prototype.callRefresh = function () {
        this.$Refresh();
    };
    StateContext.prototype.connectToState = function (shouldUpdate) {
        return __awaiter(this, void 0, void 0, function () {
            var stateKey, stateName, env;
            var _this = this;
            return __generator(this, function (_a) {
                stateKey = this.loadStateKey();
                stateName = this.loadStateName();
                env = this.loadEnvironment();
                return [2 /*return*/, new Promise(function (resolve, reject) {
                        _this.rt
                            .InvokeAction('ConnectToState', _this.loadHeaders(), {
                            ShouldSend: shouldUpdate,
                            Key: stateKey,
                            State: stateName,
                            Environment: env,
                        })
                            .subscribe({
                            next: function (req) {
                                if (req.status && req.status.code === 0) {
                                    resolve(req.groupName);
                                }
                                else {
                                    reject(req.status
                                        ? req.status.message
                                        : 'Unknown issue connecting to state.');
                                }
                            },
                            error: function (err) { return reject(err); },
                        });
                    })];
            });
        });
    };
    StateContext.prototype.defaultValue = function () {
        return {};
    };
    StateContext.prototype.executeAction = function (action) {
        return __awaiter(this, void 0, void 0, function () {
            var stateKey, stateName;
            return __generator(this, function (_a) {
                stateKey = this.loadStateKey();
                stateName = this.loadStateName();
                return [2 /*return*/, this.rt
                        .InvokeAction(action.Type, this.loadHeaders(), __assign(__assign({}, action), { Key: stateKey, State: stateName }))
                        .subscribe()];
            });
        });
    };
    StateContext.prototype.loadActionPath = function () {
        var actionRoot = this.loadStateActionRoot();
        return "" + actionRoot; // ?lcu-app-id=${this.Settings.AppConfig.ID}&lcu-app-ent-api-key=${this.Settings.AppConfig.EnterpriseAPIKey}`;
    };
    StateContext.prototype.loadActionUrl = function (urlRoot) {
        var apiRoot = this.Settings ? this.Settings.APIRoot || '' : '';
        var actionPath = this.loadActionPath();
        return "" + apiRoot + (urlRoot || '') + actionPath;
    };
    StateContext.prototype.loadEnvironment = function () {
        var env = this.Settings.StateConfig
            ? this.Settings.StateConfig.Environment
            : null;
        if (!env) {
            env = '';
        }
        return env;
    };
    StateContext.prototype.loadHeaders = function () {
        return {
            'lcu-ent-api-key': this.Settings.AppConfig.EnterpriseAPIKey,
            'lcu-hub-name': this.loadStateName(),
            'lcu-state-key': this.loadStateKey(),
            'lcu-environment': this.loadEnvironment(),
            'lcu-username-mock': this.loadUsernameMock(),
        };
    };
    StateContext.prototype.loadHubPath = function () {
        var stateRoot = this.loadStateRoot();
        var env = this.loadEnvironment();
        var unmock = this.loadUsernameMock();
        return stateRoot + "?lcu-app-ent-api-key=" + this.Settings.AppConfig.EnterpriseAPIKey + "&lcu-environment=" + env + "&lcu-username-mock=" + unmock;
    };
    StateContext.prototype.loadHubUrl = function (urlRoot) {
        var apiRoot = this.Settings ? this.Settings.APIRoot || '' : '';
        var hubPath = this.loadHubPath();
        return "" + apiRoot + (urlRoot || '') + hubPath;
    };
    StateContext.prototype.loadStateRoot = function () {
        var stateRoot = this.Settings.StateConfig && this.Settings.StateConfig.Root !== undefined
            ? this.Settings.StateConfig.Root
            : '';
        return stateRoot + "/" + this.loadStateName();
    };
    StateContext.prototype.loadStateActionRoot = function () {
        var stateActinRoot = this.Settings.StateConfig &&
            this.Settings.StateConfig.ActionRoot !== undefined
            ? this.Settings.StateConfig.ActionRoot
            : '';
        return stateActinRoot + "/" + this.loadStateName();
    };
    StateContext.prototype.loadUsernameMock = function () {
        return this.Settings.StateConfig && this.Settings.StateConfig.UsernameMock
            ? this.Settings.StateConfig.UsernameMock
            : '';
    };
    StateContext.prototype.setup = function () {
        this.Start(false).then();
    };
    StateContext.prototype.setupReceiveState = function (groupName) {
        var _this = this;
        this.rt.RegisterHandler("ReceiveState=>" + groupName).subscribe(function (req) {
            _this.subject.next(req);
        });
    };
    return StateContext;
}(ObservableContextService));
export { StateContext };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGUuY29udGV4dC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BsY3UvY29tbW9uLyIsInNvdXJjZXMiOlsibGliL3N0YXRlL3N0YXRlLmNvbnRleHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLHNEQUFzRCxDQUFDO0FBR2hHLE9BQU8sRUFDTCxPQUFPLEVBR1AsZUFBZSxHQUVoQixNQUFNLE1BQU0sQ0FBQztBQUNkLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHlDQUF5QyxDQUFDO0FBQzdFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQ2pFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUdsRCw0REFBNEQ7QUFFNUQ7SUFBOEMsZ0NBQTJCO0lBbUJ2RSxnQkFBZ0I7SUFDaEIsc0JBQXNCLFFBQWtCO1FBQXhDLFlBQ0UsaUJBQU8sU0EwQlI7UUEzQnFCLGNBQVEsR0FBUixRQUFRLENBQVU7UUFHdEMsS0FBSSxDQUFDLGdCQUFnQixHQUFHLElBQUksZUFBZSxDQUFpQjtZQUMxRCxJQUFJLEVBQUUsQ0FBQyxDQUFDO1lBQ1IsT0FBTyxFQUFFLGFBQWE7U0FDdkIsQ0FBQyxDQUFDO1FBRUgsS0FBSSxDQUFDLGdCQUFnQixHQUFHLEtBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUU3RCxLQUFJLENBQUMsSUFBSSxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFckMsS0FBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksT0FBTyxFQUFXLENBQUM7UUFFbEQsS0FBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDLENBQUM7UUFFakQsSUFBTSxLQUFLLEdBQUcsS0FBSSxDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUVuQyxJQUFNLFNBQVMsR0FBRyxL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LENBQUM7SUFFUyx3Q0FBaUIsR0FBM0IsVUFBNEIsU0FBaUI7UUFBN0MsaUJBSUM7UUFIQyxJQUFJLENBQUMsRUFBRSxDQUFDLGVBQWUsQ0FBQyxtQkFBaUIsU0FBVyxDQUFDLENBQUMsU0FBUyxDQUFDLFVBQUMsR0FBRztZQUNsRSxLQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN6QixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFDSCxtQkFBQztBQUFELENBQUMsQUE3T0QsQ0FBOEMsd0JBQXdCLEdBNk9yRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHNpZ25hbFIgZnJvbSAnQGFzcG5ldC9zaWduYWxyJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZUNvbnRleHRTZXJ2aWNlIH0gZnJvbSAnLi4vYXBpL29ic2VydmFibGUtY29udGV4dC9vYnNlcnZhYmxlLWNvbnRleHQuc2VydmljZSc7XHJcbmltcG9ydCB7IFN0YXRlQWN0aW9uIH0gZnJvbSAnLi9zdGF0ZS1hY3Rpb24ubW9kZWwnO1xyXG5pbXBvcnQgeyBJbmplY3RvciwgRXZlbnRFbWl0dGVyLCBPdXRwdXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHtcclxuICBTdWJqZWN0LFxyXG4gIFN1YnNjcmlwdGlvbixcclxuICBmb3JrSm9pbixcclxuICBCZWhhdmlvclN1YmplY3QsXHJcbiAgT2JzZXJ2YWJsZSxcclxufSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgUmVhbFRpbWVDb25uZWN0aW9uIH0gZnJvbSAnLi8uLi9hcGkvcmVhbC10aW1lL3JlYWwtdGltZS5jb25uZWN0aW9uJztcclxuaW1wb3J0IHsgTENVU2VydmljZVNldHRpbmdzIH0gZnJvbSAnLi4vYXBpL2xjdS1zZXJ2aWNlLXNldHRpbmdzJztcclxuaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcclxuaW1wb3J0IHsgU3RhdHVzIH0gZnJvbSAnLi4vc3RhdHVzJztcclxuXHJcbi8vICBUT0RPOiAgTmVlZCB0byBtYW5hZ2UgcmVjb25uZWN0aW9uIHRvIGh1YiBzY2VuYXJpb3MgaGVyZVxyXG5cclxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFN0YXRlQ29udGV4dDxUPiBleHRlbmRzIE9ic2VydmFibGVDb250ZXh0U2VydmljZTxUPiB7XHJcbiAgLy8gIEZpZWxkc1xyXG4gIHByb3RlY3RlZCBjb25uZWN0ZWRUb1N0YXRlOiBCZWhhdmlvclN1YmplY3Q8U3RhdHVzPjtcclxuXHJcbiAgcHJvdGVjdGVkIGdyb3VwTmFtZTogc3RyaW5nO1xyXG5cclxuICBwcm90ZWN0ZWQgaHR0cDogSHR0cENsaWVudDtcclxuXHJcbiAgcHJvdGVjdGVkIHJ0OiBSZWFsVGltZUNvbm5lY3Rpb247XHJcblxyXG4gIHByb3RlY3RlZCBzdGFydFN1YjogU3Vic2NyaXB0aW9uO1xyXG5cclxuICAvLyAgUHJvcGVydGllc1xyXG4gIHB1YmxpYyBDb25uZWN0ZWRUb1N0YXRlOiBPYnNlcnZhYmxlPFN0YXR1cz47XHJcblxyXG4gIHB1YmxpYyBSZWNvbm5lY3Rpb25BdHRlbXB0OiBTdWJqZWN0PGJvb2xlYW4+O1xyXG5cclxuICBwdWJsaWMgU2V0dGluZ3M6IExDVVNlcnZpY2VTZXR0aW5ncztcclxuXHJcbiAgLy8gIENvbnN0cnVjdG9yc1xyXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBpbmplY3RvcjogSW5qZWN0b3IpIHtcclxuICAgIHN1cGVyKCk7XHJcblxyXG4gICAgdGhpcy5jb25uZWN0ZWRUb1N0YXRlID0gbmV3IEJlaGF2aW9yU3ViamVjdDxTdGF0dXM+KDxTdGF0dXM+e1xyXG4gICAgICBDb2RlOiAtMSxcclxuICAgICAgTWVzc2FnZTogJ0luaXRpYWxpemVkJyxcclxuICAgIH0pO1xyXG5cclxuICAgIHRoaXMuQ29ubmVjdGVkVG9TdGF0ZSA9IHRoaXMuY29ubmVjdGVkVG9TdGF0ZS5hc09ic2VydmFibGUoKTtcclxuXHJcbiAgICB0aGlzLmh0dHAgPSBpbmplY3Rvci5nZXQoSHR0cENsaWVudCk7XHJcblxyXG4gICAgdGhpcy5SZWNvbm5lY3Rpb25BdHRlbXB0ID0gbmV3IFN1YmplY3Q8Ym9vbGVhbj4oKTtcclxuXHJcbiAgICB0aGlzLlNldHRpbmdzID0gaW5qZWN0b3IuZ2V0KExDVVNlcnZpY2VTZXR0aW5ncyk7XHJcblxyXG4gICAgY29uc3QgcnRVcmwgPSB0aGlzLmJ1aWxkSHViVXJsKCcnKTtcclxuXHJcbiAgICBjb25zdCBhY3Rpb25VcmwgPSB0aGlzLmxvYWRBY3Rpb25VcmwoJycpO1xyXG5cclxuICAgIHRoaXMucnQgPSBuZXcgUmVhbFRpbWVDb25uZWN0aW9uKHRoaXMuaHR0cCwgcnRVcmwsIGFjdGlvblVybCk7XHJcblxyXG4gICAgdGhpcy5ydC5SZWNvbm5lY3Rpb25BdHRlbXB0LnN1YnNjcmliZSgodmFsOiBib29sZWFuKSA9PiB7XHJcbiAgICAgIHRoaXMuUmVjb25uZWN0aW9uQXR0ZW1wdC5uZXh0KHZhbCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICB0aGlzLnNldHVwKCk7XHJcbiAgfVxyXG5cclxuICAvLyAgQVBJIE1ldGhvZHNcclxuICBwdWJsaWMgRXhlY3V0ZShhY3Rpb246IFN0YXRlQWN0aW9uKSB7XHJcbiAgICByZXR1cm4gdGhpcy5leGVjdXRlQWN0aW9uKGFjdGlvbik7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgJFJlZnJlc2goYXJnczogYW55ID0ge30pIHtcclxuICAgIHRoaXMuRXhlY3V0ZSh7XHJcbiAgICAgIEFyZ3VtZW50czogYXJncyxcclxuICAgICAgVHlwZTogJ1JlZnJlc2gnLFxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYXN5bmMgU3RhcnQoc2hvdWxkVXBkYXRlOiBib29sZWFuKSB7XHJcbiAgICBpZiAoIXRoaXMuc3RhcnRTdWIpIHtcclxuICAgICAgdGhpcy5zdGFydFN1YiA9IHRoaXMucnQuU3RhcnRlZC5zdWJzY3JpYmUoYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGdyb3VwTmFtZSA9IGF3YWl0IHRoaXMuY29ubmVjdFRvU3RhdGUoc2hvdWxkVXBkYXRlKTtcclxuXHJcbiAgICAgICAgdGhpcy5zZXR1cFJlY2VpdmVTdGF0ZShncm91cE5hbWUpO1xyXG5cclxuICAgICAgICB0aGlzLmNvbm5lY3RlZFRvU3RhdGUubmV4dCg8U3RhdHVzPnsgQ29kZTogMCwgTWVzc2FnZTogJ1N1Y2Nlc3MnIH0pO1xyXG5cclxuICAgICAgICB0aGlzLmNhbGxSZWZyZXNoKCk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgdGhpcy5ydC5TdGFydCgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gIEhlbHBlcnNcclxuICBwcm90ZWN0ZWQgYnVpbGRBY3Rpb25VcmwodXJsUm9vdDogc3RyaW5nKSB7XHJcbiAgICBjb25zdCB1cmwgPSB0aGlzLmxvYWRBY3Rpb25VcmwodXJsUm9vdCk7XHJcblxyXG4gICAgcmV0dXJuIHVybDtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBidWlsZEh1YlVybCh1cmxSb290OiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHVybCA9IHRoaXMubG9hZEh1YlVybCh1cmxSb290KTtcclxuXHJcbiAgICByZXR1cm4gdXJsO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGNhbGxSZWZyZXNoKCkge1xyXG4gICAgdGhpcy4kUmVmcmVzaCgpO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGFzeW5jIGNvbm5lY3RUb1N0YXRlKHNob3VsZFVwZGF0ZTogYm9vbGVhbik6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgICBjb25zdCBzdGF0ZUtleSA9IHRoaXMubG9hZFN0YXRlS2V5KCk7XHJcblxyXG4gICAgY29uc3Qgc3RhdGVOYW1lID0gdGhpcy5sb2FkU3RhdGVOYW1lKCk7XHJcblxyXG4gICAgY29uc3QgZW52ID0gdGhpcy5sb2FkRW52aXJvbm1lbnQoKTtcclxuXHJcbiAgICByZXR1cm4gbmV3IFByb21pc2U8c3RyaW5nPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIHRoaXMucnRcclxuICAgICAgICAuSW52b2tlQWN0aW9uKCdDb25uZWN0VG9TdGF0ZScsIHRoaXMubG9hZEhlYWRlcnMoKSwge1xyXG4gICAgICAgICAgU2hvdWxkU2VuZDogc2hvdWxkVXBkYXRlLFxyXG4gICAgICAgICAgS2V5OiBzdGF0ZUtleSxcclxuICAgICAgICAgIFN0YXRlOiBzdGF0ZU5hbWUsXHJcbiAgICAgICAgICBFbnZpcm9ubWVudDogZW52LFxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLnN1YnNjcmliZSh7XHJcbiAgICAgICAgICBuZXh0OiAocmVxOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgaWYgKHJlcS5zdGF0dXMgJiYgcmVxLnN0YXR1cy5jb2RlID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgcmVzb2x2ZShyZXEuZ3JvdXBOYW1lKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICByZWplY3QoXHJcbiAgICAgICAgICAgICAgICByZXEuc3RhdHVzXHJcbiAgICAgICAgICAgICAgICAgID8gcmVxLnN0YXR1cy5tZXNzYWdlXHJcbiAgICAgICAgICAgICAgICAgIDogJ1Vua25vd24gaXNzdWUgY29ubmVjdGluZyB0byBzdGF0ZS4nXHJcbiAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSxcclxuICAgICAgICAgIGVycm9yOiAoZXJyKSA9PiByZWplY3QoZXJyKSxcclxuICAgICAgICAgIC8vIGNvbXBsZXRlOiAoKSA9PiBjb25zb2xlLmxvZygnT2JzZXJ2ZXIgZ290IGEgY29tcGxldGUgbm90aWZpY2F0aW9uJyksXHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBkZWZhdWx0VmFsdWUoKTogVCB7XHJcbiAgICByZXR1cm4gPFQ+e307XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgYXN5bmMgZXhlY3V0ZUFjdGlvbihhY3Rpb246IFN0YXRlQWN0aW9uKSB7XHJcbiAgICBjb25zdCBzdGF0ZUtleSA9IHRoaXMubG9hZFN0YXRlS2V5KCk7XHJcblxyXG4gICAgY29uc3Qgc3RhdGVOYW1lID0gdGhpcy5sb2FkU3RhdGVOYW1lKCk7XHJcblxyXG4gICAgcmV0dXJuIHRoaXMucnRcclxuICAgICAgLkludm9rZUFjdGlvbihhY3Rpb24uVHlwZSwgdGhpcy5sb2FkSGVhZGVycygpLCB7XHJcbiAgICAgICAgLi4uYWN0aW9uLFxyXG4gICAgICAgIEtleTogc3RhdGVLZXksXHJcbiAgICAgICAgU3RhdGU6IHN0YXRlTmFtZSxcclxuICAgICAgfSlcclxuICAgICAgLnN1YnNjcmliZSgpO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGxvYWRBY3Rpb25QYXRoKCkge1xyXG4gICAgY29uc3QgYWN0aW9uUm9vdCA9IHRoaXMubG9hZFN0YXRlQWN0aW9uUm9vdCgpO1xyXG5cclxuICAgIHJldHVybiBgJHthY3Rpb25Sb290fWA7IC8vID9sY3UtYXBwLWlkPSR7dGhpcy5TZXR0aW5ncy5BcHBDb25maWcuSUR9JmxjdS1hcHAtZW50LWFwaS1rZXk9JHt0aGlzLlNldHRpbmdzLkFwcENvbmZpZy5FbnRlcnByaXNlQVBJS2V5fWA7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgbG9hZEFjdGlvblVybCh1cmxSb290OiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IGFwaVJvb3QgPSB0aGlzLlNldHRpbmdzID8gdGhpcy5TZXR0aW5ncy5BUElSb290IHx8ICcnIDogJyc7XHJcblxyXG4gICAgY29uc3QgYWN0aW9uUGF0aCA9IHRoaXMubG9hZEFjdGlvblBhdGgoKTtcclxuXHJcbiAgICByZXR1cm4gYCR7YXBpUm9vdH0ke3VybFJvb3QgfHwgJyd9JHthY3Rpb25QYXRofWA7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgbG9hZEVudmlyb25tZW50KCkge1xyXG4gICAgbGV0IGVudiA9IHRoaXMuU2V0dGluZ3MuU3RhdGVDb25maWdcclxuICAgICAgPyB0aGlzLlNldHRpbmdzLlN0YXRlQ29uZmlnLkVudmlyb25tZW50XHJcbiAgICAgIDogbnVsbDtcclxuXHJcbiAgICBpZiAoIWVudikge1xyXG4gICAgICBlbnYgPSAnJztcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gZW52O1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGxvYWRIZWFkZXJzKCk6IHsgW2hlYWRlcjogc3RyaW5nXTogc3RyaW5nIHwgc3RyaW5nW10gfSB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAnbGN1LWVudC1hcGkta2V5JzogdGhpcy5TZXR0aW5ncy5BcHBDb25maWcuRW50ZXJwcmlzZUFQSUtleSxcclxuICAgICAgJ2xjdS1odWItbmFtZSc6IHRoaXMubG9hZFN0YXRlTmFtZSgpLFxyXG4gICAgICAnbGN1LXN0YXRlLWtleSc6IHRoaXMubG9hZFN0YXRlS2V5KCksXHJcbiAgICAgICdsY3UtZW52aXJvbm1lbnQnOiB0aGlzLmxvYWRFbnZpcm9ubWVudCgpLFxyXG4gICAgICAnbGN1LXVzZXJuYW1lLW1vY2snOiB0aGlzLmxvYWRVc2VybmFtZU1vY2soKSxcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgbG9hZEh1YlBhdGgoKSB7XHJcbiAgICBjb25zdCBzdGF0ZVJvb3QgPSB0aGlzLmxvYWRTdGF0ZVJvb3QoKTtcclxuXHJcbiAgICBjb25zdCBlbnYgPSB0aGlzLmxvYWRFbnZpcm9ubWVudCgpO1xyXG5cclxuICAgIGNvbnN0IHVubW9jayA9IHRoaXMubG9hZFVzZXJuYW1lTW9jaygpO1xyXG5cclxuICAgIHJldHVybiBgJHtzdGF0ZVJvb3R9P2xjdS1hcHAtZW50LWFwaS1rZXk9JHt0aGlzLlNldHRpbmdzLkFwcENvbmZpZy5FbnRlcnByaXNlQVBJS2V5fSZsY3UtZW52aXJvbm1lbnQ9JHtlbnZ9JmxjdS11c2VybmFtZS1tb2NrPSR7dW5tb2NrfWA7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgbG9hZEh1YlVybCh1cmxSb290OiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IGFwaVJvb3QgPSB0aGlzLlNldHRpbmdzID8gdGhpcy5TZXR0aW5ncy5BUElSb290IHx8ICcnIDogJyc7XHJcblxyXG4gICAgY29uc3QgaHViUGF0aCA9IHRoaXMubG9hZEh1YlBhdGgoKTtcclxuXHJcbiAgICByZXR1cm4gYCR7YXBpUm9vdH0ke3VybFJvb3QgfHwgJyd9JHtodWJQYXRofWA7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgbG9hZFN0YXRlS2V5KCk6IHN0cmluZztcclxuXHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGxvYWRTdGF0ZU5hbWUoKTogc3RyaW5nO1xyXG5cclxuICBwcm90ZWN0ZWQgbG9hZFN0YXRlUm9vdCgpIHtcclxuICAgIGNvbnN0IHN0YXRlUm9vdCA9XHJcbiAgICAgIHRoaXMuU2V0dGluZ3MuU3RhdGVDb25maWcgJiYgdGhpcy5TZXR0aW5ncy5TdGF0ZUNvbmZpZy5Sb290ICE9PSB1bmRlZmluZWRcclxuICAgICAgICA/IHRoaXMuU2V0dGluZ3MuU3RhdGVDb25maWcuUm9vdFxyXG4gICAgICAgIDogJyc7XHJcblxyXG4gICAgcmV0dXJuIGAke3N0YXRlUm9vdH0vJHt0aGlzLmxvYWRTdGF0ZU5hbWUoKX1gO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGxvYWRTdGF0ZUFjdGlvblJvb3QoKSB7XHJcbiAgICBjb25zdCBzdGF0ZUFjdGluUm9vdCA9XHJcbiAgICAgIHRoaXMuU2V0dGluZ3MuU3RhdGVDb25maWcgJiZcclxuICAgICAgdGhpcy5TZXR0aW5ncy5TdGF0ZUNvbmZpZy5BY3Rpb25Sb290ICE9PSB1bmRlZmluZWRcclxuICAgICAgICA/IHRoaXMuU2V0dGluZ3MuU3RhdGVDb25maWcuQWN0aW9uUm9vdFxyXG4gICAgICAgIDogJyc7XHJcblxyXG4gICAgcmV0dXJuIGAke3N0YXRlQWN0aW5Sb290fS8ke3RoaXMubG9hZFN0YXRlTmFtZSgpfWA7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgbG9hZFVzZXJuYW1lTW9jaygpIHtcclxuICAgIHJldHVybiB0aGlzLlNldHRpbmdzLlN0YXRlQ29uZmlnICYmIHRoaXMuU2V0dGluZ3MuU3RhdGVDb25maWcuVXNlcm5hbWVNb2NrXHJcbiAgICAgID8gdGhpcy5TZXR0aW5ncy5TdGF0ZUNvbmZpZy5Vc2VybmFtZU1vY2tcclxuICAgICAgOiAnJztcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBzZXR1cCgpIHtcclxuICAgIHRoaXMuU3RhcnQoZmFsc2UpLnRoZW4oKTtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBzZXR1cFJlY2VpdmVTdGF0ZShncm91cE5hbWU6IHN0cmluZykge1xyXG4gICAgdGhpcy5ydC5SZWdpc3RlckhhbmRsZXIoYFJlY2VpdmVTdGF0ZT0+JHtncm91cE5hbWV9YCkuc3Vic2NyaWJlKChyZXEpID0+IHtcclxuICAgICAgdGhpcy5zdWJqZWN0Lm5leHQocmVxKTtcclxuICAgIH0pO1xyXG4gIH1cclxufVxyXG4iXX0=