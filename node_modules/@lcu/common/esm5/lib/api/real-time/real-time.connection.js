import { __awaiter, __generator, __read, __spread } from "tslib";
import * as signalR from '@aspnet/signalr';
import { EventEmitter } from '@angular/core';
import { Observable } from 'rxjs';
var RealTimeConnection = /** @class */ (function () {
    //  Constructors
    function RealTimeConnection(http, rtUrl, actionUrl, maxConnectionRetryAttempts) {
        if (maxConnectionRetryAttempts === void 0) { maxConnectionRetryAttempts = 10; }
        this.http = http;
        this.actionUrl = actionUrl;
        this.connectionAttempts = 0;
        this.rtUrl = rtUrl;
        this.ConnectionError = new EventEmitter();
        this.ReconnectionAttempt = new EventEmitter();
        this.MaxConnectionRetryAttempts = maxConnectionRetryAttempts;
        this.Started = new EventEmitter();
    }
    //  API Methods
    RealTimeConnection.prototype.Start = function (transport) {
        var _this = this;
        if (transport === void 0) { transport = signalR.HttpTransportType.WebSockets; }
        this.buildHub(transport).then(function (hub) {
            _this.Hub = hub;
            _this.Hub.serverTimeoutInMilliseconds = 600000;
            _this.Hub.onclose(function (err) {
                console.log('onclose: ' + err);
                _this.retryConnection();
            });
            try {
                _this.Hub.start()
                    .then(function () {
                    _this.connectionAttempts = 0;
                    console.log("Connection started");
                    _this.Started.emit(_this.Hub);
                })
                    .catch(function (err) {
                    console.log('Error while starting connection: ' + err);
                    _this.ConnectionError.emit(err);
                    _this.retryConnection();
                });
            }
            catch (err) {
                console.log('Error while starting connection: ' + err);
                _this.retryConnection();
            }
        });
    };
    RealTimeConnection.prototype.RegisterHandler = function (methodName) {
        var _this = this;
        return new Observable(function (obs) {
            if (_this.Hub) {
                try {
                    _this.Hub.on(methodName, function (req) {
                        obs.next(req);
                    });
                }
                catch (err) {
                    console.log("Error while handling " + methodName + ": " + err);
                    obs.error(err);
                }
            }
            else {
                obs.error('The hub must be started and configured before registering a handler.');
            }
        });
    };
    RealTimeConnection.prototype.InvokeAction = function (methodName, headers, args) {
        var url = this.actionUrl + "/" + methodName;
        return this.http.post(url, args, {
            headers: headers,
            withCredentials: true
        });
    };
    RealTimeConnection.prototype.Invoke = function (methodName) {
        var _this = this;
        var args = [];
        for (var _i = 1; _i < arguments.length; _i++) {
            args[_i - 1] = arguments[_i];
        }
        return new Observable(function (obs) {
            var _a;
            if (_this.Hub) {
                try {
                    (_a = _this.Hub).invoke.apply(_a, __spread([methodName], args)).then(function (res) {
                        obs.next(res);
                    })
                        .catch(function (e) {
                        obs.error(e);
                    });
                }
                catch (err) {
                    console.log("Error while invoking " + methodName + ": " + err);
                    obs.error(err);
                }
            }
            else {
                obs.error('The hub must be started and configured before invoking.');
            }
        });
    };
    //  Helpers
    RealTimeConnection.prototype.buildHub = function (transport) {
        return __awaiter(this, void 0, void 0, function () {
            return __generator(this, function (_a) {
                return [2 /*return*/, new signalR.HubConnectionBuilder()
                        .configureLogging(signalR.LogLevel.Information)
                        .withUrl(this.rtUrl, {
                        transport: transport
                    })
                        .build()];
            });
        });
    };
    RealTimeConnection.prototype.stop = function () {
        return this.Hub.stop();
    };
    /**
     * Retry connection
     */
    RealTimeConnection.prototype.retryConnection = function () {
        var _this = this;
        if (this.connectionAttempts < this.MaxConnectionRetryAttempts) {
            console.log("Retrying connection attempt " + this.connectionAttempts);
            this.connectionAttempts += 1;
            setTimeout(function () {
                _this.reconnect();
            }, 1000);
        }
        else if (this.connectionAttempts >= this.MaxConnectionRetryAttempts) {
            this.stop().then();
            this.ConnectionError.emit('The maximum number of connection retries has been met.');
        }
    };
    /**
     * Attempt to reconnect
     */
    RealTimeConnection.prototype.reconnect = function () {
        this.ReconnectionAttempt.emit(this.connectionAttempts);
        this.Start();
    };
    return RealTimeConnection;
}());
export { RealTimeConnection };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVhbC10aW1lLmNvbm5lY3Rpb24uanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AbGN1L2NvbW1vbi8iLCJzb3VyY2VzIjpbImxpYi9hcGkvcmVhbC10aW1lL3JlYWwtdGltZS5jb25uZWN0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEtBQUssT0FBTyxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFBa0IsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRzdELE9BQU8sRUFDTCxVQUFVLEVBS1gsTUFBTSxNQUFNLENBQUM7QUFHZDtJQW1CRSxnQkFBZ0I7SUFDaEIsNEJBQXNCLElBQWdCLEVBQUUsS0FBYSxFQUFFLFNBQWlCLEVBQUUsMEJBQXVDO1FBQXZDLDJDQUFBLEVBQUEsK0JBQXVDO1FBQTNGLFNBQUksR0FBSixJQUFJLENBQVk7UUFDcEMsSUFBSSxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7UUFFM0IsSUFBSSxDQUFDLGtCQUFrQixHQUFHLENBQUMsQ0FBQztRQUU1QixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUVuQixJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksWUFBWSxFQUFPLENBQUM7UUFFL0MsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksWUFBWSxFQUFVLENBQUM7UUFFdEQsSUFBSSxDQUFDLDBCQUEwQixHQUFHLDBCQUEwQixDQUFDO1FBRTdELElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxZQUFZLEVBQXlCLENBQUM7SUFDM0QsQ0FBQztJQUVELGVBQWU7SUFDUixrQ0FBSyxHQUFaLFVBQ0UsU0FBMkU7UUFEN0UsaUJBb0NDO1FBbkNDLDBCQUFBLEVBQUEsWUFBdUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLFVBQVU7UUFFM0UsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBQyxHQUEwQjtZQUN2RCxLQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQztZQUVmLEtBQUksQ0FBQyxHQUFHLENBQUMsMkJBQTJCLEdBQUcsTUFBTSxDQUFDO1lBRTlDLEtBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLFVBQUEsR0FBRztnQkFDbEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEdBQUcsR0FBRyxDQUFDLENBQUM7Z0JBRS9CLEtBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztZQUN6QixDQUFDLENBQUMsQ0FBQztZQUVILElBQUk7Z0JBQ0YsS0FBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUU7cUJBQ2IsSUFBSSxDQUFDO29CQUNKLEtBQUksQ0FBQyxrQkFBa0IsR0FBRyxDQUFDLENBQUM7b0JBRTVCLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CLENBQUMsQ0FBQztvQkFFbEMsS0FBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUM5QixDQUFDLENBQUM7cUJBQ0QsS0FBSyxDQUFDLFVBQUEsR0FBRztvQkFDUixPQUFPLENBQUMsR0FBRyxDQUFDLG1DQUFtQyxHQUFHLEdBQUcsQ0FBQyxDQUFDO29CQUV2RCxLQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztvQkFFL0IsS0FBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO2dCQUN6QixDQUFDLENBQUMsQ0FBQzthQUNOO1lBQUMsT0FBTyxHQUFHLEVBQUU7Z0JBQ1osT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQ0FBbUMsR0FBRyxHQUFHLENBQUMsQ0FBQztnQkFFdkQsS0FBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO2FBQ3hCO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU0sNENBQWUsR0FBdEIsVUFBdUIsVUFBa0I7UUFBekMsaUJBa0JDO1FBakJDLE9BQU8sSUFBSSxVQUFVLENBQUMsVUFBQSxHQUFHO1lBQ3ZCLElBQUksS0FBSSxDQUFDLEdBQUcsRUFBRTtnQkFDWixJQUFJO29CQUNGLEtBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLFVBQVUsRUFBRSxVQUFBLEdBQUc7d0JBQ3pCLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQ2hCLENBQUMsQ0FBQyxDQUFDO2lCQUNKO2dCQUFDLE9BQU8sR0FBRyxFQUFFO29CQUNaLE9BQU8sQ0FBQyxHQUFHLENBQUMsMEJBQXdCLFVBQVUsT0FBSSxHQUFHLEdBQUcsQ0FBQyxDQUFDO29CQUUxRCxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2lCQUNoQjthQUNGO2lCQUFNO2dCQUNMLEdBQUcsQ0FBQyxLQUFLLENBQ1Asc0VBQXNFLENBQ3ZFLENBQUM7YUFDSDtRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVNLHlDQUFZLEdBQW5CLFVBQW9CLFVBQWtCLEVBQUUsT0FBK0QsRUFBRSxJQUFRO1FBQy9HLElBQU0sR0FBRyxHQUFNLElBQUksQ0FBQyxTQUFTLFNBQUksVUFBWSxDQUFDO1FBRTlDLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRTtZQUMvQixPQUFPLFNBQUE7WUFDUCxlQUFlLEVBQUUsSUFBSTtTQUN0QixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU0sbUNBQU0sR0FBYixVQUFjLFVBQWtCO1FBQWhDLGlCQW9CQztRQXBCaUMsY0FBYzthQUFkLFVBQWMsRUFBZCxxQkFBYyxFQUFkLElBQWM7WUFBZCw2QkFBYzs7UUFDOUMsT0FBTyxJQUFJLFVBQVUsQ0FBQyxVQUFBLEdBQUc7O1lBQ3ZCLElBQUksS0FBSSxDQUFDLEdBQUcsRUFBRTtnQkFDWixJQUFJO29CQUNGLENBQUEsS0FBQSxLQUFJLENBQUMsR0FBRyxDQUFBLENBQUMsTUFBTSxxQkFBQyxVQUFVLEdBQUssSUFBSSxHQUNoQyxJQUFJLENBQUMsVUFBQSxHQUFHO3dCQUNQLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7b0JBQ2hCLENBQUMsQ0FBQzt5QkFDRCxLQUFLLENBQUMsVUFBQSxDQUFDO3dCQUNOLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ2YsQ0FBQyxDQUFDLENBQUM7aUJBQ047Z0JBQUMsT0FBTyxHQUFHLEVBQUU7b0JBQ1osT0FBTyxDQUFDLEdBQUcsQ0FBQywwQkFBd0IsVUFBVSxPQUFJLEdBQUcsR0FBRyxDQUFDLENBQUM7b0JBRTFELEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7aUJBQ2hCO2FBQ0Y7aUJBQU07Z0JBQ0wsR0FBRyxDQUFDLEtBQUssQ0FBQyx5REFBeUQsQ0FBQyxDQUFDO2FBQ3RFO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsV0FBVztJQUNLLHFDQUFRLEdBQXhCLFVBQXlCLFNBQW9DOzs7Z0JBQzNELHNCQUFPLElBQUksT0FBTyxDQUFDLG9CQUFvQixFQUFFO3lCQUN0QyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQzt5QkFDOUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUU7d0JBQ25CLFNBQVMsV0FBQTtxQkFDVixDQUFDO3lCQUNELEtBQUssRUFBRSxFQUFDOzs7S0FDWjtJQUVTLGlDQUFJLEdBQWQ7UUFDRSxPQUFPLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDekIsQ0FBQztJQUVEOztPQUVHO0lBQ08sNENBQWUsR0FBekI7UUFBQSxpQkFnQkM7UUFmQyxJQUFJLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxJQUFJLENBQUMsMEJBQTBCLEVBQUU7WUFDN0QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQ0FBK0IsSUFBSSxDQUFDLGtCQUFvQixDQUFDLENBQUM7WUFFdEUsSUFBSSxDQUFDLGtCQUFrQixJQUFJLENBQUMsQ0FBQztZQUU3QixVQUFVLENBQUM7Z0JBQ1QsS0FBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1lBQ25CLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQztTQUNWO2FBQU0sSUFBSSxJQUFJLENBQUMsa0JBQWtCLElBQUksSUFBSSxDQUFDLDBCQUEwQixFQUFFO1lBQ3JFLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUVuQixJQUFJLENBQUMsZUFBZSxDQUFDLElBQUksQ0FDdkIsd0RBQXdELENBQ3pELENBQUM7U0FDSDtJQUNILENBQUM7SUFFRDs7T0FFRztJQUNPLHNDQUFTLEdBQW5CO1FBQ0UsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUV2RCxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDZixDQUFDO0lBQ0gseUJBQUM7QUFBRCxDQUFDLEFBektELElBeUtDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgc2lnbmFsUiBmcm9tICdAYXNwbmV0L3NpZ25hbHInO1xyXG5pbXBvcnQgeyBOZ1pvbmUsIE91dHB1dCwgRXZlbnRFbWl0dGVyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IExDVVNlcnZpY2VTZXR0aW5ncyB9IGZyb20gJy4uL2xjdS1zZXJ2aWNlLXNldHRpbmdzJztcclxuaW1wb3J0IHtcclxuICBPYnNlcnZhYmxlLFxyXG4gIEJlaGF2aW9yU3ViamVjdCxcclxuICBSZXBsYXlTdWJqZWN0LFxyXG4gIE9ic2VydmVyLFxyXG4gIFN1YmplY3RcclxufSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cEhlYWRlcnMgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XHJcblxyXG5leHBvcnQgY2xhc3MgUmVhbFRpbWVDb25uZWN0aW9uIHtcclxuICAvLyAgRmllbGRzXHJcbiAgcHJvdGVjdGVkIGFjdGlvblVybDogc3RyaW5nO1xyXG5cclxuICBwcm90ZWN0ZWQgY29ubmVjdGlvbkF0dGVtcHRzOiBudW1iZXI7XHJcblxyXG4gIHByb3RlY3RlZCBydFVybDogc3RyaW5nO1xyXG5cclxuICAvLyAgUHJvcGVydGllc1xyXG4gIHB1YmxpYyBDb25uZWN0aW9uRXJyb3I6IEV2ZW50RW1pdHRlcjxhbnk+O1xyXG5cclxuICBwdWJsaWMgSHViOiBzaWduYWxSLkh1YkNvbm5lY3Rpb247XHJcblxyXG4gIHB1YmxpYyBNYXhDb25uZWN0aW9uUmV0cnlBdHRlbXB0czogbnVtYmVyO1xyXG5cclxuICBwdWJsaWMgUmVjb25uZWN0aW9uQXR0ZW1wdDogRXZlbnRFbWl0dGVyPG51bWJlcj47XHJcblxyXG4gIHB1YmxpYyBTdGFydGVkOiBFdmVudEVtaXR0ZXI8c2lnbmFsUi5IdWJDb25uZWN0aW9uPjtcclxuXHJcbiAgLy8gIENvbnN0cnVjdG9yc1xyXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBodHRwOiBIdHRwQ2xpZW50LCBydFVybDogc3RyaW5nLCBhY3Rpb25Vcmw6IHN0cmluZywgbWF4Q29ubmVjdGlvblJldHJ5QXR0ZW1wdHM6IG51bWJlciA9IDEwKSB7XHJcbiAgICB0aGlzLmFjdGlvblVybCA9IGFjdGlvblVybDtcclxuXHJcbiAgICB0aGlzLmNvbm5lY3Rpb25BdHRlbXB0cyA9IDA7XHJcblxyXG4gICAgdGhpcy5ydFVybCA9IHJ0VXJsO1xyXG5cclxuICAgIHRoaXMuQ29ubmVjdGlvbkVycm9yID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XHJcblxyXG4gICAgdGhpcy5SZWNvbm5lY3Rpb25BdHRlbXB0ID0gbmV3IEV2ZW50RW1pdHRlcjxudW1iZXI+KCk7XHJcblxyXG4gICAgdGhpcy5NYXhDb25uZWN0aW9uUmV0cnlBdHRlbXB0cyA9IG1heENvbm5lY3Rpb25SZXRyeUF0dGVtcHRzO1xyXG5cclxuICAgIHRoaXMuU3RhcnRlZCA9IG5ldyBFdmVudEVtaXR0ZXI8c2lnbmFsUi5IdWJDb25uZWN0aW9uPigpO1xyXG4gIH1cclxuXHJcbiAgLy8gIEFQSSBNZXRob2RzXHJcbiAgcHVibGljIFN0YXJ0KFxyXG4gICAgdHJhbnNwb3J0OiBzaWduYWxSLkh0dHBUcmFuc3BvcnRUeXBlID0gc2lnbmFsUi5IdHRwVHJhbnNwb3J0VHlwZS5XZWJTb2NrZXRzXHJcbiAgKSB7XHJcbiAgICB0aGlzLmJ1aWxkSHViKHRyYW5zcG9ydCkudGhlbigoaHViOiBzaWduYWxSLkh1YkNvbm5lY3Rpb24pID0+IHtcclxuICAgICAgdGhpcy5IdWIgPSBodWI7XHJcblxyXG4gICAgICB0aGlzLkh1Yi5zZXJ2ZXJUaW1lb3V0SW5NaWxsaXNlY29uZHMgPSA2MDAwMDA7XHJcblxyXG4gICAgICB0aGlzLkh1Yi5vbmNsb3NlKGVyciA9PiB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ29uY2xvc2U6ICcgKyBlcnIpO1xyXG5cclxuICAgICAgICB0aGlzLnJldHJ5Q29ubmVjdGlvbigpO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgdGhpcy5IdWIuc3RhcnQoKVxyXG4gICAgICAgICAgLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLmNvbm5lY3Rpb25BdHRlbXB0cyA9IDA7XHJcblxyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgQ29ubmVjdGlvbiBzdGFydGVkYCk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLlN0YXJ0ZWQuZW1pdCh0aGlzLkh1Yik7XHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgICAgLmNhdGNoKGVyciA9PiB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdFcnJvciB3aGlsZSBzdGFydGluZyBjb25uZWN0aW9uOiAnICsgZXJyKTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuQ29ubmVjdGlvbkVycm9yLmVtaXQoZXJyKTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMucmV0cnlDb25uZWN0aW9uKCk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coJ0Vycm9yIHdoaWxlIHN0YXJ0aW5nIGNvbm5lY3Rpb246ICcgKyBlcnIpO1xyXG5cclxuICAgICAgICB0aGlzLnJldHJ5Q29ubmVjdGlvbigpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBSZWdpc3RlckhhbmRsZXIobWV0aG9kTmFtZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZShvYnMgPT4ge1xyXG4gICAgICBpZiAodGhpcy5IdWIpIHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgdGhpcy5IdWIub24obWV0aG9kTmFtZSwgcmVxID0+IHtcclxuICAgICAgICAgICAgb2JzLm5leHQocmVxKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgY29uc29sZS5sb2coYEVycm9yIHdoaWxlIGhhbmRsaW5nICR7bWV0aG9kTmFtZX06IGAgKyBlcnIpO1xyXG5cclxuICAgICAgICAgIG9icy5lcnJvcihlcnIpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBvYnMuZXJyb3IoXHJcbiAgICAgICAgICAnVGhlIGh1YiBtdXN0IGJlIHN0YXJ0ZWQgYW5kIGNvbmZpZ3VyZWQgYmVmb3JlIHJlZ2lzdGVyaW5nIGEgaGFuZGxlci4nXHJcbiAgICAgICAgKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgSW52b2tlQWN0aW9uKG1ldGhvZE5hbWU6IHN0cmluZywgaGVhZGVyczogSHR0cEhlYWRlcnMgfCB7IFtoZWFkZXI6IHN0cmluZ106IHN0cmluZyB8IHN0cmluZ1tdOyB9LCBhcmdzOiB7fSkge1xyXG4gICAgY29uc3QgdXJsID0gYCR7dGhpcy5hY3Rpb25Vcmx9LyR7bWV0aG9kTmFtZX1gO1xyXG5cclxuICAgIHJldHVybiB0aGlzLmh0dHAucG9zdCh1cmwsIGFyZ3MsIHtcclxuICAgICAgaGVhZGVycyxcclxuICAgICAgd2l0aENyZWRlbnRpYWxzOiB0cnVlXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBJbnZva2UobWV0aG9kTmFtZTogc3RyaW5nLCAuLi5hcmdzOiBhbnlbXSkge1xyXG4gICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlKG9icyA9PiB7XHJcbiAgICAgIGlmICh0aGlzLkh1Yikge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICB0aGlzLkh1Yi5pbnZva2UobWV0aG9kTmFtZSwgLi4uYXJncylcclxuICAgICAgICAgICAgLnRoZW4ocmVzID0+IHtcclxuICAgICAgICAgICAgICBvYnMubmV4dChyZXMpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuY2F0Y2goZSA9PiB7XHJcbiAgICAgICAgICAgICAgb2JzLmVycm9yKGUpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICAgIGNvbnNvbGUubG9nKGBFcnJvciB3aGlsZSBpbnZva2luZyAke21ldGhvZE5hbWV9OiBgICsgZXJyKTtcclxuXHJcbiAgICAgICAgICBvYnMuZXJyb3IoZXJyKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgb2JzLmVycm9yKCdUaGUgaHViIG11c3QgYmUgc3RhcnRlZCBhbmQgY29uZmlndXJlZCBiZWZvcmUgaW52b2tpbmcuJyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLy8gIEhlbHBlcnNcclxuICBwcm90ZWN0ZWQgYXN5bmMgYnVpbGRIdWIodHJhbnNwb3J0OiBzaWduYWxSLkh0dHBUcmFuc3BvcnRUeXBlKSB7XHJcbiAgICByZXR1cm4gbmV3IHNpZ25hbFIuSHViQ29ubmVjdGlvbkJ1aWxkZXIoKVxyXG4gICAgICAuY29uZmlndXJlTG9nZ2luZyhzaWduYWxSLkxvZ0xldmVsLkluZm9ybWF0aW9uKVxyXG4gICAgICAud2l0aFVybCh0aGlzLnJ0VXJsLCB7XHJcbiAgICAgICAgdHJhbnNwb3J0XHJcbiAgICAgIH0pXHJcbiAgICAgIC5idWlsZCgpO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIHN0b3AoKTogUHJvbWlzZTx2b2lkPiB7XHJcbiAgICByZXR1cm4gdGhpcy5IdWIuc3RvcCgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmV0cnkgY29ubmVjdGlvblxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCByZXRyeUNvbm5lY3Rpb24oKTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5jb25uZWN0aW9uQXR0ZW1wdHMgPCB0aGlzLk1heENvbm5lY3Rpb25SZXRyeUF0dGVtcHRzKSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKGBSZXRyeWluZyBjb25uZWN0aW9uIGF0dGVtcHQgJHt0aGlzLmNvbm5lY3Rpb25BdHRlbXB0c31gKTtcclxuXHJcbiAgICAgIHRoaXMuY29ubmVjdGlvbkF0dGVtcHRzICs9IDE7XHJcblxyXG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgICB0aGlzLnJlY29ubmVjdCgpO1xyXG4gICAgICB9LCAxMDAwKTtcclxuICAgIH0gZWxzZSBpZiAodGhpcy5jb25uZWN0aW9uQXR0ZW1wdHMgPj0gdGhpcy5NYXhDb25uZWN0aW9uUmV0cnlBdHRlbXB0cykge1xyXG4gICAgICB0aGlzLnN0b3AoKS50aGVuKCk7XHJcblxyXG4gICAgICB0aGlzLkNvbm5lY3Rpb25FcnJvci5lbWl0KFxyXG4gICAgICAgICdUaGUgbWF4aW11bSBudW1iZXIgb2YgY29ubmVjdGlvbiByZXRyaWVzIGhhcyBiZWVuIG1ldC4nXHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBBdHRlbXB0IHRvIHJlY29ubmVjdFxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCByZWNvbm5lY3QoKTogdm9pZCB7XHJcbiAgICB0aGlzLlJlY29ubmVjdGlvbkF0dGVtcHQuZW1pdCh0aGlzLmNvbm5lY3Rpb25BdHRlbXB0cyk7XHJcblxyXG4gICAgdGhpcy5TdGFydCgpO1xyXG4gIH1cclxufVxyXG4iXX0=