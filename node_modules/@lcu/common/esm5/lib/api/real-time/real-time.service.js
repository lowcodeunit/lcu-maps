import { __awaiter, __decorate, __generator, __metadata, __read, __spread } from "tslib";
import * as signalR from '@aspnet/signalr';
import { NgZone } from '@angular/core';
import { Injectable, Injector } from '@angular/core';
import { LCUServiceSettings } from '../lcu-service-settings';
import { Observable, ReplaySubject, Subject } from 'rxjs';
import * as i0 from "@angular/core";
//  TODO:  Need to manage reconnection to hub scenarios here
var RealTimeService = /** @class */ (function () {
    //  Constructors
    function RealTimeService(injector) {
        this.injector = injector;
        this.ReconnectionAttempt = new Subject();
        this.connectionAttempts = 0;
        try {
            this.Settings = injector.get(LCUServiceSettings);
            this.zone = injector.get(NgZone);
        }
        catch (err) { }
        this.started = new ReplaySubject();
        this.Started = this.started.asObservable();
        this.start();
    }
    //  API Methods
    RealTimeService.prototype.Start = function () {
        var _this = this;
        return new Promise(function (resolve, reject) {
            _this.buildHub('').then(function (hub) {
                _this.hub = hub;
                _this.hub.serverTimeoutInMilliseconds = 600000;
                _this.hub.onclose(function (err) {
                    console.log('onclose: ' + err);
                    _this.retryConnection();
                });
                try {
                    _this.hub
                        .start()
                        .then(function () {
                        // this.connectionAttempts = 0;
                        console.log("Connection started");
                        resolve(_this.hub);
                    })
                        .catch(function (err) {
                        _this.retryConnection();
                        if (_this.showConnectionError) {
                            reject(err);
                            console.log('Error while starting connection: ' + err);
                            _this.showConnectionError = false;
                        }
                    });
                }
                catch (err) {
                    console.log('Error while starting connection 02: ' + err);
                    _this.retryConnection();
                }
            });
        });
    };
    RealTimeService.prototype.RegisterHandler = function (methodName) {
        var _this = this;
        return this.WithHub(function (hub) {
            return Observable.create(function (obs) {
                try {
                    hub.on(methodName, function (req) {
                        obs.next(req);
                        _this.zone.run(function () { });
                    });
                }
                catch (err) {
                    console.log("Error while handling " + methodName + ": " + err);
                    obs.error(err);
                    _this.retryConnection();
                }
            });
        });
    };
    RealTimeService.prototype.Invoke = function (methodName) {
        var _this = this;
        var args = [];
        for (var _i = 1; _i < arguments.length; _i++) {
            args[_i - 1] = arguments[_i];
        }
        return this.WithHub(function (hub) {
            return Observable.create(function (obs) {
                try {
                    hub
                        .invoke.apply(hub, __spread([methodName], args)).then(function (res) {
                        obs.next(res);
                        _this.zone.run(function () { });
                    })
                        .catch(function (e) {
                        obs.error(e);
                    });
                }
                catch (err) {
                    console.log("Error while invoking " + methodName + ": " + err);
                    obs.error(err);
                    _this.retryConnection();
                }
            });
        });
    };
    RealTimeService.prototype.WithHub = function (action) {
        var _this = this;
        try {
            return Observable.create(function (obs) {
                if (_this.hub.state !== signalR.HubConnectionState.Connected) {
                    _this.Start().then(function (hub) {
                        console.log('Restarting connection in flight...');
                        _this.runWithHub(obs, action);
                    });
                }
                else {
                    _this.runWithHub(obs, action);
                }
            });
        }
        catch (err) {
            return Observable.create(function (obs) {
                obs.error(err);
                obs.complete();
            });
        }
    };
    //  Helpers
    RealTimeService.prototype.buildHub = function (urlRoot) {
        return __awaiter(this, void 0, void 0, function () {
            return __generator(this, function (_a) {
                this.url = this.buildHubUrl(urlRoot);
                return [2 /*return*/, (new signalR.HubConnectionBuilder()
                        .configureLogging(signalR.LogLevel.Information)
                        .withUrl(this.url)
                        // .withUrl(this.url, {
                        //   transport: signalR.HttpTransportType.LongPolling
                        // })
                        .build())];
            });
        });
    };
    RealTimeService.prototype.buildHubUrl = function (urlRoot) {
        var url = this.loadHubUrl(urlRoot);
        return url;
    };
    RealTimeService.prototype.loadHubPath = function () {
        var stateRoot = this.loadStateRoot();
        return stateRoot + "?lcu-app-id=" + this.Settings.AppConfig.ID + "&lcu-app-ent-api-key=" + this.Settings.AppConfig.EnterpriseAPIKey + "&lcu-environment=" + (this.Settings.StateConfig.Environment || '');
    };
    RealTimeService.prototype.loadHubUrl = function (urlRoot) {
        var apiRoot = this.Settings ? this.Settings.APIRoot || '' : '';
        var hubPath = this.loadHubPath();
        return "" + apiRoot + (urlRoot || '') + hubPath;
    };
    RealTimeService.prototype.loadStateRoot = function () {
        // return this.Settings.StateConfig &&
        //   this.Settings.StateConfig.Root !== undefined
        //   ? this.Settings.StateConfig.Root
        //   : '/state';
        return '/state';
    };
    RealTimeService.prototype.runWithHub = function (obs, action) {
        var _this = this;
        var res = action(this.hub);
        if (res) {
            res.subscribe(function (r) {
                obs.next(r);
                _this.zone.run(function () { });
            }, function (e) {
                obs.error(e);
            });
        }
    };
    RealTimeService.prototype.start = function () {
        var _this = this;
        setTimeout(function () {
            _this.Start().then(function (hub) { return _this.started.next(hub); });
        }, 50);
    };
    RealTimeService.prototype.stop = function () {
        // this.hub.stop();
        this.showConnectionError = true;
    };
    /**
     * Retry connection
     */
    RealTimeService.prototype.retryConnection = function () {
        if (this.connectionAttempts < 5) {
            console.log("Retrying connection attempt " + this.connectionAttempts);
            this.connectionAttempts += 1;
            this.reconnect();
        }
        else if (this.connectionAttempts >= 5) {
            this.stopReconnection();
        }
    };
    /**
     * Attempt to reconnect
     */
    RealTimeService.prototype.reconnect = function () {
        this.attemptingToReconnect = true;
        this.reconnectionMessage();
        this.start();
    };
    /**
     * Stop trying to reconnect
     */
    RealTimeService.prototype.stopReconnection = function () {
        this.attemptingToReconnect = false;
        this.reconnectionMessage();
        this.stop();
    };
    /**
     * Notify user of reconnection attempt(s)
     */
    RealTimeService.prototype.reconnectionMessage = function () {
        this.ReconnectionAttempt.next(this.attemptingToReconnect);
    };
    RealTimeService.ctorParameters = function () { return [
        { type: Injector }
    ]; };
    RealTimeService.ɵprov = i0.ɵɵdefineInjectable({ factory: function RealTimeService_Factory() { return new RealTimeService(i0.ɵɵinject(i0.INJECTOR)); }, token: RealTimeService, providedIn: "root" });
    RealTimeService = __decorate([
        Injectable({
            providedIn: 'root'
        }),
        __metadata("design:paramtypes", [Injector])
    ], RealTimeService);
    return RealTimeService;
}());
export { RealTimeService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVhbC10aW1lLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AbGN1L2NvbW1vbi8iLCJzb3VyY2VzIjpbImxpYi9hcGkvcmVhbC10aW1lL3JlYWwtdGltZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEtBQUssT0FBTyxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxNQUFNLEVBQXdCLE1BQU0sZUFBZSxDQUFDO0FBQzdELE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzdELE9BQU8sRUFDTCxVQUFVLEVBRVYsYUFBYSxFQUViLE9BQU8sRUFDUixNQUFNLE1BQU0sQ0FBQzs7QUFFZCw0REFBNEQ7QUFLNUQ7SUF5QkUsZ0JBQWdCO0lBQ2hCLHlCQUFzQixRQUFrQjtRQUFsQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ3RDLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxJQUFJLE9BQU8sRUFBVyxDQUFDO1FBQ2xELElBQUksQ0FBQyxrQkFBa0IsR0FBRyxDQUFDLENBQUM7UUFDNUIsSUFBSTtZQUNGLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1lBQ2pELElBQUksQ0FBQyxJQUFJLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUNsQztRQUFDLE9BQU8sR0FBRyxFQUFFLEdBQUU7UUFFaEIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLGFBQWEsRUFBRSxDQUFDO1FBRW5DLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUUzQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDZixDQUFDO0lBRUQsZUFBZTtJQUNSLCtCQUFLLEdBQVo7UUFBQSxpQkF1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LENBQUMsaUNBQStCLElBQUksQ0FBQyxrQkFBb0IsQ0FBQyxDQUFDO1lBRXRFLElBQUksQ0FBQyxrQkFBa0IsSUFBSSxDQUFDLENBQUM7WUFFN0IsSUFBSSxDQUFDLFNBQVMsRUFBRSxDQUFDO1NBQ2xCO2FBQU0sSUFBSSxJQUFJLENBQUMsa0JBQWtCLElBQUksQ0FBQyxFQUFFO1lBQ3ZDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1NBQ3pCO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ08sbUNBQVMsR0FBbkI7UUFDRSxJQUFJLENBQUMscUJBQXFCLEdBQUcsSUFBSSxDQUFDO1FBRWxDLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO1FBQzNCLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUNmLENBQUM7SUFFRDs7T0FFRztJQUNPLDBDQUFnQixHQUExQjtRQUNFLElBQUksQ0FBQyxxQkFBcUIsR0FBRyxLQUFLLENBQUM7UUFFbkMsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFDM0IsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2QsQ0FBQztJQUVEOztPQUVHO0lBQ08sNkNBQW1CLEdBQTdCO1FBQ0UsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMscUJBQXFCLENBQUMsQ0FBQztJQUM1RCxDQUFDOztnQkFqUCtCLFFBQVE7OztJQTFCN0IsZUFBZTtRQUgzQixVQUFVLENBQUM7WUFDVixVQUFVLEVBQUUsTUFBTTtTQUNuQixDQUFDO3lDQTJCZ0MsUUFBUTtPQTFCN0IsZUFBZSxDQTRRM0I7MEJBN1JEO0NBNlJDLEFBNVFELElBNFFDO1NBNVFZLGVBQWUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBzaWduYWxSIGZyb20gJ0Bhc3BuZXQvc2lnbmFscic7XHJcbmltcG9ydCB7IE5nWm9uZSwgT3V0cHV0LCBFdmVudEVtaXR0ZXIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgTENVU2VydmljZVNldHRpbmdzIH0gZnJvbSAnLi4vbGN1LXNlcnZpY2Utc2V0dGluZ3MnO1xyXG5pbXBvcnQge1xyXG4gIE9ic2VydmFibGUsXHJcbiAgQmVoYXZpb3JTdWJqZWN0LFxyXG4gIFJlcGxheVN1YmplY3QsXHJcbiAgT2JzZXJ2ZXIsXHJcbiAgU3ViamVjdFxyXG59IGZyb20gJ3J4anMnO1xyXG5cclxuLy8gIFRPRE86ICBOZWVkIHRvIG1hbmFnZSByZWNvbm5lY3Rpb24gdG8gaHViIHNjZW5hcmlvcyBoZXJlXHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBSZWFsVGltZVNlcnZpY2Uge1xyXG4gIC8vICBGaWVsZHNcclxuXHJcbiAgcHJvdGVjdGVkIGF0dGVtcHRpbmdUb1JlY29ubmVjdDogYm9vbGVhbjtcclxuXHJcbiAgcHJvdGVjdGVkIGNvbm5lY3Rpb25BdHRlbXB0czogbnVtYmVyO1xyXG5cclxuICBwcm90ZWN0ZWQgaHViOiBzaWduYWxSLkh1YkNvbm5lY3Rpb247XHJcblxyXG4gIHByb3RlY3RlZCBzaG93Q29ubmVjdGlvbkVycm9yOiBib29sZWFuO1xyXG5cclxuICBwcm90ZWN0ZWQgc3RhcnRlZDogUmVwbGF5U3ViamVjdDxzaWduYWxSLkh1YkNvbm5lY3Rpb24+O1xyXG5cclxuICBwcm90ZWN0ZWQgdXJsOiBzdHJpbmc7XHJcblxyXG4gIHByaXZhdGUgem9uZTogTmdab25lO1xyXG5cclxuICAvLyAgUHJvcGVydGllc1xyXG5cclxuICBwdWJsaWMgUmVjb25uZWN0aW9uQXR0ZW1wdDogU3ViamVjdDxib29sZWFuPjtcclxuXHJcbiAgcHVibGljIFNldHRpbmdzOiBMQ1VTZXJ2aWNlU2V0dGluZ3M7XHJcblxyXG4gIHB1YmxpYyBTdGFydGVkOiBPYnNlcnZhYmxlPHNpZ25hbFIuSHViQ29ubmVjdGlvbj47XHJcblxyXG4gIC8vICBDb25zdHJ1Y3RvcnNcclxuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgaW5qZWN0b3I6IEluamVjdG9yKSB7XHJcbiAgICB0aGlzLlJlY29ubmVjdGlvbkF0dGVtcHQgPSBuZXcgU3ViamVjdDxib29sZWFuPigpO1xyXG4gICAgdGhpcy5jb25uZWN0aW9uQXR0ZW1wdHMgPSAwO1xyXG4gICAgdHJ5IHtcclxuICAgICAgdGhpcy5TZXR0aW5ncyA9IGluamVjdG9yLmdldChMQ1VTZXJ2aWNlU2V0dGluZ3MpO1xyXG4gICAgICB0aGlzLnpvbmUgPSBpbmplY3Rvci5nZXQoTmdab25lKTtcclxuICAgIH0gY2F0Y2ggKGVycikge31cclxuXHJcbiAgICB0aGlzLnN0YXJ0ZWQgPSBuZXcgUmVwbGF5U3ViamVjdCgpO1xyXG5cclxuICAgIHRoaXMuU3RhcnRlZCA9IHRoaXMuc3RhcnRlZC5hc09ic2VydmFibGUoKTtcclxuXHJcbiAgICB0aGlzLnN0YXJ0KCk7XHJcbiAgfVxyXG5cclxuICAvLyAgQVBJIE1ldGhvZHNcclxuICBwdWJsaWMgU3RhcnQoKSB7XHJcbiAgICByZXR1cm4gbmV3IFByb21pc2U8c2lnbmFsUi5IdWJDb25uZWN0aW9uPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIHRoaXMuYnVpbGRIdWIoJycpLnRoZW4oKGh1Yjogc2lnbmFsUi5IdWJDb25uZWN0aW9uKSA9PiB7XHJcbiAgICAgICAgdGhpcy5odWIgPSBodWI7XHJcblxyXG4gICAgICAgIHRoaXMuaHViLnNlcnZlclRpbWVvdXRJbk1pbGxpc2Vjb25kcyA9IDYwMDAwMDtcclxuXHJcbiAgICAgICAgdGhpcy5odWIub25jbG9zZShlcnIgPT4ge1xyXG4gICAgICAgICAgY29uc29sZS5sb2coJ29uY2xvc2U6ICcgKyBlcnIpO1xyXG5cclxuICAgICAgICAgIHRoaXMucmV0cnlDb25uZWN0aW9uKCk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICB0aGlzLmh1YlxyXG4gICAgICAgICAgICAuc3RhcnQoKVxyXG4gICAgICAgICAgICAudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICAgICAgLy8gdGhpcy5jb25uZWN0aW9uQXR0ZW1wdHMgPSAwO1xyXG5cclxuICAgICAgICAgICAgICBjb25zb2xlLmxvZyhgQ29ubmVjdGlvbiBzdGFydGVkYCk7XHJcblxyXG4gICAgICAgICAgICAgIHJlc29sdmUodGhpcy5odWIpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICAgICAgICB0aGlzLnJldHJ5Q29ubmVjdGlvbigpO1xyXG5cclxuICAgICAgICAgICAgICBpZiAodGhpcy5zaG93Q29ubmVjdGlvbkVycm9yKSB7XHJcbiAgICAgICAgICAgICAgICByZWplY3QoZXJyKTtcclxuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdFcnJvciB3aGlsZSBzdGFydGluZyBjb25uZWN0aW9uOiAnICsgZXJyKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuc2hvd0Nvbm5lY3Rpb25FcnJvciA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZygnRXJyb3Igd2hpbGUgc3RhcnRpbmcgY29ubmVjdGlvbiAwMjogJyArIGVycik7XHJcblxyXG4gICAgICAgICAgdGhpcy5yZXRyeUNvbm5lY3Rpb24oKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgUmVnaXN0ZXJIYW5kbGVyKG1ldGhvZE5hbWU6IHN0cmluZykge1xyXG4gICAgcmV0dXJuIHRoaXMuV2l0aEh1YihodWIgPT4ge1xyXG4gICAgICByZXR1cm4gT2JzZXJ2YWJsZS5jcmVhdGUoKG9iczogT2JzZXJ2ZXI8YW55PikgPT4ge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICBodWIub24obWV0aG9kTmFtZSwgcmVxID0+IHtcclxuICAgICAgICAgICAgb2JzLm5leHQocmVxKTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuem9uZS5ydW4oKCkgPT4ge30pO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZyhgRXJyb3Igd2hpbGUgaGFuZGxpbmcgJHttZXRob2ROYW1lfTogYCArIGVycik7XHJcblxyXG4gICAgICAgICAgb2JzLmVycm9yKGVycik7XHJcblxyXG4gICAgICAgICAgdGhpcy5yZXRyeUNvbm5lY3Rpb24oKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgSW52b2tlKG1ldGhvZE5hbWU6IHN0cmluZywgLi4uYXJnczogYW55W10pIHtcclxuICAgIHJldHVybiB0aGlzLldpdGhIdWIoaHViID0+IHtcclxuICAgICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKChvYnM6IE9ic2VydmVyPGFueT4pID0+IHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgaHViXHJcbiAgICAgICAgICAgIC5pbnZva2UobWV0aG9kTmFtZSwgLi4uYXJncylcclxuICAgICAgICAgICAgLnRoZW4ocmVzID0+IHtcclxuICAgICAgICAgICAgICBvYnMubmV4dChyZXMpO1xyXG5cclxuICAgICAgICAgICAgICB0aGlzLnpvbmUucnVuKCgpID0+IHt9KTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmNhdGNoKGUgPT4ge1xyXG4gICAgICAgICAgICAgIG9icy5lcnJvcihlKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZyhgRXJyb3Igd2hpbGUgaW52b2tpbmcgJHttZXRob2ROYW1lfTogYCArIGVycik7XHJcblxyXG4gICAgICAgICAgb2JzLmVycm9yKGVycik7XHJcblxyXG4gICAgICAgICAgdGhpcy5yZXRyeUNvbm5lY3Rpb24oKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgV2l0aEh1YihcclxuICAgIGFjdGlvbjogKGh1Yjogc2lnbmFsUi5IdWJDb25uZWN0aW9uKSA9PiB2b2lkIHwgT2JzZXJ2YWJsZTxhbnk+XHJcbiAgKTogT2JzZXJ2YWJsZTxhbnk+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgIHJldHVybiBPYnNlcnZhYmxlLmNyZWF0ZSgob2JzOiBPYnNlcnZlcjxhbnk+KSA9PiB7XHJcbiAgICAgICAgaWYgKHRoaXMuaHViLnN0YXRlICE9PSBzaWduYWxSLkh1YkNvbm5lY3Rpb25TdGF0ZS5Db25uZWN0ZWQpIHtcclxuICAgICAgICAgIHRoaXMuU3RhcnQoKS50aGVuKGh1YiA9PiB7XHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdSZXN0YXJ0aW5nIGNvbm5lY3Rpb24gaW4gZmxpZ2h0Li4uJyk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLnJ1bldpdGhIdWIob2JzLCBhY3Rpb24pO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHRoaXMucnVuV2l0aEh1YihvYnMsIGFjdGlvbik7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICByZXR1cm4gT2JzZXJ2YWJsZS5jcmVhdGUoKG9iczogT2JzZXJ2ZXI8YW55PikgPT4ge1xyXG4gICAgICAgIG9icy5lcnJvcihlcnIpO1xyXG5cclxuICAgICAgICBvYnMuY29tcGxldGUoKTtcclxuICAgICAgfSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvLyAgSGVscGVyc1xyXG4gIHByb3RlY3RlZCBhc3luYyBidWlsZEh1Yih1cmxSb290OiBzdHJpbmcpIHtcclxuICAgIHRoaXMudXJsID0gdGhpcy5idWlsZEh1YlVybCh1cmxSb290KTtcclxuXHJcbiAgICByZXR1cm4gKFxyXG4gICAgICBuZXcgc2lnbmFsUi5IdWJDb25uZWN0aW9uQnVpbGRlcigpXHJcbiAgICAgICAgLmNvbmZpZ3VyZUxvZ2dpbmcoc2lnbmFsUi5Mb2dMZXZlbC5JbmZvcm1hdGlvbilcclxuICAgICAgICAud2l0aFVybCh0aGlzLnVybClcclxuICAgICAgICAvLyAud2l0aFVybCh0aGlzLnVybCwge1xyXG4gICAgICAgIC8vICAgdHJhbnNwb3J0OiBzaWduYWxSLkh0dHBUcmFuc3BvcnRUeXBlLkxvbmdQb2xsaW5nXHJcbiAgICAgICAgLy8gfSlcclxuICAgICAgICAuYnVpbGQoKVxyXG4gICAgKTtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBidWlsZEh1YlVybCh1cmxSb290OiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHVybCA9IHRoaXMubG9hZEh1YlVybCh1cmxSb290KTtcclxuXHJcbiAgICByZXR1cm4gdXJsO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGxvYWRIdWJQYXRoKCkge1xyXG4gICAgY29uc3Qgc3RhdGVSb290ID0gdGhpcy5sb2FkU3RhdGVSb290KCk7XHJcblxyXG4gICAgcmV0dXJuIGAke3N0YXRlUm9vdH0/bGN1LWFwcC1pZD0ke3RoaXMuU2V0dGluZ3MuQXBwQ29uZmlnLklEfSZsY3UtYXBwLWVudC1hcGkta2V5PSR7dGhpcy5TZXR0aW5ncy5BcHBDb25maWcuRW50ZXJwcmlzZUFQSUtleX0mbGN1LWVudmlyb25tZW50PSR7dGhpcy5TZXR0aW5ncy5TdGF0ZUNvbmZpZy5FbnZpcm9ubWVudCB8fCAnJ31gO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGxvYWRIdWJVcmwodXJsUm9vdDogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBhcGlSb290ID0gdGhpcy5TZXR0aW5ncyA/IHRoaXMuU2V0dGluZ3MuQVBJUm9vdCB8fCAnJyA6ICcnO1xyXG5cclxuICAgIGNvbnN0IGh1YlBhdGggPSB0aGlzLmxvYWRIdWJQYXRoKCk7XHJcblxyXG4gICAgcmV0dXJuIGAke2FwaVJvb3R9JHt1cmxSb290IHx8ICcnfSR7aHViUGF0aH1gO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGxvYWRTdGF0ZVJvb3QoKSB7XHJcbiAgICAvLyByZXR1cm4gdGhpcy5TZXR0aW5ncy5TdGF0ZUNvbmZpZyAmJlxyXG4gICAgLy8gICB0aGlzLlNldHRpbmdzLlN0YXRlQ29uZmlnLlJvb3QgIT09IHVuZGVmaW5lZFxyXG4gICAgLy8gICA/IHRoaXMuU2V0dGluZ3MuU3RhdGVDb25maWcuUm9vdFxyXG4gICAgLy8gICA6ICcvc3RhdGUnO1xyXG5cclxuICAgIHJldHVybiAnL3N0YXRlJztcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBydW5XaXRoSHViKFxyXG4gICAgb2JzOiBPYnNlcnZlcjxhbnk+LFxyXG4gICAgYWN0aW9uOiAoaHViOiBzaWduYWxSLkh1YkNvbm5lY3Rpb24pID0+IHZvaWQgfCBPYnNlcnZhYmxlPGFueT5cclxuICApIHtcclxuICAgIGNvbnN0IHJlcyA9IGFjdGlvbih0aGlzLmh1Yik7XHJcblxyXG4gICAgaWYgKHJlcykge1xyXG4gICAgICByZXMuc3Vic2NyaWJlKFxyXG4gICAgICAgIHIgPT4ge1xyXG4gICAgICAgICAgb2JzLm5leHQocik7XHJcblxyXG4gICAgICAgICAgdGhpcy56b25lLnJ1bigoKSA9PiB7fSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBlID0+IHtcclxuICAgICAgICAgIG9icy5lcnJvcihlKTtcclxuICAgICAgICB9XHJcbiAgICAgICk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgc3RhcnQoKSB7XHJcbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcclxuICAgICAgdGhpcy5TdGFydCgpLnRoZW4oaHViID0+IHRoaXMuc3RhcnRlZC5uZXh0KGh1YikpO1xyXG4gICAgfSwgNTApO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIHN0b3AoKTogdm9pZCB7XHJcbiAgICAvLyB0aGlzLmh1Yi5zdG9wKCk7XHJcbiAgICB0aGlzLnNob3dDb25uZWN0aW9uRXJyb3IgPSB0cnVlO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmV0cnkgY29ubmVjdGlvblxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCByZXRyeUNvbm5lY3Rpb24oKTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5jb25uZWN0aW9uQXR0ZW1wdHMgPCA1KSB7XHJcbiAgICAgIGNvbnNvbGUubG9nKGBSZXRyeWluZyBjb25uZWN0aW9uIGF0dGVtcHQgJHt0aGlzLmNvbm5lY3Rpb25BdHRlbXB0c31gKTtcclxuXHJcbiAgICAgIHRoaXMuY29ubmVjdGlvbkF0dGVtcHRzICs9IDE7XHJcblxyXG4gICAgICB0aGlzLnJlY29ubmVjdCgpO1xyXG4gICAgfSBlbHNlIGlmICh0aGlzLmNvbm5lY3Rpb25BdHRlbXB0cyA+PSA1KSB7XHJcbiAgICAgIHRoaXMuc3RvcFJlY29ubmVjdGlvbigpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQXR0ZW1wdCB0byByZWNvbm5lY3RcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgcmVjb25uZWN0KCk6IHZvaWQge1xyXG4gICAgdGhpcy5hdHRlbXB0aW5nVG9SZWNvbm5lY3QgPSB0cnVlO1xyXG5cclxuICAgIHRoaXMucmVjb25uZWN0aW9uTWVzc2FnZSgpO1xyXG4gICAgdGhpcy5zdGFydCgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU3RvcCB0cnlpbmcgdG8gcmVjb25uZWN0XHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIHN0b3BSZWNvbm5lY3Rpb24oKTogdm9pZCB7XHJcbiAgICB0aGlzLmF0dGVtcHRpbmdUb1JlY29ubmVjdCA9IGZhbHNlO1xyXG5cclxuICAgIHRoaXMucmVjb25uZWN0aW9uTWVzc2FnZSgpO1xyXG4gICAgdGhpcy5zdG9wKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBOb3RpZnkgdXNlciBvZiByZWNvbm5lY3Rpb24gYXR0ZW1wdChzKVxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCByZWNvbm5lY3Rpb25NZXNzYWdlKCk6IHZvaWQge1xyXG4gICAgdGhpcy5SZWNvbm5lY3Rpb25BdHRlbXB0Lm5leHQodGhpcy5hdHRlbXB0aW5nVG9SZWNvbm5lY3QpO1xyXG4gIH1cclxufVxyXG4iXX0=