import { __awaiter, __decorate, __metadata } from "tslib";
import * as signalR from '@aspnet/signalr';
import { NgZone } from '@angular/core';
import { Injectable, Injector } from '@angular/core';
import { LCUServiceSettings } from '../lcu-service-settings';
import { Observable, ReplaySubject, Subject } from 'rxjs';
import * as i0 from "@angular/core";
//  TODO:  Need to manage reconnection to hub scenarios here
let RealTimeService = class RealTimeService {
    //  Constructors
    constructor(injector) {
        this.injector = injector;
        this.ReconnectionAttempt = new Subject();
        this.connectionAttempts = 0;
        try {
            this.Settings = injector.get(LCUServiceSettings);
            this.zone = injector.get(NgZone);
        }
        catch (err) { }
        this.started = new ReplaySubject();
        this.Started = this.started.asObservable();
        this.start();
    }
    //  API Methods
    Start() {
        return new Promise((resolve, reject) => {
            this.buildHub('').then((hub) => {
                this.hub = hub;
                this.hub.serverTimeoutInMilliseconds = 600000;
                this.hub.onclose(err => {
                    console.log('onclose: ' + err);
                    this.retryConnection();
                });
                try {
                    this.hub
                        .start()
                        .then(() => {
                        // this.connectionAttempts = 0;
                        console.log(`Connection started`);
                        resolve(this.hub);
                    })
                        .catch(err => {
                        this.retryConnection();
                        if (this.showConnectionError) {
                            reject(err);
                            console.log('Error while starting connection: ' + err);
                            this.showConnectionError = false;
                        }
                    });
                }
                catch (err) {
                    console.log('Error while starting connection 02: ' + err);
                    this.retryConnection();
                }
            });
        });
    }
    RegisterHandler(methodName) {
        return this.WithHub(hub => {
            return Observable.create((obs) => {
                try {
                    hub.on(methodName, req => {
                        obs.next(req);
                        this.zone.run(() => { });
                    });
                }
                catch (err) {
                    console.log(`Error while handling ${methodName}: ` + err);
                    obs.error(err);
                    this.retryConnection();
                }
            });
        });
    }
    Invoke(methodName, ...args) {
        return this.WithHub(hub => {
            return Observable.create((obs) => {
                try {
                    hub
                        .invoke(methodName, ...args)
                        .then(res => {
                        obs.next(res);
                        this.zone.run(() => { });
                    })
                        .catch(e => {
                        obs.error(e);
                    });
                }
                catch (err) {
                    console.log(`Error while invoking ${methodName}: ` + err);
                    obs.error(err);
                    this.retryConnection();
                }
            });
        });
    }
    WithHub(action) {
        try {
            return Observable.create((obs) => {
                if (this.hub.state !== signalR.HubConnectionState.Connected) {
                    this.Start().then(hub => {
                        console.log('Restarting connection in flight...');
                        this.runWithHub(obs, action);
                    });
                }
                else {
                    this.runWithHub(obs, action);
                }
            });
        }
        catch (err) {
            return Observable.create((obs) => {
                obs.error(err);
                obs.complete();
            });
        }
    }
    //  Helpers
    buildHub(urlRoot) {
        return __awaiter(this, void 0, void 0, function* () {
            this.url = this.buildHubUrl(urlRoot);
            return (new signalR.HubConnectionBuilder()
                .configureLogging(signalR.LogLevel.Information)
                .withUrl(this.url)
                // .withUrl(this.url, {
                //   transport: signalR.HttpTransportType.LongPolling
                // })
                .build());
        });
    }
    buildHubUrl(urlRoot) {
        const url = this.loadHubUrl(urlRoot);
        return url;
    }
    loadHubPath() {
        const stateRoot = this.loadStateRoot();
        return `${stateRoot}?lcu-app-id=${this.Settings.AppConfig.ID}&lcu-app-ent-api-key=${this.Settings.AppConfig.EnterpriseAPIKey}&lcu-environment=${this.Settings.StateConfig.Environment || ''}`;
    }
    loadHubUrl(urlRoot) {
        const apiRoot = this.Settings ? this.Settings.APIRoot || '' : '';
        const hubPath = this.loadHubPath();
        return `${apiRoot}${urlRoot || ''}${hubPath}`;
    }
    loadStateRoot() {
        // return this.Settings.StateConfig &&
        //   this.Settings.StateConfig.Root !== undefined
        //   ? this.Settings.StateConfig.Root
        //   : '/state';
        return '/state';
    }
    runWithHub(obs, action) {
        const res = action(this.hub);
        if (res) {
            res.subscribe(r => {
                obs.next(r);
                this.zone.run(() => { });
            }, e => {
                obs.error(e);
            });
        }
    }
    start() {
        setTimeout(() => {
            this.Start().then(hub => this.started.next(hub));
        }, 50);
    }
    stop() {
        // this.hub.stop();
        this.showConnectionError = true;
    }
    /**
     * Retry connection
     */
    retryConnection() {
        if (this.connectionAttempts < 5) {
            console.log(`Retrying connection attempt ${this.connectionAttempts}`);
            this.connectionAttempts += 1;
            this.reconnect();
        }
        else if (this.connectionAttempts >= 5) {
            this.stopReconnection();
        }
    }
    /**
     * Attempt to reconnect
     */
    reconnect() {
        this.attemptingToReconnect = true;
        this.reconnectionMessage();
        this.start();
    }
    /**
     * Stop trying to reconnect
     */
    stopReconnection() {
        this.attemptingToReconnect = false;
        this.reconnectionMessage();
        this.stop();
    }
    /**
     * Notify user of reconnection attempt(s)
     */
    reconnectionMessage() {
        this.ReconnectionAttempt.next(this.attemptingToReconnect);
    }
};
RealTimeService.ctorParameters = () => [
    { type: Injector }
];
RealTimeService.ɵprov = i0.ɵɵdefineInjectable({ factory: function RealTimeService_Factory() { return new RealTimeService(i0.ɵɵinject(i0.INJECTOR)); }, token: RealTimeService, providedIn: "root" });
RealTimeService = __decorate([
    Injectable({
        providedIn: 'root'
    }),
    __metadata("design:paramtypes", [Injector])
], RealTimeService);
export { RealTimeService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVhbC10aW1lLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AbGN1L2NvbW1vbi8iLCJzb3VyY2VzIjpbImxpYi9hcGkvcmVhbC10aW1lL3JlYWwtdGltZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEtBQUssT0FBTyxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxNQUFNLEVBQXdCLE1BQU0sZUFBZSxDQUFDO0FBQzdELE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzdELE9BQU8sRUFDTCxVQUFVLEVBRVYsYUFBYSxFQUViLE9BQU8sRUFDUixNQUFNLE1BQU0sQ0FBQzs7QUFFZCw0REFBNEQ7QUFLNUQsSUFBYSxlQUFlLEdBQTVCLE1BQWEsZUFBZTtJQXlCMUIsZ0JBQWdCO0lBQ2hCLFlBQXNCLFFBQWtCO1FBQWxCLGFBQVEsR0FBUixRQUFRLENBQVU7UUFDdEMsSUFBSSxDQUFDLG1CQUFtQixHQUFHLElBQUksT0FBTyxFQUFXLENBQUM7UUFDbEQsSUFBSSxDQUFDLGtCQUFrQixHQUFHLENBQUMsQ0FBQztRQUM1QixJQUFJO1lBQ0YsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDLGtCQUFrQixDQUFDLENBQUM7WUFDakQsSUFBSSxDQUFDLElBQUksR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1NBQ2xDO1FBQUMsT0FBTyxHQUFHLEVBQUUsR0FBRTtRQUVoQixJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksYUFBYSxFQUFFLENBQUM7UUFFbkMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRSxDQUFDO1FBRTNDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUNmLENBQUM7SUFFRCxlQUFl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SUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUMsQ0FBQztZQUV0RSxJQUFJLENBQUMsa0JBQWtCLElBQUksQ0FBQyxDQUFDO1lBRTdCLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQztTQUNsQjthQUFNLElBQUksSUFBSSxDQUFDLGtCQUFrQixJQUFJLENBQUMsRUFBRTtZQUN2QyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztTQUN6QjtJQUNILENBQUM7SUFFRDs7T0FFRztJQUNPLFNBQVM7UUFDakIsSUFBSSxDQUFDLHFCQUFxQixHQUFHLElBQUksQ0FBQztRQUVsQyxJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztRQUMzQixJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDZixDQUFDO0lBRUQ7O09BRUc7SUFDTyxnQkFBZ0I7UUFDeEIsSUFBSSxDQUFDLHFCQUFxQixHQUFHLEtBQUssQ0FBQztRQUVuQyxJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztRQUMzQixJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDZCxDQUFDO0lBRUQ7O09BRUc7SUFDTyxtQkFBbUI7UUFDM0IsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMscUJBQXFCLENBQUMsQ0FBQztJQUM1RCxDQUFDO0NBQ0YsQ0FBQTs7WUFsUGlDLFFBQVE7OztBQTFCN0IsZUFBZTtJQUgzQixVQUFVLENBQUM7UUFDVixVQUFVLEVBQUUsTUFBTTtLQUNuQixDQUFDO3FDQTJCZ0MsUUFBUTtHQTFCN0IsZUFBZSxDQTRRM0I7U0E1UVksZUFBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHNpZ25hbFIgZnJvbSAnQGFzcG5ldC9zaWduYWxyJztcclxuaW1wb3J0IHsgTmdab25lLCBPdXRwdXQsIEV2ZW50RW1pdHRlciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBJbmplY3RhYmxlLCBJbmplY3RvciB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBMQ1VTZXJ2aWNlU2V0dGluZ3MgfSBmcm9tICcuLi9sY3Utc2VydmljZS1zZXR0aW5ncyc7XHJcbmltcG9ydCB7XHJcbiAgT2JzZXJ2YWJsZSxcclxuICBCZWhhdmlvclN1YmplY3QsXHJcbiAgUmVwbGF5U3ViamVjdCxcclxuICBPYnNlcnZlcixcclxuICBTdWJqZWN0XHJcbn0gZnJvbSAncnhqcyc7XHJcblxyXG4vLyAgVE9ETzogIE5lZWQgdG8gbWFuYWdlIHJlY29ubmVjdGlvbiB0byBodWIgc2NlbmFyaW9zIGhlcmVcclxuXHJcbkBJbmplY3RhYmxlKHtcclxuICBwcm92aWRlZEluOiAncm9vdCdcclxufSlcclxuZXhwb3J0IGNsYXNzIFJlYWxUaW1lU2VydmljZSB7XHJcbiAgLy8gIEZpZWxkc1xyXG5cclxuICBwcm90ZWN0ZWQgYXR0ZW1wdGluZ1RvUmVjb25uZWN0OiBib29sZWFuO1xyXG5cclxuICBwcm90ZWN0ZWQgY29ubmVjdGlvbkF0dGVtcHRzOiBudW1iZXI7XHJcblxyXG4gIHByb3RlY3RlZCBodWI6IHNpZ25hbFIuSHViQ29ubmVjdGlvbjtcclxuXHJcbiAgcHJvdGVjdGVkIHNob3dDb25uZWN0aW9uRXJyb3I6IGJvb2xlYW47XHJcblxyXG4gIHByb3RlY3RlZCBzdGFydGVkOiBSZXBsYXlTdWJqZWN0PHNpZ25hbFIuSHViQ29ubmVjdGlvbj47XHJcblxyXG4gIHByb3RlY3RlZCB1cmw6IHN0cmluZztcclxuXHJcbiAgcHJpdmF0ZSB6b25lOiBOZ1pvbmU7XHJcblxyXG4gIC8vICBQcm9wZXJ0aWVzXHJcblxyXG4gIHB1YmxpYyBSZWNvbm5lY3Rpb25BdHRlbXB0OiBTdWJqZWN0PGJvb2xlYW4+O1xyXG5cclxuICBwdWJsaWMgU2V0dGluZ3M6IExDVVNlcnZpY2VTZXR0aW5ncztcclxuXHJcbiAgcHVibGljIFN0YXJ0ZWQ6IE9ic2VydmFibGU8c2lnbmFsUi5IdWJDb25uZWN0aW9uPjtcclxuXHJcbiAgLy8gIENvbnN0cnVjdG9yc1xyXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBpbmplY3RvcjogSW5qZWN0b3IpIHtcclxuICAgIHRoaXMuUmVjb25uZWN0aW9uQXR0ZW1wdCA9IG5ldyBTdWJqZWN0PGJvb2xlYW4+KCk7XHJcbiAgICB0aGlzLmNvbm5lY3Rpb25BdHRlbXB0cyA9IDA7XHJcbiAgICB0cnkge1xyXG4gICAgICB0aGlzLlNldHRpbmdzID0gaW5qZWN0b3IuZ2V0KExDVVNlcnZpY2VTZXR0aW5ncyk7XHJcbiAgICAgIHRoaXMuem9uZSA9IGluamVjdG9yLmdldChOZ1pvbmUpO1xyXG4gICAgfSBjYXRjaCAoZXJyKSB7fVxyXG5cclxuICAgIHRoaXMuc3RhcnRlZCA9IG5ldyBSZXBsYXlTdWJqZWN0KCk7XHJcblxyXG4gICAgdGhpcy5TdGFydGVkID0gdGhpcy5zdGFydGVkLmFzT2JzZXJ2YWJsZSgpO1xyXG5cclxuICAgIHRoaXMuc3RhcnQoKTtcclxuICB9XHJcblxyXG4gIC8vICBBUEkgTWV0aG9kc1xyXG4gIHB1YmxpYyBTdGFydCgpIHtcclxuICAgIHJldHVybiBuZXcgUHJvbWlzZTxzaWduYWxSLkh1YkNvbm5lY3Rpb24+KChyZXNvbHZlLCByZWplY3QpID0+IHtcclxuICAgICAgdGhpcy5idWlsZEh1YignJykudGhlbigoaHViOiBzaWduYWxSLkh1YkNvbm5lY3Rpb24pID0+IHtcclxuICAgICAgICB0aGlzLmh1YiA9IGh1YjtcclxuXHJcbiAgICAgICAgdGhpcy5odWIuc2VydmVyVGltZW91dEluTWlsbGlzZWNvbmRzID0gNjAwMDAwO1xyXG5cclxuICAgICAgICB0aGlzLmh1Yi5vbmNsb3NlKGVyciA9PiB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZygnb25jbG9zZTogJyArIGVycik7XHJcblxyXG4gICAgICAgICAgdGhpcy5yZXRyeUNvbm5lY3Rpb24oKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgIHRoaXMuaHViXHJcbiAgICAgICAgICAgIC5zdGFydCgpXHJcbiAgICAgICAgICAgIC50aGVuKCgpID0+IHtcclxuICAgICAgICAgICAgICAvLyB0aGlzLmNvbm5lY3Rpb25BdHRlbXB0cyA9IDA7XHJcblxyXG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKGBDb25uZWN0aW9uIHN0YXJ0ZWRgKTtcclxuXHJcbiAgICAgICAgICAgICAgcmVzb2x2ZSh0aGlzLmh1Yik7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5jYXRjaChlcnIgPT4ge1xyXG4gICAgICAgICAgICAgIHRoaXMucmV0cnlDb25uZWN0aW9uKCk7XHJcblxyXG4gICAgICAgICAgICAgIGlmICh0aGlzLnNob3dDb25uZWN0aW9uRXJyb3IpIHtcclxuICAgICAgICAgICAgICAgIHJlamVjdChlcnIpO1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0Vycm9yIHdoaWxlIHN0YXJ0aW5nIGNvbm5lY3Rpb246ICcgKyBlcnIpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5zaG93Q29ubmVjdGlvbkVycm9yID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICAgIGNvbnNvbGUubG9nKCdFcnJvciB3aGlsZSBzdGFydGluZyBjb25uZWN0aW9uIDAyOiAnICsgZXJyKTtcclxuXHJcbiAgICAgICAgICB0aGlzLnJldHJ5Q29ubmVjdGlvbigpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBSZWdpc3RlckhhbmRsZXIobWV0aG9kTmFtZTogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gdGhpcy5XaXRoSHViKGh1YiA9PiB7XHJcbiAgICAgIHJldHVybiBPYnNlcnZhYmxlLmNyZWF0ZSgob2JzOiBPYnNlcnZlcjxhbnk+KSA9PiB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgIGh1Yi5vbihtZXRob2ROYW1lLCByZXEgPT4ge1xyXG4gICAgICAgICAgICBvYnMubmV4dChyZXEpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy56b25lLnJ1bigoKSA9PiB7fSk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICAgIGNvbnNvbGUubG9nKGBFcnJvciB3aGlsZSBoYW5kbGluZyAke21ldGhvZE5hbWV9OiBgICsgZXJyKTtcclxuXHJcbiAgICAgICAgICBvYnMuZXJyb3IoZXJyKTtcclxuXHJcbiAgICAgICAgICB0aGlzLnJldHJ5Q29ubmVjdGlvbigpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBJbnZva2UobWV0aG9kTmFtZTogc3RyaW5nLCAuLi5hcmdzOiBhbnlbXSkge1xyXG4gICAgcmV0dXJuIHRoaXMuV2l0aEh1YihodWIgPT4ge1xyXG4gICAgICByZXR1cm4gT2JzZXJ2YWJsZS5jcmVhdGUoKG9iczogT2JzZXJ2ZXI8YW55PikgPT4ge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICBodWJcclxuICAgICAgICAgICAgLmludm9rZShtZXRob2ROYW1lLCAuLi5hcmdzKVxyXG4gICAgICAgICAgICAudGhlbihyZXMgPT4ge1xyXG4gICAgICAgICAgICAgIG9icy5uZXh0KHJlcyk7XHJcblxyXG4gICAgICAgICAgICAgIHRoaXMuem9uZS5ydW4oKCkgPT4ge30pO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuY2F0Y2goZSA9PiB7XHJcbiAgICAgICAgICAgICAgb2JzLmVycm9yKGUpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICAgIGNvbnNvbGUubG9nKGBFcnJvciB3aGlsZSBpbnZva2luZyAke21ldGhvZE5hbWV9OiBgICsgZXJyKTtcclxuXHJcbiAgICAgICAgICBvYnMuZXJyb3IoZXJyKTtcclxuXHJcbiAgICAgICAgICB0aGlzLnJldHJ5Q29ubmVjdGlvbigpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBXaXRoSHViKFxyXG4gICAgYWN0aW9uOiAoaHViOiBzaWduYWxSLkh1YkNvbm5lY3Rpb24pID0+IHZvaWQgfCBPYnNlcnZhYmxlPGFueT5cclxuICApOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKChvYnM6IE9ic2VydmVyPGFueT4pID0+IHtcclxuICAgICAgICBpZiAodGhpcy5odWIuc3RhdGUgIT09IHNpZ25hbFIuSHViQ29ubmVjdGlvblN0YXRlLkNvbm5lY3RlZCkge1xyXG4gICAgICAgICAgdGhpcy5TdGFydCgpLnRoZW4oaHViID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coJ1Jlc3RhcnRpbmcgY29ubmVjdGlvbiBpbiBmbGlnaHQuLi4nKTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMucnVuV2l0aEh1YihvYnMsIGFjdGlvbik7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdGhpcy5ydW5XaXRoSHViKG9icywgYWN0aW9uKTtcclxuICAgICAgICB9XHJcbiAgICAgIH0pO1xyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgIHJldHVybiBPYnNlcnZhYmxlLmNyZWF0ZSgob2JzOiBPYnNlcnZlcjxhbnk+KSA9PiB7XHJcbiAgICAgICAgb2JzLmVycm9yKGVycik7XHJcblxyXG4gICAgICAgIG9icy5jb21wbGV0ZSgpO1xyXG4gICAgICB9KTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vICBIZWxwZXJzXHJcbiAgcHJvdGVjdGVkIGFzeW5jIGJ1aWxkSHViKHVybFJvb3Q6IHN0cmluZykge1xyXG4gICAgdGhpcy51cmwgPSB0aGlzLmJ1aWxkSHViVXJsKHVybFJvb3QpO1xyXG5cclxuICAgIHJldHVybiAoXHJcbiAgICAgIG5ldyBzaWduYWxSLkh1YkNvbm5lY3Rpb25CdWlsZGVyKClcclxuICAgICAgICAuY29uZmlndXJlTG9nZ2luZyhzaWduYWxSLkxvZ0xldmVsLkluZm9ybWF0aW9uKVxyXG4gICAgICAgIC53aXRoVXJsKHRoaXMudXJsKVxyXG4gICAgICAgIC8vIC53aXRoVXJsKHRoaXMudXJsLCB7XHJcbiAgICAgICAgLy8gICB0cmFuc3BvcnQ6IHNpZ25hbFIuSHR0cFRyYW5zcG9ydFR5cGUuTG9uZ1BvbGxpbmdcclxuICAgICAgICAvLyB9KVxyXG4gICAgICAgIC5idWlsZCgpXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGJ1aWxkSHViVXJsKHVybFJvb3Q6IHN0cmluZykge1xyXG4gICAgY29uc3QgdXJsID0gdGhpcy5sb2FkSHViVXJsKHVybFJvb3QpO1xyXG5cclxuICAgIHJldHVybiB1cmw7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgbG9hZEh1YlBhdGgoKSB7XHJcbiAgICBjb25zdCBzdGF0ZVJvb3QgPSB0aGlzLmxvYWRTdGF0ZVJvb3QoKTtcclxuXHJcbiAgICByZXR1cm4gYCR7c3RhdGVSb290fT9sY3UtYXBwLWlkPSR7dGhpcy5TZXR0aW5ncy5BcHBDb25maWcuSUR9JmxjdS1hcHAtZW50LWFwaS1rZXk9JHt0aGlzLlNldHRpbmdzLkFwcENvbmZpZy5FbnRlcnByaXNlQVBJS2V5fSZsY3UtZW52aXJvbm1lbnQ9JHt0aGlzLlNldHRpbmdzLlN0YXRlQ29uZmlnLkVudmlyb25tZW50IHx8ICcnfWA7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgbG9hZEh1YlVybCh1cmxSb290OiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IGFwaVJvb3QgPSB0aGlzLlNldHRpbmdzID8gdGhpcy5TZXR0aW5ncy5BUElSb290IHx8ICcnIDogJyc7XHJcblxyXG4gICAgY29uc3QgaHViUGF0aCA9IHRoaXMubG9hZEh1YlBhdGgoKTtcclxuXHJcbiAgICByZXR1cm4gYCR7YXBpUm9vdH0ke3VybFJvb3QgfHwgJyd9JHtodWJQYXRofWA7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgbG9hZFN0YXRlUm9vdCgpIHtcclxuICAgIC8vIHJldHVybiB0aGlzLlNldHRpbmdzLlN0YXRlQ29uZmlnICYmXHJcbiAgICAvLyAgIHRoaXMuU2V0dGluZ3MuU3RhdGVDb25maWcuUm9vdCAhPT0gdW5kZWZpbmVkXHJcbiAgICAvLyAgID8gdGhpcy5TZXR0aW5ncy5TdGF0ZUNvbmZpZy5Sb290XHJcbiAgICAvLyAgIDogJy9zdGF0ZSc7XHJcblxyXG4gICAgcmV0dXJuICcvc3RhdGUnO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIHJ1bldpdGhIdWIoXHJcbiAgICBvYnM6IE9ic2VydmVyPGFueT4sXHJcbiAgICBhY3Rpb246IChodWI6IHNpZ25hbFIuSHViQ29ubmVjdGlvbikgPT4gdm9pZCB8IE9ic2VydmFibGU8YW55PlxyXG4gICkge1xyXG4gICAgY29uc3QgcmVzID0gYWN0aW9uKHRoaXMuaHViKTtcclxuXHJcbiAgICBpZiAocmVzKSB7XHJcbiAgICAgIHJlcy5zdWJzY3JpYmUoXHJcbiAgICAgICAgciA9PiB7XHJcbiAgICAgICAgICBvYnMubmV4dChyKTtcclxuXHJcbiAgICAgICAgICB0aGlzLnpvbmUucnVuKCgpID0+IHt9KTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIGUgPT4ge1xyXG4gICAgICAgICAgb2JzLmVycm9yKGUpO1xyXG4gICAgICAgIH1cclxuICAgICAgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBzdGFydCgpIHtcclxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICB0aGlzLlN0YXJ0KCkudGhlbihodWIgPT4gdGhpcy5zdGFydGVkLm5leHQoaHViKSk7XHJcbiAgICB9LCA1MCk7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgc3RvcCgpOiB2b2lkIHtcclxuICAgIC8vIHRoaXMuaHViLnN0b3AoKTtcclxuICAgIHRoaXMuc2hvd0Nvbm5lY3Rpb25FcnJvciA9IHRydWU7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXRyeSBjb25uZWN0aW9uXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIHJldHJ5Q29ubmVjdGlvbigpOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLmNvbm5lY3Rpb25BdHRlbXB0cyA8IDUpIHtcclxuICAgICAgY29uc29sZS5sb2coYFJldHJ5aW5nIGNvbm5lY3Rpb24gYXR0ZW1wdCAke3RoaXMuY29ubmVjdGlvbkF0dGVtcHRzfWApO1xyXG5cclxuICAgICAgdGhpcy5jb25uZWN0aW9uQXR0ZW1wdHMgKz0gMTtcclxuXHJcbiAgICAgIHRoaXMucmVjb25uZWN0KCk7XHJcbiAgICB9IGVsc2UgaWYgKHRoaXMuY29ubmVjdGlvbkF0dGVtcHRzID49IDUpIHtcclxuICAgICAgdGhpcy5zdG9wUmVjb25uZWN0aW9uKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBBdHRlbXB0IHRvIHJlY29ubmVjdFxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCByZWNvbm5lY3QoKTogdm9pZCB7XHJcbiAgICB0aGlzLmF0dGVtcHRpbmdUb1JlY29ubmVjdCA9IHRydWU7XHJcblxyXG4gICAgdGhpcy5yZWNvbm5lY3Rpb25NZXNzYWdlKCk7XHJcbiAgICB0aGlzLnN0YXJ0KCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTdG9wIHRyeWluZyB0byByZWNvbm5lY3RcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgc3RvcFJlY29ubmVjdGlvbigpOiB2b2lkIHtcclxuICAgIHRoaXMuYXR0ZW1wdGluZ1RvUmVjb25uZWN0ID0gZmFsc2U7XHJcblxyXG4gICAgdGhpcy5yZWNvbm5lY3Rpb25NZXNzYWdlKCk7XHJcbiAgICB0aGlzLnN0b3AoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIE5vdGlmeSB1c2VyIG9mIHJlY29ubmVjdGlvbiBhdHRlbXB0KHMpXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIHJlY29ubmVjdGlvbk1lc3NhZ2UoKTogdm9pZCB7XHJcbiAgICB0aGlzLlJlY29ubmVjdGlvbkF0dGVtcHQubmV4dCh0aGlzLmF0dGVtcHRpbmdUb1JlY29ubmVjdCk7XHJcbiAgfVxyXG59XHJcbiJdfQ==