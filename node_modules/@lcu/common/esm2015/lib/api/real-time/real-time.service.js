import { __awaiter } from "tslib";
import * as signalR from '@aspnet/signalr';
import { NgZone } from '@angular/core';
import { Injectable, Injector } from '@angular/core';
import { LCUServiceSettings } from '../lcu-service-settings';
import { Observable, ReplaySubject, Subject } from 'rxjs';
import * as i0 from "@angular/core";
//  TODO:  Need to manage reconnection to hub scenarios here
export class RealTimeService {
    //  Constructors
    constructor(injector) {
        this.injector = injector;
        this.ReconnectionAttempt = new Subject();
        this.connectionAttempts = 0;
        try {
            this.Settings = injector.get(LCUServiceSettings);
            this.zone = injector.get(NgZone);
        }
        catch (err) { }
        this.started = new ReplaySubject();
        this.Started = this.started.asObservable();
        this.start();
    }
    //  API Methods
    Start() {
        return new Promise((resolve, reject) => {
            this.buildHub('').then((hub) => {
                this.hub = hub;
                this.hub.serverTimeoutInMilliseconds = 600000;
                this.hub.onclose(err => {
                    console.log('onclose: ' + err);
                    this.retryConnection();
                });
                try {
                    this.hub
                        .start()
                        .then(() => {
                        // this.connectionAttempts = 0;
                        console.log(`Connection started`);
                        resolve(this.hub);
                    })
                        .catch(err => {
                        this.retryConnection();
                        if (this.showConnectionError) {
                            reject(err);
                            console.log('Error while starting connection: ' + err);
                            this.showConnectionError = false;
                        }
                    });
                }
                catch (err) {
                    console.log('Error while starting connection 02: ' + err);
                    this.retryConnection();
                }
            });
        });
    }
    RegisterHandler(methodName) {
        return this.WithHub(hub => {
            return Observable.create((obs) => {
                try {
                    hub.on(methodName, req => {
                        obs.next(req);
                        this.zone.run(() => { });
                    });
                }
                catch (err) {
                    console.log(`Error while handling ${methodName}: ` + err);
                    obs.error(err);
                    this.retryConnection();
                }
            });
        });
    }
    Invoke(methodName, ...args) {
        return this.WithHub(hub => {
            return Observable.create((obs) => {
                try {
                    hub
                        .invoke(methodName, ...args)
                        .then(res => {
                        obs.next(res);
                        this.zone.run(() => { });
                    })
                        .catch(e => {
                        obs.error(e);
                    });
                }
                catch (err) {
                    console.log(`Error while invoking ${methodName}: ` + err);
                    obs.error(err);
                    this.retryConnection();
                }
            });
        });
    }
    WithHub(action) {
        try {
            return Observable.create((obs) => {
                if (this.hub.state !== signalR.HubConnectionState.Connected) {
                    this.Start().then(hub => {
                        console.log('Restarting connection in flight...');
                        this.runWithHub(obs, action);
                    });
                }
                else {
                    this.runWithHub(obs, action);
                }
            });
        }
        catch (err) {
            return Observable.create((obs) => {
                obs.error(err);
                obs.complete();
            });
        }
    }
    //  Helpers
    buildHub(urlRoot) {
        return __awaiter(this, void 0, void 0, function* () {
            this.url = this.buildHubUrl(urlRoot);
            return (new signalR.HubConnectionBuilder()
                .configureLogging(signalR.LogLevel.Information)
                .withUrl(this.url)
                // .withUrl(this.url, {
                //   transport: signalR.HttpTransportType.LongPolling
                // })
                .build());
        });
    }
    buildHubUrl(urlRoot) {
        const url = this.loadHubUrl(urlRoot);
        return url;
    }
    loadHubPath() {
        const stateRoot = this.loadStateRoot();
        return `${stateRoot}?lcu-app-id=${this.Settings.AppConfig.ID}&lcu-app-ent-api-key=${this.Settings.AppConfig.EnterpriseAPIKey}&lcu-environment=${this.Settings.StateConfig.Environment || ''}`;
    }
    loadHubUrl(urlRoot) {
        const apiRoot = this.Settings ? this.Settings.APIRoot || '' : '';
        const hubPath = this.loadHubPath();
        return `${apiRoot}${urlRoot || ''}${hubPath}`;
    }
    loadStateRoot() {
        // return this.Settings.StateConfig &&
        //   this.Settings.StateConfig.Root !== undefined
        //   ? this.Settings.StateConfig.Root
        //   : '/state';
        return '/state';
    }
    runWithHub(obs, action) {
        const res = action(this.hub);
        if (res) {
            res.subscribe(r => {
                obs.next(r);
                this.zone.run(() => { });
            }, e => {
                obs.error(e);
            });
        }
    }
    start() {
        setTimeout(() => {
            this.Start().then(hub => this.started.next(hub));
        }, 50);
    }
    stop() {
        // this.hub.stop();
        this.showConnectionError = true;
    }
    /**
     * Retry connection
     */
    retryConnection() {
        if (this.connectionAttempts < 5) {
            console.log(`Retrying connection attempt ${this.connectionAttempts}`);
            this.connectionAttempts += 1;
            this.reconnect();
        }
        else if (this.connectionAttempts >= 5) {
            this.stopReconnection();
        }
    }
    /**
     * Attempt to reconnect
     */
    reconnect() {
        this.attemptingToReconnect = true;
        this.reconnectionMessage();
        this.start();
    }
    /**
     * Stop trying to reconnect
     */
    stopReconnection() {
        this.attemptingToReconnect = false;
        this.reconnectionMessage();
        this.stop();
    }
    /**
     * Notify user of reconnection attempt(s)
     */
    reconnectionMessage() {
        this.ReconnectionAttempt.next(this.attemptingToReconnect);
    }
}
RealTimeService.ctorParameters = () => [
    { type: Injector }
];
RealTimeService.ɵprov = i0.ɵɵdefineInjectable({ factory: function RealTimeService_Factory() { return new RealTimeService(i0.ɵɵinject(i0.INJECTOR)); }, token: RealTimeService, providedIn: "root" });
RealTimeService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
RealTimeService.ctorParameters = () => [
    { type: Injector }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVhbC10aW1lLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AbGN1L2NvbW1vbi8iLCJzb3VyY2VzIjpbImxpYi9hcGkvcmVhbC10aW1lL3JlYWwtdGltZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEtBQUssT0FBTyxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxNQUFNLEVBQXdCLE1BQU0sZUFBZSxDQUFDO0FBQzdELE9BQU8sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3JELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzdELE9BQU8sRUFDTCxVQUFVLEVBRVYsYUFBYSxFQUViLE9BQU8sRUFDUixNQUFNLE1BQU0sQ0FBQzs7QUFFZCw0REFBNEQ7QUFLNUQsTUFBTSxPQUFPLGVBQWU7SUF5QjFCLGdCQUFnQjtJQUNoQixZQUFzQixRQUFrQjtRQUFsQixhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ3RDLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxJQUFJLE9BQU8sRUFBVyxDQUFDO1FBQ2xELElBQUksQ0FBQyxrQkFBa0IsR0FBRyxDQUFDLENBQUM7UUFDNUIsSUFBSTtZQUNGLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1lBQ2pELElBQUksQ0FBQyxJQUFJLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztTQUNsQztRQUFDLE9BQU8sR0FBRyxFQUFFLEdBQUU7UUFFaEIsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLGFBQWEsRUFBRSxDQUFDO1FBRW5DLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUUzQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDZixDQUFDO0lBRUQsZUFBZTtJQUNSLEtBQUs7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QkFBa0IsRUFBRSxDQUFDLENBQUM7WUFFdEUsSUFBSSxDQUFDLGtCQUFrQixJQUFJLENBQUMsQ0FBQztZQUU3QixJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7U0FDbEI7YUFBTSxJQUFJLElBQUksQ0FBQyxrQkFBa0IsSUFBSSxDQUFDLEVBQUU7WUFDdkMsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7U0FDekI7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDTyxTQUFTO1FBQ2pCLElBQUksQ0FBQyxxQkFBcUIsR0FBRyxJQUFJLENBQUM7UUFFbEMsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFDM0IsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ2YsQ0FBQztJQUVEOztPQUVHO0lBQ08sZ0JBQWdCO1FBQ3hCLElBQUksQ0FBQyxxQkFBcUIsR0FBRyxLQUFLLENBQUM7UUFFbkMsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFDM0IsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2QsQ0FBQztJQUVEOztPQUVHO0lBQ08sbUJBQW1CO1FBQzNCLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLENBQUM7SUFDNUQsQ0FBQzs7O1lBalArQixRQUFROzs7O1lBN0J6QyxVQUFVLFNBQUM7Z0JBQ1YsVUFBVSxFQUFFLE1BQU07YUFDbkI7OztZQWRvQixRQUFRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgc2lnbmFsUiBmcm9tICdAYXNwbmV0L3NpZ25hbHInO1xyXG5pbXBvcnQgeyBOZ1pvbmUsIE91dHB1dCwgRXZlbnRFbWl0dGVyIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEluamVjdGFibGUsIEluamVjdG9yIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IExDVVNlcnZpY2VTZXR0aW5ncyB9IGZyb20gJy4uL2xjdS1zZXJ2aWNlLXNldHRpbmdzJztcclxuaW1wb3J0IHtcclxuICBPYnNlcnZhYmxlLFxyXG4gIEJlaGF2aW9yU3ViamVjdCxcclxuICBSZXBsYXlTdWJqZWN0LFxyXG4gIE9ic2VydmVyLFxyXG4gIFN1YmplY3RcclxufSBmcm9tICdyeGpzJztcclxuXHJcbi8vICBUT0RPOiAgTmVlZCB0byBtYW5hZ2UgcmVjb25uZWN0aW9uIHRvIGh1YiBzY2VuYXJpb3MgaGVyZVxyXG5cclxuQEluamVjdGFibGUoe1xyXG4gIHByb3ZpZGVkSW46ICdyb290J1xyXG59KVxyXG5leHBvcnQgY2xhc3MgUmVhbFRpbWVTZXJ2aWNlIHtcclxuICAvLyAgRmllbGRzXHJcblxyXG4gIHByb3RlY3RlZCBhdHRlbXB0aW5nVG9SZWNvbm5lY3Q6IGJvb2xlYW47XHJcblxyXG4gIHByb3RlY3RlZCBjb25uZWN0aW9uQXR0ZW1wdHM6IG51bWJlcjtcclxuXHJcbiAgcHJvdGVjdGVkIGh1Yjogc2lnbmFsUi5IdWJDb25uZWN0aW9uO1xyXG5cclxuICBwcm90ZWN0ZWQgc2hvd0Nvbm5lY3Rpb25FcnJvcjogYm9vbGVhbjtcclxuXHJcbiAgcHJvdGVjdGVkIHN0YXJ0ZWQ6IFJlcGxheVN1YmplY3Q8c2lnbmFsUi5IdWJDb25uZWN0aW9uPjtcclxuXHJcbiAgcHJvdGVjdGVkIHVybDogc3RyaW5nO1xyXG5cclxuICBwcml2YXRlIHpvbmU6IE5nWm9uZTtcclxuXHJcbiAgLy8gIFByb3BlcnRpZXNcclxuXHJcbiAgcHVibGljIFJlY29ubmVjdGlvbkF0dGVtcHQ6IFN1YmplY3Q8Ym9vbGVhbj47XHJcblxyXG4gIHB1YmxpYyBTZXR0aW5nczogTENVU2VydmljZVNldHRpbmdzO1xyXG5cclxuICBwdWJsaWMgU3RhcnRlZDogT2JzZXJ2YWJsZTxzaWduYWxSLkh1YkNvbm5lY3Rpb24+O1xyXG5cclxuICAvLyAgQ29uc3RydWN0b3JzXHJcbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIGluamVjdG9yOiBJbmplY3Rvcikge1xyXG4gICAgdGhpcy5SZWNvbm5lY3Rpb25BdHRlbXB0ID0gbmV3IFN1YmplY3Q8Ym9vbGVhbj4oKTtcclxuICAgIHRoaXMuY29ubmVjdGlvbkF0dGVtcHRzID0gMDtcclxuICAgIHRyeSB7XHJcbiAgICAgIHRoaXMuU2V0dGluZ3MgPSBpbmplY3Rvci5nZXQoTENVU2VydmljZVNldHRpbmdzKTtcclxuICAgICAgdGhpcy56b25lID0gaW5qZWN0b3IuZ2V0KE5nWm9uZSk7XHJcbiAgICB9IGNhdGNoIChlcnIpIHt9XHJcblxyXG4gICAgdGhpcy5zdGFydGVkID0gbmV3IFJlcGxheVN1YmplY3QoKTtcclxuXHJcbiAgICB0aGlzLlN0YXJ0ZWQgPSB0aGlzLnN0YXJ0ZWQuYXNPYnNlcnZhYmxlKCk7XHJcblxyXG4gICAgdGhpcy5zdGFydCgpO1xyXG4gIH1cclxuXHJcbiAgLy8gIEFQSSBNZXRob2RzXHJcbiAgcHVibGljIFN0YXJ0KCkge1xyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPHNpZ25hbFIuSHViQ29ubmVjdGlvbj4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICB0aGlzLmJ1aWxkSHViKCcnKS50aGVuKChodWI6IHNpZ25hbFIuSHViQ29ubmVjdGlvbikgPT4ge1xyXG4gICAgICAgIHRoaXMuaHViID0gaHViO1xyXG5cclxuICAgICAgICB0aGlzLmh1Yi5zZXJ2ZXJUaW1lb3V0SW5NaWxsaXNlY29uZHMgPSA2MDAwMDA7XHJcblxyXG4gICAgICAgIHRoaXMuaHViLm9uY2xvc2UoZXJyID0+IHtcclxuICAgICAgICAgIGNvbnNvbGUubG9nKCdvbmNsb3NlOiAnICsgZXJyKTtcclxuXHJcbiAgICAgICAgICB0aGlzLnJldHJ5Q29ubmVjdGlvbigpO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgdGhpcy5odWJcclxuICAgICAgICAgICAgLnN0YXJ0KClcclxuICAgICAgICAgICAgLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICAgIC8vIHRoaXMuY29ubmVjdGlvbkF0dGVtcHRzID0gMDtcclxuXHJcbiAgICAgICAgICAgICAgY29uc29sZS5sb2coYENvbm5lY3Rpb24gc3RhcnRlZGApO1xyXG5cclxuICAgICAgICAgICAgICByZXNvbHZlKHRoaXMuaHViKTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmNhdGNoKGVyciA9PiB7XHJcbiAgICAgICAgICAgICAgdGhpcy5yZXRyeUNvbm5lY3Rpb24oKTtcclxuXHJcbiAgICAgICAgICAgICAgaWYgKHRoaXMuc2hvd0Nvbm5lY3Rpb25FcnJvcikge1xyXG4gICAgICAgICAgICAgICAgcmVqZWN0KGVycik7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnRXJyb3Igd2hpbGUgc3RhcnRpbmcgY29ubmVjdGlvbjogJyArIGVycik7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnNob3dDb25uZWN0aW9uRXJyb3IgPSBmYWxzZTtcclxuICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgY29uc29sZS5sb2coJ0Vycm9yIHdoaWxlIHN0YXJ0aW5nIGNvbm5lY3Rpb24gMDI6ICcgKyBlcnIpO1xyXG5cclxuICAgICAgICAgIHRoaXMucmV0cnlDb25uZWN0aW9uKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIFJlZ2lzdGVySGFuZGxlcihtZXRob2ROYW1lOiBzdHJpbmcpIHtcclxuICAgIHJldHVybiB0aGlzLldpdGhIdWIoaHViID0+IHtcclxuICAgICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKChvYnM6IE9ic2VydmVyPGFueT4pID0+IHtcclxuICAgICAgICB0cnkge1xyXG4gICAgICAgICAgaHViLm9uKG1ldGhvZE5hbWUsIHJlcSA9PiB7XHJcbiAgICAgICAgICAgIG9icy5uZXh0KHJlcSk7XHJcblxyXG4gICAgICAgICAgICB0aGlzLnpvbmUucnVuKCgpID0+IHt9KTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgY29uc29sZS5sb2coYEVycm9yIHdoaWxlIGhhbmRsaW5nICR7bWV0aG9kTmFtZX06IGAgKyBlcnIpO1xyXG5cclxuICAgICAgICAgIG9icy5lcnJvcihlcnIpO1xyXG5cclxuICAgICAgICAgIHRoaXMucmV0cnlDb25uZWN0aW9uKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIEludm9rZShtZXRob2ROYW1lOiBzdHJpbmcsIC4uLmFyZ3M6IGFueVtdKSB7XHJcbiAgICByZXR1cm4gdGhpcy5XaXRoSHViKGh1YiA9PiB7XHJcbiAgICAgIHJldHVybiBPYnNlcnZhYmxlLmNyZWF0ZSgob2JzOiBPYnNlcnZlcjxhbnk+KSA9PiB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgIGh1YlxyXG4gICAgICAgICAgICAuaW52b2tlKG1ldGhvZE5hbWUsIC4uLmFyZ3MpXHJcbiAgICAgICAgICAgIC50aGVuKHJlcyA9PiB7XHJcbiAgICAgICAgICAgICAgb2JzLm5leHQocmVzKTtcclxuXHJcbiAgICAgICAgICAgICAgdGhpcy56b25lLnJ1bigoKSA9PiB7fSk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5jYXRjaChlID0+IHtcclxuICAgICAgICAgICAgICBvYnMuZXJyb3IoZSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgY29uc29sZS5sb2coYEVycm9yIHdoaWxlIGludm9raW5nICR7bWV0aG9kTmFtZX06IGAgKyBlcnIpO1xyXG5cclxuICAgICAgICAgIG9icy5lcnJvcihlcnIpO1xyXG5cclxuICAgICAgICAgIHRoaXMucmV0cnlDb25uZWN0aW9uKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9KTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIFdpdGhIdWIoXHJcbiAgICBhY3Rpb246IChodWI6IHNpZ25hbFIuSHViQ29ubmVjdGlvbikgPT4gdm9pZCB8IE9ic2VydmFibGU8YW55PlxyXG4gICk6IE9ic2VydmFibGU8YW55PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICByZXR1cm4gT2JzZXJ2YWJsZS5jcmVhdGUoKG9iczogT2JzZXJ2ZXI8YW55PikgPT4ge1xyXG4gICAgICAgIGlmICh0aGlzLmh1Yi5zdGF0ZSAhPT0gc2lnbmFsUi5IdWJDb25uZWN0aW9uU3RhdGUuQ29ubmVjdGVkKSB7XHJcbiAgICAgICAgICB0aGlzLlN0YXJ0KCkudGhlbihodWIgPT4ge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnUmVzdGFydGluZyBjb25uZWN0aW9uIGluIGZsaWdodC4uLicpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5ydW5XaXRoSHViKG9icywgYWN0aW9uKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB0aGlzLnJ1bldpdGhIdWIob2JzLCBhY3Rpb24pO1xyXG4gICAgICAgIH1cclxuICAgICAgfSk7XHJcbiAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgcmV0dXJuIE9ic2VydmFibGUuY3JlYXRlKChvYnM6IE9ic2VydmVyPGFueT4pID0+IHtcclxuICAgICAgICBvYnMuZXJyb3IoZXJyKTtcclxuXHJcbiAgICAgICAgb2JzLmNvbXBsZXRlKCk7XHJcbiAgICAgIH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gIEhlbHBlcnNcclxuICBwcm90ZWN0ZWQgYXN5bmMgYnVpbGRIdWIodXJsUm9vdDogc3RyaW5nKSB7XHJcbiAgICB0aGlzLnVybCA9IHRoaXMuYnVpbGRIdWJVcmwodXJsUm9vdCk7XHJcblxyXG4gICAgcmV0dXJuIChcclxuICAgICAgbmV3IHNpZ25hbFIuSHViQ29ubmVjdGlvbkJ1aWxkZXIoKVxyXG4gICAgICAgIC5jb25maWd1cmVMb2dnaW5nKHNpZ25hbFIuTG9nTGV2ZWwuSW5mb3JtYXRpb24pXHJcbiAgICAgICAgLndpdGhVcmwodGhpcy51cmwpXHJcbiAgICAgICAgLy8gLndpdGhVcmwodGhpcy51cmwsIHtcclxuICAgICAgICAvLyAgIHRyYW5zcG9ydDogc2lnbmFsUi5IdHRwVHJhbnNwb3J0VHlwZS5Mb25nUG9sbGluZ1xyXG4gICAgICAgIC8vIH0pXHJcbiAgICAgICAgLmJ1aWxkKClcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgYnVpbGRIdWJVcmwodXJsUm9vdDogc3RyaW5nKSB7XHJcbiAgICBjb25zdCB1cmwgPSB0aGlzLmxvYWRIdWJVcmwodXJsUm9vdCk7XHJcblxyXG4gICAgcmV0dXJuIHVybDtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBsb2FkSHViUGF0aCgpIHtcclxuICAgIGNvbnN0IHN0YXRlUm9vdCA9IHRoaXMubG9hZFN0YXRlUm9vdCgpO1xyXG5cclxuICAgIHJldHVybiBgJHtzdGF0ZVJvb3R9P2xjdS1hcHAtaWQ9JHt0aGlzLlNldHRpbmdzLkFwcENvbmZpZy5JRH0mbGN1LWFwcC1lbnQtYXBpLWtleT0ke3RoaXMuU2V0dGluZ3MuQXBwQ29uZmlnLkVudGVycHJpc2VBUElLZXl9JmxjdS1lbnZpcm9ubWVudD0ke3RoaXMuU2V0dGluZ3MuU3RhdGVDb25maWcuRW52aXJvbm1lbnQgfHwgJyd9YDtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBsb2FkSHViVXJsKHVybFJvb3Q6IHN0cmluZykge1xyXG4gICAgY29uc3QgYXBpUm9vdCA9IHRoaXMuU2V0dGluZ3MgPyB0aGlzLlNldHRpbmdzLkFQSVJvb3QgfHwgJycgOiAnJztcclxuXHJcbiAgICBjb25zdCBodWJQYXRoID0gdGhpcy5sb2FkSHViUGF0aCgpO1xyXG5cclxuICAgIHJldHVybiBgJHthcGlSb290fSR7dXJsUm9vdCB8fCAnJ30ke2h1YlBhdGh9YDtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBsb2FkU3RhdGVSb290KCkge1xyXG4gICAgLy8gcmV0dXJuIHRoaXMuU2V0dGluZ3MuU3RhdGVDb25maWcgJiZcclxuICAgIC8vICAgdGhpcy5TZXR0aW5ncy5TdGF0ZUNvbmZpZy5Sb290ICE9PSB1bmRlZmluZWRcclxuICAgIC8vICAgPyB0aGlzLlNldHRpbmdzLlN0YXRlQ29uZmlnLlJvb3RcclxuICAgIC8vICAgOiAnL3N0YXRlJztcclxuXHJcbiAgICByZXR1cm4gJy9zdGF0ZSc7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgcnVuV2l0aEh1YihcclxuICAgIG9iczogT2JzZXJ2ZXI8YW55PixcclxuICAgIGFjdGlvbjogKGh1Yjogc2lnbmFsUi5IdWJDb25uZWN0aW9uKSA9PiB2b2lkIHwgT2JzZXJ2YWJsZTxhbnk+XHJcbiAgKSB7XHJcbiAgICBjb25zdCByZXMgPSBhY3Rpb24odGhpcy5odWIpO1xyXG5cclxuICAgIGlmIChyZXMpIHtcclxuICAgICAgcmVzLnN1YnNjcmliZShcclxuICAgICAgICByID0+IHtcclxuICAgICAgICAgIG9icy5uZXh0KHIpO1xyXG5cclxuICAgICAgICAgIHRoaXMuem9uZS5ydW4oKCkgPT4ge30pO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZSA9PiB7XHJcbiAgICAgICAgICBvYnMuZXJyb3IoZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIHN0YXJ0KCkge1xyXG4gICAgc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgIHRoaXMuU3RhcnQoKS50aGVuKGh1YiA9PiB0aGlzLnN0YXJ0ZWQubmV4dChodWIpKTtcclxuICAgIH0sIDUwKTtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBzdG9wKCk6IHZvaWQge1xyXG4gICAgLy8gdGhpcy5odWIuc3RvcCgpO1xyXG4gICAgdGhpcy5zaG93Q29ubmVjdGlvbkVycm9yID0gdHJ1ZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJldHJ5IGNvbm5lY3Rpb25cclxuICAgKi9cclxuICBwcm90ZWN0ZWQgcmV0cnlDb25uZWN0aW9uKCk6IHZvaWQge1xyXG4gICAgaWYgKHRoaXMuY29ubmVjdGlvbkF0dGVtcHRzIDwgNSkge1xyXG4gICAgICBjb25zb2xlLmxvZyhgUmV0cnlpbmcgY29ubmVjdGlvbiBhdHRlbXB0ICR7dGhpcy5jb25uZWN0aW9uQXR0ZW1wdHN9YCk7XHJcblxyXG4gICAgICB0aGlzLmNvbm5lY3Rpb25BdHRlbXB0cyArPSAxO1xyXG5cclxuICAgICAgdGhpcy5yZWNvbm5lY3QoKTtcclxuICAgIH0gZWxzZSBpZiAodGhpcy5jb25uZWN0aW9uQXR0ZW1wdHMgPj0gNSkge1xyXG4gICAgICB0aGlzLnN0b3BSZWNvbm5lY3Rpb24oKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEF0dGVtcHQgdG8gcmVjb25uZWN0XHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIHJlY29ubmVjdCgpOiB2b2lkIHtcclxuICAgIHRoaXMuYXR0ZW1wdGluZ1RvUmVjb25uZWN0ID0gdHJ1ZTtcclxuXHJcbiAgICB0aGlzLnJlY29ubmVjdGlvbk1lc3NhZ2UoKTtcclxuICAgIHRoaXMuc3RhcnQoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFN0b3AgdHJ5aW5nIHRvIHJlY29ubmVjdFxyXG4gICAqL1xyXG4gIHByb3RlY3RlZCBzdG9wUmVjb25uZWN0aW9uKCk6IHZvaWQge1xyXG4gICAgdGhpcy5hdHRlbXB0aW5nVG9SZWNvbm5lY3QgPSBmYWxzZTtcclxuXHJcbiAgICB0aGlzLnJlY29ubmVjdGlvbk1lc3NhZ2UoKTtcclxuICAgIHRoaXMuc3RvcCgpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogTm90aWZ5IHVzZXIgb2YgcmVjb25uZWN0aW9uIGF0dGVtcHQocylcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgcmVjb25uZWN0aW9uTWVzc2FnZSgpOiB2b2lkIHtcclxuICAgIHRoaXMuUmVjb25uZWN0aW9uQXR0ZW1wdC5uZXh0KHRoaXMuYXR0ZW1wdGluZ1RvUmVjb25uZWN0KTtcclxuICB9XHJcbn1cclxuIl19