import { __awaiter } from "tslib";
import * as signalR from '@aspnet/signalr';
import { EventEmitter } from '@angular/core';
import { Observable } from 'rxjs';
export class RealTimeConnection {
    //  Constructors
    constructor(http, rtUrl, actionUrl, maxConnectionRetryAttempts = 10) {
        this.http = http;
        this.actionUrl = actionUrl;
        this.connectionAttempts = 0;
        this.rtUrl = rtUrl;
        this.ConnectionError = new EventEmitter();
        this.ReconnectionAttempt = new EventEmitter();
        this.MaxConnectionRetryAttempts = maxConnectionRetryAttempts;
        this.Started = new EventEmitter();
    }
    //  API Methods
    Start(transport = signalR.HttpTransportType.WebSockets) {
        this.buildHub(transport).then((hub) => {
            this.Hub = hub;
            this.Hub.serverTimeoutInMilliseconds = 600000;
            this.Hub.onclose(err => {
                console.log('onclose: ' + err);
                this.retryConnection();
            });
            try {
                this.Hub.start()
                    .then(() => {
                    this.connectionAttempts = 0;
                    console.log(`Connection started`);
                    this.Started.emit(this.Hub);
                })
                    .catch(err => {
                    console.log('Error while starting connection: ' + err);
                    this.ConnectionError.emit(err);
                    this.retryConnection();
                });
            }
            catch (err) {
                console.log('Error while starting connection: ' + err);
                this.retryConnection();
            }
        });
    }
    RegisterHandler(methodName) {
        return new Observable(obs => {
            if (this.Hub) {
                try {
                    this.Hub.on(methodName, req => {
                        obs.next(req);
                    });
                }
                catch (err) {
                    console.log(`Error while handling ${methodName}: ` + err);
                    obs.error(err);
                }
            }
            else {
                obs.error('The hub must be started and configured before registering a handler.');
            }
        });
    }
    InvokeAction(methodName, headers, args) {
        const url = `${this.actionUrl}/${methodName}`;
        return this.http.post(url, args, {
            headers,
            withCredentials: true
        });
    }
    Invoke(methodName, ...args) {
        return new Observable(obs => {
            if (this.Hub) {
                try {
                    this.Hub.invoke(methodName, ...args)
                        .then(res => {
                        obs.next(res);
                    })
                        .catch(e => {
                        obs.error(e);
                    });
                }
                catch (err) {
                    console.log(`Error while invoking ${methodName}: ` + err);
                    obs.error(err);
                }
            }
            else {
                obs.error('The hub must be started and configured before invoking.');
            }
        });
    }
    //  Helpers
    buildHub(transport) {
        return __awaiter(this, void 0, void 0, function* () {
            return new signalR.HubConnectionBuilder()
                .configureLogging(signalR.LogLevel.Information)
                .withUrl(this.rtUrl, {
                transport
            })
                .build();
        });
    }
    stop() {
        return this.Hub.stop();
    }
    /**
     * Retry connection
     */
    retryConnection() {
        if (this.connectionAttempts < this.MaxConnectionRetryAttempts) {
            console.log(`Retrying connection attempt ${this.connectionAttempts}`);
            this.connectionAttempts += 1;
            setTimeout(() => {
                this.reconnect();
            }, 1000);
        }
        else if (this.connectionAttempts >= this.MaxConnectionRetryAttempts) {
            this.stop().then();
            this.ConnectionError.emit('The maximum number of connection retries has been met.');
        }
    }
    /**
     * Attempt to reconnect
     */
    reconnect() {
        this.ReconnectionAttempt.emit(this.connectionAttempts);
        this.Start();
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVhbC10aW1lLmNvbm5lY3Rpb24uanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AbGN1L2NvbW1vbi8iLCJzb3VyY2VzIjpbImxpYi9hcGkvcmVhbC10aW1lL3JlYWwtdGltZS5jb25uZWN0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEtBQUssT0FBTyxNQUFNLGlCQUFpQixDQUFDO0FBQzNDLE9BQU8sRUFBa0IsWUFBWSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRzdELE9BQU8sRUFDTCxVQUFVLEVBS1gsTUFBTSxNQUFNLENBQUM7QUFHZCxNQUFNLE9BQU8sa0JBQWtCO0lBbUI3QixnQkFBZ0I7SUFDaEIsWUFBc0IsSUFBZ0IsRUFBRSxLQUFhLEVBQUUsU0FBaUIsRUFBRSw2QkFBcUMsRUFBRTtRQUEzRixTQUFJLEdBQUosSUFBSSxDQUFZO1FBQ3BDLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDO1FBRTNCLElBQUksQ0FBQyxrQkFBa0IsR0FBRyxDQUFDLENBQUM7UUFFNUIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFFbkIsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLFlBQVksRUFBTyxDQUFDO1FBRS9DLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxJQUFJLFlBQVksRUFBVSxDQUFDO1FBRXRELElBQUksQ0FBQywwQkFBMEIsR0FBRywwQkFBMEIsQ0FBQztRQUU3RCxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksWUFBWSxFQUF5QixDQUFDO0lBQzNELENBQUM7SUFFRCxlQUFlO0lBQ1IsS0FBSyxDQUNWLFlBQXVDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxVQUFVO1FBRTNFLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBMEIsRUFBRSxFQUFFO1lBQzNELElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDO1lBRWYsSUFBSSxDQUFDLEdBQUcsQ0FBQywyQkFBMkIsR0FB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QXdELENBQ3pELENBQUM7U0FDSDtJQUNILENBQUM7SUFFRDs7T0FFRztJQUNPLFNBQVM7UUFDakIsSUFBSSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUV2RCxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDZixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBzaWduYWxSIGZyb20gJ0Bhc3BuZXQvc2lnbmFscic7XHJcbmltcG9ydCB7IE5nWm9uZSwgT3V0cHV0LCBFdmVudEVtaXR0ZXIgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgTENVU2VydmljZVNldHRpbmdzIH0gZnJvbSAnLi4vbGN1LXNlcnZpY2Utc2V0dGluZ3MnO1xyXG5pbXBvcnQge1xyXG4gIE9ic2VydmFibGUsXHJcbiAgQmVoYXZpb3JTdWJqZWN0LFxyXG4gIFJlcGxheVN1YmplY3QsXHJcbiAgT2JzZXJ2ZXIsXHJcbiAgU3ViamVjdFxyXG59IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBIdHRwQ2xpZW50LCBIdHRwSGVhZGVycyB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcclxuXHJcbmV4cG9ydCBjbGFzcyBSZWFsVGltZUNvbm5lY3Rpb24ge1xyXG4gIC8vICBGaWVsZHNcclxuICBwcm90ZWN0ZWQgYWN0aW9uVXJsOiBzdHJpbmc7XHJcblxyXG4gIHByb3RlY3RlZCBjb25uZWN0aW9uQXR0ZW1wdHM6IG51bWJlcjtcclxuXHJcbiAgcHJvdGVjdGVkIHJ0VXJsOiBzdHJpbmc7XHJcblxyXG4gIC8vICBQcm9wZXJ0aWVzXHJcbiAgcHVibGljIENvbm5lY3Rpb25FcnJvcjogRXZlbnRFbWl0dGVyPGFueT47XHJcblxyXG4gIHB1YmxpYyBIdWI6IHNpZ25hbFIuSHViQ29ubmVjdGlvbjtcclxuXHJcbiAgcHVibGljIE1heENvbm5lY3Rpb25SZXRyeUF0dGVtcHRzOiBudW1iZXI7XHJcblxyXG4gIHB1YmxpYyBSZWNvbm5lY3Rpb25BdHRlbXB0OiBFdmVudEVtaXR0ZXI8bnVtYmVyPjtcclxuXHJcbiAgcHVibGljIFN0YXJ0ZWQ6IEV2ZW50RW1pdHRlcjxzaWduYWxSLkh1YkNvbm5lY3Rpb24+O1xyXG5cclxuICAvLyAgQ29uc3RydWN0b3JzXHJcbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIGh0dHA6IEh0dHBDbGllbnQsIHJ0VXJsOiBzdHJpbmcsIGFjdGlvblVybDogc3RyaW5nLCBtYXhDb25uZWN0aW9uUmV0cnlBdHRlbXB0czogbnVtYmVyID0gMTApIHtcclxuICAgIHRoaXMuYWN0aW9uVXJsID0gYWN0aW9uVXJsO1xyXG5cclxuICAgIHRoaXMuY29ubmVjdGlvbkF0dGVtcHRzID0gMDtcclxuXHJcbiAgICB0aGlzLnJ0VXJsID0gcnRVcmw7XHJcblxyXG4gICAgdGhpcy5Db25uZWN0aW9uRXJyb3IgPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcclxuXHJcbiAgICB0aGlzLlJlY29ubmVjdGlvbkF0dGVtcHQgPSBuZXcgRXZlbnRFbWl0dGVyPG51bWJlcj4oKTtcclxuXHJcbiAgICB0aGlzLk1heENvbm5lY3Rpb25SZXRyeUF0dGVtcHRzID0gbWF4Q29ubmVjdGlvblJldHJ5QXR0ZW1wdHM7XHJcblxyXG4gICAgdGhpcy5TdGFydGVkID0gbmV3IEV2ZW50RW1pdHRlcjxzaWduYWxSLkh1YkNvbm5lY3Rpb24+KCk7XHJcbiAgfVxyXG5cclxuICAvLyAgQVBJIE1ldGhvZHNcclxuICBwdWJsaWMgU3RhcnQoXHJcbiAgICB0cmFuc3BvcnQ6IHNpZ25hbFIuSHR0cFRyYW5zcG9ydFR5cGUgPSBzaWduYWxSLkh0dHBUcmFuc3BvcnRUeXBlLldlYlNvY2tldHNcclxuICApIHtcclxuICAgIHRoaXMuYnVpbGRIdWIodHJhbnNwb3J0KS50aGVuKChodWI6IHNpZ25hbFIuSHViQ29ubmVjdGlvbikgPT4ge1xyXG4gICAgICB0aGlzLkh1YiA9IGh1YjtcclxuXHJcbiAgICAgIHRoaXMuSHViLnNlcnZlclRpbWVvdXRJbk1pbGxpc2Vjb25kcyA9IDYwMDAwMDtcclxuXHJcbiAgICAgIHRoaXMuSHViLm9uY2xvc2UoZXJyID0+IHtcclxuICAgICAgICBjb25zb2xlLmxvZygnb25jbG9zZTogJyArIGVycik7XHJcblxyXG4gICAgICAgIHRoaXMucmV0cnlDb25uZWN0aW9uKCk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgdHJ5IHtcclxuICAgICAgICB0aGlzLkh1Yi5zdGFydCgpXHJcbiAgICAgICAgICAudGhlbigoKSA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMuY29ubmVjdGlvbkF0dGVtcHRzID0gMDtcclxuXHJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBDb25uZWN0aW9uIHN0YXJ0ZWRgKTtcclxuXHJcbiAgICAgICAgICAgIHRoaXMuU3RhcnRlZC5lbWl0KHRoaXMuSHViKTtcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgICAuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coJ0Vycm9yIHdoaWxlIHN0YXJ0aW5nIGNvbm5lY3Rpb246ICcgKyBlcnIpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5Db25uZWN0aW9uRXJyb3IuZW1pdChlcnIpO1xyXG5cclxuICAgICAgICAgICAgdGhpcy5yZXRyeUNvbm5lY3Rpb24oKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICB9IGNhdGNoIChlcnIpIHtcclxuICAgICAgICBjb25zb2xlLmxvZygnRXJyb3Igd2hpbGUgc3RhcnRpbmcgY29ubmVjdGlvbjogJyArIGVycik7XHJcblxyXG4gICAgICAgIHRoaXMucmV0cnlDb25uZWN0aW9uKCk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIFJlZ2lzdGVySGFuZGxlcihtZXRob2ROYW1lOiBzdHJpbmcpOiBPYnNlcnZhYmxlPGFueT4ge1xyXG4gICAgcmV0dXJuIG5ldyBPYnNlcnZhYmxlKG9icyA9PiB7XHJcbiAgICAgIGlmICh0aGlzLkh1Yikge1xyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICB0aGlzLkh1Yi5vbihtZXRob2ROYW1lLCByZXEgPT4ge1xyXG4gICAgICAgICAgICBvYnMubmV4dChyZXEpO1xyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmxvZyhgRXJyb3Igd2hpbGUgaGFuZGxpbmcgJHttZXRob2ROYW1lfTogYCArIGVycik7XHJcblxyXG4gICAgICAgICAgb2JzLmVycm9yKGVycik7XHJcbiAgICAgICAgfVxyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIG9icy5lcnJvcihcclxuICAgICAgICAgICdUaGUgaHViIG11c3QgYmUgc3RhcnRlZCBhbmQgY29uZmlndXJlZCBiZWZvcmUgcmVnaXN0ZXJpbmcgYSBoYW5kbGVyLidcclxuICAgICAgICApO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBJbnZva2VBY3Rpb24obWV0aG9kTmFtZTogc3RyaW5nLCBoZWFkZXJzOiBIdHRwSGVhZGVycyB8IHsgW2hlYWRlcjogc3RyaW5nXTogc3RyaW5nIHwgc3RyaW5nW107IH0sIGFyZ3M6IHt9KSB7XHJcbiAgICBjb25zdCB1cmwgPSBgJHt0aGlzLmFjdGlvblVybH0vJHttZXRob2ROYW1lfWA7XHJcblxyXG4gICAgcmV0dXJuIHRoaXMuaHR0cC5wb3N0KHVybCwgYXJncywge1xyXG4gICAgICBoZWFkZXJzLFxyXG4gICAgICB3aXRoQ3JlZGVudGlhbHM6IHRydWVcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIEludm9rZShtZXRob2ROYW1lOiBzdHJpbmcsIC4uLmFyZ3M6IGFueVtdKSB7XHJcbiAgICByZXR1cm4gbmV3IE9ic2VydmFibGUob2JzID0+IHtcclxuICAgICAgaWYgKHRoaXMuSHViKSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgIHRoaXMuSHViLmludm9rZShtZXRob2ROYW1lLCAuLi5hcmdzKVxyXG4gICAgICAgICAgICAudGhlbihyZXMgPT4ge1xyXG4gICAgICAgICAgICAgIG9icy5uZXh0KHJlcyk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5jYXRjaChlID0+IHtcclxuICAgICAgICAgICAgICBvYnMuZXJyb3IoZSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xyXG4gICAgICAgICAgY29uc29sZS5sb2coYEVycm9yIHdoaWxlIGludm9raW5nICR7bWV0aG9kTmFtZX06IGAgKyBlcnIpO1xyXG5cclxuICAgICAgICAgIG9icy5lcnJvcihlcnIpO1xyXG4gICAgICAgIH1cclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBvYnMuZXJyb3IoJ1RoZSBodWIgbXVzdCBiZSBzdGFydGVkIGFuZCBjb25maWd1cmVkIGJlZm9yZSBpbnZva2luZy4nKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvLyAgSGVscGVyc1xyXG4gIHByb3RlY3RlZCBhc3luYyBidWlsZEh1Yih0cmFuc3BvcnQ6IHNpZ25hbFIuSHR0cFRyYW5zcG9ydFR5cGUpIHtcclxuICAgIHJldHVybiBuZXcgc2lnbmFsUi5IdWJDb25uZWN0aW9uQnVpbGRlcigpXHJcbiAgICAgIC5jb25maWd1cmVMb2dnaW5nKHNpZ25hbFIuTG9nTGV2ZWwuSW5mb3JtYXRpb24pXHJcbiAgICAgIC53aXRoVXJsKHRoaXMucnRVcmwsIHtcclxuICAgICAgICB0cmFuc3BvcnRcclxuICAgICAgfSlcclxuICAgICAgLmJ1aWxkKCk7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgc3RvcCgpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgIHJldHVybiB0aGlzLkh1Yi5zdG9wKCk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXRyeSBjb25uZWN0aW9uXHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIHJldHJ5Q29ubmVjdGlvbigpOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLmNvbm5lY3Rpb25BdHRlbXB0cyA8IHRoaXMuTWF4Q29ubmVjdGlvblJldHJ5QXR0ZW1wdHMpIHtcclxuICAgICAgY29uc29sZS5sb2coYFJldHJ5aW5nIGNvbm5lY3Rpb24gYXR0ZW1wdCAke3RoaXMuY29ubmVjdGlvbkF0dGVtcHRzfWApO1xyXG5cclxuICAgICAgdGhpcy5jb25uZWN0aW9uQXR0ZW1wdHMgKz0gMTtcclxuXHJcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xyXG4gICAgICAgIHRoaXMucmVjb25uZWN0KCk7XHJcbiAgICAgIH0sIDEwMDApO1xyXG4gICAgfSBlbHNlIGlmICh0aGlzLmNvbm5lY3Rpb25BdHRlbXB0cyA+PSB0aGlzLk1heENvbm5lY3Rpb25SZXRyeUF0dGVtcHRzKSB7XHJcbiAgICAgIHRoaXMuc3RvcCgpLnRoZW4oKTtcclxuXHJcbiAgICAgIHRoaXMuQ29ubmVjdGlvbkVycm9yLmVtaXQoXHJcbiAgICAgICAgJ1RoZSBtYXhpbXVtIG51bWJlciBvZiBjb25uZWN0aW9uIHJldHJpZXMgaGFzIGJlZW4gbWV0LidcclxuICAgICAgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEF0dGVtcHQgdG8gcmVjb25uZWN0XHJcbiAgICovXHJcbiAgcHJvdGVjdGVkIHJlY29ubmVjdCgpOiB2b2lkIHtcclxuICAgIHRoaXMuUmVjb25uZWN0aW9uQXR0ZW1wdC5lbWl0KHRoaXMuY29ubmVjdGlvbkF0dGVtcHRzKTtcclxuXHJcbiAgICB0aGlzLlN0YXJ0KCk7XHJcbiAgfVxyXG59XHJcbiJdfQ==