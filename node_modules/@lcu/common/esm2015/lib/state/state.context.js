import { __awaiter } from "tslib";
import { ObservableContextService } from '../api/observable-context/observable-context.service';
import { Subject, BehaviorSubject, } from 'rxjs';
import { RealTimeConnection } from './../api/real-time/real-time.connection';
import { LCUServiceSettings } from '../api/lcu-service-settings';
import { HttpClient } from '@angular/common/http';
//  TODO:  Need to manage reconnection to hub scenarios here
export class StateContext extends ObservableContextService {
    //  Constructors
    constructor(injector) {
        super();
        this.injector = injector;
        this.connectedToState = new BehaviorSubject({
            Code: -1,
            Message: 'Initialized',
        });
        this.ConnectedToState = this.connectedToState.asObservable();
        this.http = injector.get(HttpClient);
        this.ReconnectionAttempt = new Subject();
        this.Settings = injector.get(LCUServiceSettings);
        const rtUrl = this.buildHubUrl('');
        const actionUrl = this.loadActionUrl('');
        this.rt = new RealTimeConnection(this.http, rtUrl, actionUrl);
        this.rt.ReconnectionAttempt.subscribe((val) => {
            this.ReconnectionAttempt.next(val);
        });
        this.setup();
    }
    //  API Methods
    Execute(action) {
        return this.executeAction(action);
    }
    $Refresh(args = {}) {
        this.Execute({
            Arguments: args,
            Type: 'Refresh',
        });
    }
    Start(shouldUpdate) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.startSub) {
                this.startSub = this.rt.Started.subscribe(() => __awaiter(this, void 0, void 0, function* () {
                    const groupName = yield this.connectToState(shouldUpdate);
                    this.setupReceiveState(groupName);
                    this.connectedToState.next({ Code: 0, Message: 'Success' });
                    this.callRefresh();
                }));
                this.rt.Start();
            }
        });
    }
    //  Helpers
    buildActionUrl(urlRoot) {
        const url = this.loadActionUrl(urlRoot);
        return url;
    }
    buildHubUrl(urlRoot) {
        const url = this.loadHubUrl(urlRoot);
        return url;
    }
    callRefresh() {
        this.$Refresh();
    }
    connectToState(shouldUpdate) {
        return __awaiter(this, void 0, void 0, function* () {
            const stateKey = this.loadStateKey();
            const stateName = this.loadStateName();
            const env = this.loadEnvironment();
            return new Promise((resolve, reject) => {
                this.rt
                    .InvokeAction('ConnectToState', this.loadHeaders(), {
                    ShouldSend: shouldUpdate,
                    Key: stateKey,
                    State: stateName,
                    Environment: env,
                })
                    .subscribe({
                    next: (req) => {
                        if (req.status && req.status.code === 0) {
                            resolve(req.groupName);
                        }
                        else {
                            reject(req.status
                                ? req.status.message
                                : 'Unknown issue connecting to state.');
                        }
                    },
                    error: (err) => reject(err),
                });
            });
        });
    }
    defaultValue() {
        return {};
    }
    executeAction(action) {
        return __awaiter(this, void 0, void 0, function* () {
            const stateKey = this.loadStateKey();
            const stateName = this.loadStateName();
            return this.rt
                .InvokeAction(action.Type, this.loadHeaders(), Object.assign(Object.assign({}, action), { Key: stateKey, State: stateName }))
                .subscribe();
        });
    }
    loadActionPath() {
        const actionRoot = this.loadStateActionRoot();
        return `${actionRoot}`; // ?lcu-app-id=${this.Settings.AppConfig.ID}&lcu-app-ent-api-key=${this.Settings.AppConfig.EnterpriseAPIKey}`;
    }
    loadActionUrl(urlRoot) {
        const apiRoot = this.Settings ? this.Settings.APIRoot || '' : '';
        const actionPath = this.loadActionPath();
        return `${apiRoot}${urlRoot || ''}${actionPath}`;
    }
    loadEnvironment() {
        let env = this.Settings.StateConfig
            ? this.Settings.StateConfig.Environment
            : null;
        if (!env) {
            env = '';
        }
        return env;
    }
    loadHeaders() {
        return {
            'lcu-ent-api-key': this.Settings.AppConfig.EnterpriseAPIKey,
            'lcu-hub-name': this.loadStateName(),
            'lcu-state-key': this.loadStateKey(),
            'lcu-environment': this.loadEnvironment(),
            'lcu-username-mock': this.loadUsernameMock(),
        };
    }
    loadHubPath() {
        const stateRoot = this.loadStateRoot();
        const env = this.loadEnvironment();
        const unmock = this.loadUsernameMock();
        return `${stateRoot}?lcu-app-ent-api-key=${this.Settings.AppConfig.EnterpriseAPIKey}&lcu-environment=${env}&lcu-username-mock=${unmock}`;
    }
    loadHubUrl(urlRoot) {
        const apiRoot = this.Settings ? this.Settings.APIRoot || '' : '';
        const hubPath = this.loadHubPath();
        return `${apiRoot}${urlRoot || ''}${hubPath}`;
    }
    loadStateRoot() {
        const stateRoot = this.Settings.StateConfig && this.Settings.StateConfig.Root !== undefined
            ? this.Settings.StateConfig.Root
            : '';
        return `${stateRoot}/${this.loadStateName()}`;
    }
    loadStateActionRoot() {
        const stateActinRoot = this.Settings.StateConfig &&
            this.Settings.StateConfig.ActionRoot !== undefined
            ? this.Settings.StateConfig.ActionRoot
            : '';
        return `${stateActinRoot}/${this.loadStateName()}`;
    }
    loadUsernameMock() {
        return this.Settings.StateConfig && this.Settings.StateConfig.UsernameMock
            ? this.Settings.StateConfig.UsernameMock
            : '';
    }
    setup() {
        this.Start(false).then();
    }
    setupReceiveState(groupName) {
        this.rt.RegisterHandler(`ReceiveState=>${groupName}`).subscribe((req) => {
            this.subject.next(req);
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGUuY29udGV4dC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BsY3UvY29tbW9uLyIsInNvdXJjZXMiOlsibGliL3N0YXRlL3N0YXRlLmNvbnRleHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLHNEQUFzRCxDQUFDO0FBR2hHLE9BQU8sRUFDTCxPQUFPLEVBR1AsZUFBZSxHQUVoQixNQUFNLE1BQU0sQ0FBQztBQUNkLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHlDQUF5QyxDQUFDO0FBQzdFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQ2pFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUdsRCw0REFBNEQ7QUFFNUQsTUFBTSxPQUFnQixZQUFnQixTQUFRLHdCQUEyQjtJQW1CdkUsZ0JBQWdCO0lBQ2hCLFlBQXNCLFFBQWtCO1FBQ3RDLEtBQUssRUFBRSxDQUFDO1FBRFksYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUd0QyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxlQUFlLENBQWlCO1lBQzFELElBQUksRUFBRSxDQUFDLENBQUM7WUFDUixPQUFPLEVBQUUsYUFBYTtTQUN2QixDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFlBQVksRUFBRSxDQUFDO1FBRTdELElBQUksQ0FBQyxJQUFJLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUVyQyxJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxPQUFPLEVBQVcsQ0FBQztRQUVsRCxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUVqRCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRW5DLE1BQU0s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UUFDM0MsSUFBSSxDQUFDLEVBQUUsQ0FBQyxlQUFlLENBQUMsaUJBQWlCLFNBQVMsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7WUFDdEUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDekIsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBzaWduYWxSIGZyb20gJ0Bhc3BuZXQvc2lnbmFscic7XHJcbmltcG9ydCB7IE9ic2VydmFibGVDb250ZXh0U2VydmljZSB9IGZyb20gJy4uL2FwaS9vYnNlcnZhYmxlLWNvbnRleHQvb2JzZXJ2YWJsZS1jb250ZXh0LnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBTdGF0ZUFjdGlvbiB9IGZyb20gJy4vc3RhdGUtYWN0aW9uLm1vZGVsJztcclxuaW1wb3J0IHsgSW5qZWN0b3IsIEV2ZW50RW1pdHRlciwgT3V0cHV0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7XHJcbiAgU3ViamVjdCxcclxuICBTdWJzY3JpcHRpb24sXHJcbiAgZm9ya0pvaW4sXHJcbiAgQmVoYXZpb3JTdWJqZWN0LFxyXG4gIE9ic2VydmFibGUsXHJcbn0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IFJlYWxUaW1lQ29ubmVjdGlvbiB9IGZyb20gJy4vLi4vYXBpL3JlYWwtdGltZS9yZWFsLXRpbWUuY29ubmVjdGlvbic7XHJcbmltcG9ydCB7IExDVVNlcnZpY2VTZXR0aW5ncyB9IGZyb20gJy4uL2FwaS9sY3Utc2VydmljZS1zZXR0aW5ncyc7XHJcbmltcG9ydCB7IEh0dHBDbGllbnQgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XHJcbmltcG9ydCB7IFN0YXR1cyB9IGZyb20gJy4uL3N0YXR1cyc7XHJcblxyXG4vLyAgVE9ETzogIE5lZWQgdG8gbWFuYWdlIHJlY29ubmVjdGlvbiB0byBodWIgc2NlbmFyaW9zIGhlcmVcclxuXHJcbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBTdGF0ZUNvbnRleHQ8VD4gZXh0ZW5kcyBPYnNlcnZhYmxlQ29udGV4dFNlcnZpY2U8VD4ge1xyXG4gIC8vICBGaWVsZHNcclxuICBwcm90ZWN0ZWQgY29ubmVjdGVkVG9TdGF0ZTogQmVoYXZpb3JTdWJqZWN0PFN0YXR1cz47XHJcblxyXG4gIHByb3RlY3RlZCBncm91cE5hbWU6IHN0cmluZztcclxuXHJcbiAgcHJvdGVjdGVkIGh0dHA6IEh0dHBDbGllbnQ7XHJcblxyXG4gIHByb3RlY3RlZCBydDogUmVhbFRpbWVDb25uZWN0aW9uO1xyXG5cclxuICBwcm90ZWN0ZWQgc3RhcnRTdWI6IFN1YnNjcmlwdGlvbjtcclxuXHJcbiAgLy8gIFByb3BlcnRpZXNcclxuICBwdWJsaWMgQ29ubmVjdGVkVG9TdGF0ZTogT2JzZXJ2YWJsZTxTdGF0dXM+O1xyXG5cclxuICBwdWJsaWMgUmVjb25uZWN0aW9uQXR0ZW1wdDogU3ViamVjdDxib29sZWFuPjtcclxuXHJcbiAgcHVibGljIFNldHRpbmdzOiBMQ1VTZXJ2aWNlU2V0dGluZ3M7XHJcblxyXG4gIC8vICBDb25zdHJ1Y3RvcnNcclxuICBjb25zdHJ1Y3Rvcihwcm90ZWN0ZWQgaW5qZWN0b3I6IEluamVjdG9yKSB7XHJcbiAgICBzdXBlcigpO1xyXG5cclxuICAgIHRoaXMuY29ubmVjdGVkVG9TdGF0ZSA9IG5ldyBCZWhhdmlvclN1YmplY3Q8U3RhdHVzPig8U3RhdHVzPntcclxuICAgICAgQ29kZTogLTEsXHJcbiAgICAgIE1lc3NhZ2U6ICdJbml0aWFsaXplZCcsXHJcbiAgICB9KTtcclxuXHJcbiAgICB0aGlzLkNvbm5lY3RlZFRvU3RhdGUgPSB0aGlzLmNvbm5lY3RlZFRvU3RhdGUuYXNPYnNlcnZhYmxlKCk7XHJcblxyXG4gICAgdGhpcy5odHRwID0gaW5qZWN0b3IuZ2V0KEh0dHBDbGllbnQpO1xyXG5cclxuICAgIHRoaXMuUmVjb25uZWN0aW9uQXR0ZW1wdCA9IG5ldyBTdWJqZWN0PGJvb2xlYW4+KCk7XHJcblxyXG4gICAgdGhpcy5TZXR0aW5ncyA9IGluamVjdG9yLmdldChMQ1VTZXJ2aWNlU2V0dGluZ3MpO1xyXG5cclxuICAgIGNvbnN0IHJ0VXJsID0gdGhpcy5idWlsZEh1YlVybCgnJyk7XHJcblxyXG4gICAgY29uc3QgYWN0aW9uVXJsID0gdGhpcy5sb2FkQWN0aW9uVXJsKCcnKTtcclxuXHJcbiAgICB0aGlzLnJ0ID0gbmV3IFJlYWxUaW1lQ29ubmVjdGlvbih0aGlzLmh0dHAsIHJ0VXJsLCBhY3Rpb25VcmwpO1xyXG5cclxuICAgIHRoaXMucnQuUmVjb25uZWN0aW9uQXR0ZW1wdC5zdWJzY3JpYmUoKHZhbDogYm9vbGVhbikgPT4ge1xyXG4gICAgICB0aGlzLlJlY29ubmVjdGlvbkF0dGVtcHQubmV4dCh2YWwpO1xyXG4gICAgfSk7XHJcblxyXG4gICAgdGhpcy5zZXR1cCgpO1xyXG4gIH1cclxuXHJcbiAgLy8gIEFQSSBNZXRob2RzXHJcbiAgcHVibGljIEV4ZWN1dGUoYWN0aW9uOiBTdGF0ZUFjdGlvbikge1xyXG4gICAgcmV0dXJuIHRoaXMuZXhlY3V0ZUFjdGlvbihhY3Rpb24pO1xyXG4gIH1cclxuXHJcbiAgcHVibGljICRSZWZyZXNoKGFyZ3M6IGFueSA9IHt9KSB7XHJcbiAgICB0aGlzLkV4ZWN1dGUoe1xyXG4gICAgICBBcmd1bWVudHM6IGFyZ3MsXHJcbiAgICAgIFR5cGU6ICdSZWZyZXNoJyxcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGFzeW5jIFN0YXJ0KHNob3VsZFVwZGF0ZTogYm9vbGVhbikge1xyXG4gICAgaWYgKCF0aGlzLnN0YXJ0U3ViKSB7XHJcbiAgICAgIHRoaXMuc3RhcnRTdWIgPSB0aGlzLnJ0LlN0YXJ0ZWQuc3Vic2NyaWJlKGFzeW5jICgpID0+IHtcclxuICAgICAgICBjb25zdCBncm91cE5hbWUgPSBhd2FpdCB0aGlzLmNvbm5lY3RUb1N0YXRlKHNob3VsZFVwZGF0ZSk7XHJcblxyXG4gICAgICAgIHRoaXMuc2V0dXBSZWNlaXZlU3RhdGUoZ3JvdXBOYW1lKTtcclxuXHJcbiAgICAgICAgdGhpcy5jb25uZWN0ZWRUb1N0YXRlLm5leHQoPFN0YXR1cz57IENvZGU6IDAsIE1lc3NhZ2U6ICdTdWNjZXNzJyB9KTtcclxuXHJcbiAgICAgICAgdGhpcy5jYWxsUmVmcmVzaCgpO1xyXG4gICAgICB9KTtcclxuXHJcbiAgICAgIHRoaXMucnQuU3RhcnQoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vICBIZWxwZXJzXHJcbiAgcHJvdGVjdGVkIGJ1aWxkQWN0aW9uVXJsKHVybFJvb3Q6IHN0cmluZykge1xyXG4gICAgY29uc3QgdXJsID0gdGhpcy5sb2FkQWN0aW9uVXJsKHVybFJvb3QpO1xyXG5cclxuICAgIHJldHVybiB1cmw7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgYnVpbGRIdWJVcmwodXJsUm9vdDogc3RyaW5nKSB7XHJcbiAgICBjb25zdCB1cmwgPSB0aGlzLmxvYWRIdWJVcmwodXJsUm9vdCk7XHJcblxyXG4gICAgcmV0dXJuIHVybDtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBjYWxsUmVmcmVzaCgpIHtcclxuICAgIHRoaXMuJFJlZnJlc2goKTtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBhc3luYyBjb25uZWN0VG9TdGF0ZShzaG91bGRVcGRhdGU6IGJvb2xlYW4pOiBQcm9taXNlPHN0cmluZz4ge1xyXG4gICAgY29uc3Qgc3RhdGVLZXkgPSB0aGlzLmxvYWRTdGF0ZUtleSgpO1xyXG5cclxuICAgIGNvbnN0IHN0YXRlTmFtZSA9IHRoaXMubG9hZFN0YXRlTmFtZSgpO1xyXG5cclxuICAgIGNvbnN0IGVudiA9IHRoaXMubG9hZEVudmlyb25tZW50KCk7XHJcblxyXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPHN0cmluZz4oKHJlc29sdmUsIHJlamVjdCkgPT4ge1xyXG4gICAgICB0aGlzLnJ0XHJcbiAgICAgICAgLkludm9rZUFjdGlvbignQ29ubmVjdFRvU3RhdGUnLCB0aGlzLmxvYWRIZWFkZXJzKCksIHtcclxuICAgICAgICAgIFNob3VsZFNlbmQ6IHNob3VsZFVwZGF0ZSxcclxuICAgICAgICAgIEtleTogc3RhdGVLZXksXHJcbiAgICAgICAgICBTdGF0ZTogc3RhdGVOYW1lLFxyXG4gICAgICAgICAgRW52aXJvbm1lbnQ6IGVudixcclxuICAgICAgICB9KVxyXG4gICAgICAgIC5zdWJzY3JpYmUoe1xyXG4gICAgICAgICAgbmV4dDogKHJlcTogYW55KSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChyZXEuc3RhdHVzICYmIHJlcS5zdGF0dXMuY29kZSA9PT0gMCkge1xyXG4gICAgICAgICAgICAgIHJlc29sdmUocmVxLmdyb3VwTmFtZSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgcmVqZWN0KFxyXG4gICAgICAgICAgICAgICAgcmVxLnN0YXR1c1xyXG4gICAgICAgICAgICAgICAgICA/IHJlcS5zdGF0dXMubWVzc2FnZVxyXG4gICAgICAgICAgICAgICAgICA6ICdVbmtub3duIGlzc3VlIGNvbm5lY3RpbmcgdG8gc3RhdGUuJ1xyXG4gICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgICBlcnJvcjogKGVycikgPT4gcmVqZWN0KGVyciksXHJcbiAgICAgICAgICAvLyBjb21wbGV0ZTogKCkgPT4gY29uc29sZS5sb2coJ09ic2VydmVyIGdvdCBhIGNvbXBsZXRlIG5vdGlmaWNhdGlvbicpLFxyXG4gICAgICAgIH0pO1xyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgZGVmYXVsdFZhbHVlKCk6IFQge1xyXG4gICAgcmV0dXJuIDxUPnt9O1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGFzeW5jIGV4ZWN1dGVBY3Rpb24oYWN0aW9uOiBTdGF0ZUFjdGlvbikge1xyXG4gICAgY29uc3Qgc3RhdGVLZXkgPSB0aGlzLmxvYWRTdGF0ZUtleSgpO1xyXG5cclxuICAgIGNvbnN0IHN0YXRlTmFtZSA9IHRoaXMubG9hZFN0YXRlTmFtZSgpO1xyXG5cclxuICAgIHJldHVybiB0aGlzLnJ0XHJcbiAgICAgIC5JbnZva2VBY3Rpb24oYWN0aW9uLlR5cGUsIHRoaXMubG9hZEhlYWRlcnMoKSwge1xyXG4gICAgICAgIC4uLmFjdGlvbixcclxuICAgICAgICBLZXk6IHN0YXRlS2V5LFxyXG4gICAgICAgIFN0YXRlOiBzdGF0ZU5hbWUsXHJcbiAgICAgIH0pXHJcbiAgICAgIC5zdWJzY3JpYmUoKTtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBsb2FkQWN0aW9uUGF0aCgpIHtcclxuICAgIGNvbnN0IGFjdGlvblJvb3QgPSB0aGlzLmxvYWRTdGF0ZUFjdGlvblJvb3QoKTtcclxuXHJcbiAgICByZXR1cm4gYCR7YWN0aW9uUm9vdH1gOyAvLyA/bGN1LWFwcC1pZD0ke3RoaXMuU2V0dGluZ3MuQXBwQ29uZmlnLklEfSZsY3UtYXBwLWVudC1hcGkta2V5PSR7dGhpcy5TZXR0aW5ncy5BcHBDb25maWcuRW50ZXJwcmlzZUFQSUtleX1gO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGxvYWRBY3Rpb25VcmwodXJsUm9vdDogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBhcGlSb290ID0gdGhpcy5TZXR0aW5ncyA/IHRoaXMuU2V0dGluZ3MuQVBJUm9vdCB8fCAnJyA6ICcnO1xyXG5cclxuICAgIGNvbnN0IGFjdGlvblBhdGggPSB0aGlzLmxvYWRBY3Rpb25QYXRoKCk7XHJcblxyXG4gICAgcmV0dXJuIGAke2FwaVJvb3R9JHt1cmxSb290IHx8ICcnfSR7YWN0aW9uUGF0aH1gO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGxvYWRFbnZpcm9ubWVudCgpIHtcclxuICAgIGxldCBlbnYgPSB0aGlzLlNldHRpbmdzLlN0YXRlQ29uZmlnXHJcbiAgICAgID8gdGhpcy5TZXR0aW5ncy5TdGF0ZUNvbmZpZy5FbnZpcm9ubWVudFxyXG4gICAgICA6IG51bGw7XHJcblxyXG4gICAgaWYgKCFlbnYpIHtcclxuICAgICAgZW52ID0gJyc7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGVudjtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBsb2FkSGVhZGVycygpOiB7IFtoZWFkZXI6IHN0cmluZ106IHN0cmluZyB8IHN0cmluZ1tdIH0ge1xyXG4gICAgcmV0dXJuIHtcclxuICAgICAgJ2xjdS1lbnQtYXBpLWtleSc6IHRoaXMuU2V0dGluZ3MuQXBwQ29uZmlnLkVudGVycHJpc2VBUElLZXksXHJcbiAgICAgICdsY3UtaHViLW5hbWUnOiB0aGlzLmxvYWRTdGF0ZU5hbWUoKSxcclxuICAgICAgJ2xjdS1zdGF0ZS1rZXknOiB0aGlzLmxvYWRTdGF0ZUtleSgpLFxyXG4gICAgICAnbGN1LWVudmlyb25tZW50JzogdGhpcy5sb2FkRW52aXJvbm1lbnQoKSxcclxuICAgICAgJ2xjdS11c2VybmFtZS1tb2NrJzogdGhpcy5sb2FkVXNlcm5hbWVNb2NrKCksXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGxvYWRIdWJQYXRoKCkge1xyXG4gICAgY29uc3Qgc3RhdGVSb290ID0gdGhpcy5sb2FkU3RhdGVSb290KCk7XHJcblxyXG4gICAgY29uc3QgZW52ID0gdGhpcy5sb2FkRW52aXJvbm1lbnQoKTtcclxuXHJcbiAgICBjb25zdCB1bm1vY2sgPSB0aGlzLmxvYWRVc2VybmFtZU1vY2soKTtcclxuXHJcbiAgICByZXR1cm4gYCR7c3RhdGVSb290fT9sY3UtYXBwLWVudC1hcGkta2V5PSR7dGhpcy5TZXR0aW5ncy5BcHBDb25maWcuRW50ZXJwcmlzZUFQSUtleX0mbGN1LWVudmlyb25tZW50PSR7ZW52fSZsY3UtdXNlcm5hbWUtbW9jaz0ke3VubW9ja31gO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGxvYWRIdWJVcmwodXJsUm9vdDogc3RyaW5nKSB7XHJcbiAgICBjb25zdCBhcGlSb290ID0gdGhpcy5TZXR0aW5ncyA/IHRoaXMuU2V0dGluZ3MuQVBJUm9vdCB8fCAnJyA6ICcnO1xyXG5cclxuICAgIGNvbnN0IGh1YlBhdGggPSB0aGlzLmxvYWRIdWJQYXRoKCk7XHJcblxyXG4gICAgcmV0dXJuIGAke2FwaVJvb3R9JHt1cmxSb290IHx8ICcnfSR7aHViUGF0aH1gO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGxvYWRTdGF0ZUtleSgpOiBzdHJpbmc7XHJcblxyXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBsb2FkU3RhdGVOYW1lKCk6IHN0cmluZztcclxuXHJcbiAgcHJvdGVjdGVkIGxvYWRTdGF0ZVJvb3QoKSB7XHJcbiAgICBjb25zdCBzdGF0ZVJvb3QgPVxyXG4gICAgICB0aGlzLlNldHRpbmdzLlN0YXRlQ29uZmlnICYmIHRoaXMuU2V0dGluZ3MuU3RhdGVDb25maWcuUm9vdCAhPT0gdW5kZWZpbmVkXHJcbiAgICAgICAgPyB0aGlzLlNldHRpbmdzLlN0YXRlQ29uZmlnLlJvb3RcclxuICAgICAgICA6ICcnO1xyXG5cclxuICAgIHJldHVybiBgJHtzdGF0ZVJvb3R9LyR7dGhpcy5sb2FkU3RhdGVOYW1lKCl9YDtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBsb2FkU3RhdGVBY3Rpb25Sb290KCkge1xyXG4gICAgY29uc3Qgc3RhdGVBY3RpblJvb3QgPVxyXG4gICAgICB0aGlzLlNldHRpbmdzLlN0YXRlQ29uZmlnICYmXHJcbiAgICAgIHRoaXMuU2V0dGluZ3MuU3RhdGVDb25maWcuQWN0aW9uUm9vdCAhPT0gdW5kZWZpbmVkXHJcbiAgICAgICAgPyB0aGlzLlNldHRpbmdzLlN0YXRlQ29uZmlnLkFjdGlvblJvb3RcclxuICAgICAgICA6ICcnO1xyXG5cclxuICAgIHJldHVybiBgJHtzdGF0ZUFjdGluUm9vdH0vJHt0aGlzLmxvYWRTdGF0ZU5hbWUoKX1gO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGxvYWRVc2VybmFtZU1vY2soKSB7XHJcbiAgICByZXR1cm4gdGhpcy5TZXR0aW5ncy5TdGF0ZUNvbmZpZyAmJiB0aGlzLlNldHRpbmdzLlN0YXRlQ29uZmlnLlVzZXJuYW1lTW9ja1xyXG4gICAgICA/IHRoaXMuU2V0dGluZ3MuU3RhdGVDb25maWcuVXNlcm5hbWVNb2NrXHJcbiAgICAgIDogJyc7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgc2V0dXAoKSB7XHJcbiAgICB0aGlzLlN0YXJ0KGZhbHNlKS50aGVuKCk7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgc2V0dXBSZWNlaXZlU3RhdGUoZ3JvdXBOYW1lOiBzdHJpbmcpIHtcclxuICAgIHRoaXMucnQuUmVnaXN0ZXJIYW5kbGVyKGBSZWNlaXZlU3RhdGU9PiR7Z3JvdXBOYW1lfWApLnN1YnNjcmliZSgocmVxKSA9PiB7XHJcbiAgICAgIHRoaXMuc3ViamVjdC5uZXh0KHJlcSk7XHJcbiAgICB9KTtcclxuICB9XHJcbn1cclxuIl19