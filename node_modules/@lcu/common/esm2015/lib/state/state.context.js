import { __awaiter } from "tslib";
import { ObservableContextService } from '../api/observable-context/observable-context.service';
import { Subject, BehaviorSubject, } from 'rxjs';
import { RealTimeConnection } from './../api/real-time/real-time.connection';
import { LCUServiceSettings } from '../api/lcu-service-settings';
import { HttpClient } from '@angular/common/http';
//  TODO:  Need to manage reconnection to hub scenarios here
export class StateContext extends ObservableContextService {
    //  Constructors
    constructor(injector) {
        super();
        this.injector = injector;
        this.connectedToState = new BehaviorSubject({
            Code: -1,
            Message: 'Initialized',
        });
        this.ConnectedToState = this.connectedToState.asObservable();
        this.http = injector.get(HttpClient);
        this.ReconnectionAttempt = new Subject();
        this.Settings = injector.get(LCUServiceSettings);
        const rtUrl = this.buildHubUrl('');
        const actionUrl = this.loadActionUrl('');
        this.rt = new RealTimeConnection(this.http, rtUrl, actionUrl);
        this.rt.ReconnectionAttempt.subscribe((val) => {
            this.ReconnectionAttempt.next(val);
        });
        this.setup();
    }
    //  API Methods
    Execute(action) {
        return this.executeAction(action);
    }
    $Refresh(args = {}) {
        this.Execute({
            Arguments: args,
            Type: 'Refresh',
        });
    }
    Start(shouldUpdate) {
        return __awaiter(this, void 0, void 0, function* () {
            if (!this.startSub) {
                this.startSub = this.rt.Started.subscribe(() => __awaiter(this, void 0, void 0, function* () {
                    const groupName = yield this.connectToState(shouldUpdate);
                    this.setupReceiveState(groupName);
                    this.connectedToState.next({ Code: 0, Message: 'Success' });
                    this.callRefresh();
                }));
                this.rt.Start();
            }
        });
    }
    //  Helpers
    buildActionUrl(urlRoot) {
        const url = this.loadActionUrl(urlRoot);
        return url;
    }
    buildHubUrl(urlRoot) {
        const url = this.loadHubUrl(urlRoot);
        return url;
    }
    callRefresh() {
        this.$Refresh();
    }
    connectToState(shouldUpdate) {
        return __awaiter(this, void 0, void 0, function* () {
            const stateKey = this.loadStateKey();
            const stateName = this.loadStateName();
            const env = this.loadEnvironment();
            return new Promise((resolve, reject) => {
                this.rt
                    .InvokeAction('ConnectToState', this.loadHeaders(), {
                    ShouldSend: shouldUpdate,
                    Key: stateKey,
                    State: stateName,
                    Environment: env,
                })
                    .subscribe({
                    next: (req) => {
                        if (req.status && req.status.code === 0) {
                            resolve(req.groupName);
                        }
                        else {
                            reject(req.status
                                ? req.status.message
                                : 'Unknown issue connecting to state.');
                        }
                    },
                    error: (err) => reject(err),
                });
            });
        });
    }
    defaultValue() {
        return {};
    }
    executeAction(action) {
        return __awaiter(this, void 0, void 0, function* () {
            const stateKey = this.loadStateKey();
            const stateName = this.loadStateName();
            return this.rt
                .InvokeAction(action.Type, this.loadHeaders(), Object.assign(Object.assign({}, action), { Key: stateKey, State: stateName }))
                .subscribe();
        });
    }
    loadActionPath() {
        const actionRoot = this.loadStateActionRoot();
        return `${actionRoot}`; // ?lcu-app-id=${this.Settings.AppConfig.ID}&lcu-app-ent-api-key=${this.Settings.AppConfig.EnterpriseAPIKey}`;
    }
    loadActionUrl(urlRoot) {
        const apiRoot = this.Settings ? this.Settings.APIRoot || '' : '';
        const actionPath = this.loadActionPath();
        return `${apiRoot}${urlRoot || ''}${actionPath}`;
    }
    loadEnvironment() {
        let env = this.Settings.StateConfig
            ? this.Settings.StateConfig.Environment
            : null;
        if (!env) {
            env = '';
        }
        return env;
    }
    loadHeaders() {
        return {
            'lcu-ent-api-key': this.Settings.AppConfig.EnterpriseAPIKey,
            'lcu-hub-name': this.loadStateName(),
            'lcu-state-key': this.loadStateKey(),
            'lcu-environment': this.loadEnvironment(),
            'lcu-username-mock': this.loadUsernameMock(),
        };
    }
    loadHubPath() {
        const stateRoot = this.loadStateRoot();
        const env = this.loadEnvironment();
        const unmock = this.loadUsernameMock();
        return `${stateRoot}?lcu-app-ent-api-key=${this.Settings.AppConfig.EnterpriseAPIKey}&lcu-environment=${env}&lcu-username-mock=${unmock}`;
    }
    loadHubUrl(urlRoot) {
        const apiRoot = this.Settings ? this.Settings.APIRoot || '' : '';
        const hubPath = this.loadHubPath();
        return `${apiRoot}${urlRoot || ''}${hubPath}`;
    }
    loadStateRoot() {
        const stateRoot = this.Settings.StateConfig && this.Settings.StateConfig.Root !== undefined
            ? this.Settings.StateConfig.Root
            : '';
        return `${stateRoot}/${this.loadStateName()}`;
    }
    loadStateActionRoot() {
        const stateActinRoot = this.Settings.StateConfig &&
            this.Settings.StateConfig.ActionRoot !== undefined
            ? this.Settings.StateConfig.ActionRoot
            : '';
        return `${stateActinRoot}/${this.loadStateName()}`;
    }
    loadUsernameMock() {
        return this.Settings.StateConfig && this.Settings.StateConfig.UsernameMock
            ? this.Settings.StateConfig.UsernameMock
            : '';
    }
    setup() {
        this.Start(false).then();
    }
    setupReceiveState(groupName) {
        this.rt.RegisterHandler(`ReceiveState=>${groupName}`).subscribe((req) => {
            console.log(`Handled state from ${groupName}`);
            this.subject.next(req);
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhdGUuY29udGV4dC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0BsY3UvY29tbW9uLyIsInNvdXJjZXMiOlsibGliL3N0YXRlL3N0YXRlLmNvbnRleHQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLHNEQUFzRCxDQUFDO0FBR2hHLE9BQU8sRUFDTCxPQUFPLEVBR1AsZUFBZSxHQUVoQixNQUFNLE1BQU0sQ0FBQztBQUNkLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHlDQUF5QyxDQUFDO0FBQzdFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQ2pFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUdsRCw0REFBNEQ7QUFFNUQsTUFBTSxPQUFnQixZQUFnQixTQUFRLHdCQUEyQjtJQW1CdkUsZ0JBQWdCO0lBQ2hCLFlBQXNCLFFBQWtCO1FBQ3RDLEtBQUssRUFBRSxDQUFDO1FBRFksYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUd0QyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxlQUFlLENBQWlCO1lBQzFELElBQUksRUFBRSxDQUFDLENBQUM7WUFDUixPQUFPLEVBQUUsYUFBYTtTQUN2QixDQUFDLENBQUM7UUFFSCxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFlBQVksRUFBRSxDQUFDO1FBRTdELElBQUksQ0FBQyxJQUFJLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUVyQyxJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxPQUFPLEVBQVcsQ0FBQztRQUVsRCxJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUVqRCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRW5DLE1BQU0s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UUFDM0MsSUFBSSxDQUFDLEVBQUUsQ0FBQyxlQUFlLENBQUMsaUJBQWlCLFNBQVMsRUFBRSxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7WUFDdEUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxzQkFBc0IsU0FBUyxFQUFFLENBQUMsQ0FBQztZQUUvQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN6QixDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIHNpZ25hbFIgZnJvbSAnQGFzcG5ldC9zaWduYWxyJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZUNvbnRleHRTZXJ2aWNlIH0gZnJvbSAnLi4vYXBpL29ic2VydmFibGUtY29udGV4dC9vYnNlcnZhYmxlLWNvbnRleHQuc2VydmljZSc7XHJcbmltcG9ydCB7IFN0YXRlQWN0aW9uIH0gZnJvbSAnLi9zdGF0ZS1hY3Rpb24ubW9kZWwnO1xyXG5pbXBvcnQgeyBJbmplY3RvciwgRXZlbnRFbWl0dGVyLCBPdXRwdXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHtcclxuICBTdWJqZWN0LFxyXG4gIFN1YnNjcmlwdGlvbixcclxuICBmb3JrSm9pbixcclxuICBCZWhhdmlvclN1YmplY3QsXHJcbiAgT2JzZXJ2YWJsZSxcclxufSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgUmVhbFRpbWVDb25uZWN0aW9uIH0gZnJvbSAnLi8uLi9hcGkvcmVhbC10aW1lL3JlYWwtdGltZS5jb25uZWN0aW9uJztcclxuaW1wb3J0IHsgTENVU2VydmljZVNldHRpbmdzIH0gZnJvbSAnLi4vYXBpL2xjdS1zZXJ2aWNlLXNldHRpbmdzJztcclxuaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcclxuaW1wb3J0IHsgU3RhdHVzIH0gZnJvbSAnLi4vc3RhdHVzJztcclxuXHJcbi8vICBUT0RPOiAgTmVlZCB0byBtYW5hZ2UgcmVjb25uZWN0aW9uIHRvIGh1YiBzY2VuYXJpb3MgaGVyZVxyXG5cclxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFN0YXRlQ29udGV4dDxUPiBleHRlbmRzIE9ic2VydmFibGVDb250ZXh0U2VydmljZTxUPiB7XHJcbiAgLy8gIEZpZWxkc1xyXG4gIHByb3RlY3RlZCBjb25uZWN0ZWRUb1N0YXRlOiBCZWhhdmlvclN1YmplY3Q8U3RhdHVzPjtcclxuXHJcbiAgcHJvdGVjdGVkIGdyb3VwTmFtZTogc3RyaW5nO1xyXG5cclxuICBwcm90ZWN0ZWQgaHR0cDogSHR0cENsaWVudDtcclxuXHJcbiAgcHJvdGVjdGVkIHJ0OiBSZWFsVGltZUNvbm5lY3Rpb247XHJcblxyXG4gIHByb3RlY3RlZCBzdGFydFN1YjogU3Vic2NyaXB0aW9uO1xyXG5cclxuICAvLyAgUHJvcGVydGllc1xyXG4gIHB1YmxpYyBDb25uZWN0ZWRUb1N0YXRlOiBPYnNlcnZhYmxlPFN0YXR1cz47XHJcblxyXG4gIHB1YmxpYyBSZWNvbm5lY3Rpb25BdHRlbXB0OiBTdWJqZWN0PGJvb2xlYW4+O1xyXG5cclxuICBwdWJsaWMgU2V0dGluZ3M6IExDVVNlcnZpY2VTZXR0aW5ncztcclxuXHJcbiAgLy8gIENvbnN0cnVjdG9yc1xyXG4gIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBpbmplY3RvcjogSW5qZWN0b3IpIHtcclxuICAgIHN1cGVyKCk7XHJcblxyXG4gICAgdGhpcy5jb25uZWN0ZWRUb1N0YXRlID0gbmV3IEJlaGF2aW9yU3ViamVjdDxTdGF0dXM+KDxTdGF0dXM+e1xyXG4gICAgICBDb2RlOiAtMSxcclxuICAgICAgTWVzc2FnZTogJ0luaXRpYWxpemVkJyxcclxuICAgIH0pO1xyXG5cclxuICAgIHRoaXMuQ29ubmVjdGVkVG9TdGF0ZSA9IHRoaXMuY29ubmVjdGVkVG9TdGF0ZS5hc09ic2VydmFibGUoKTtcclxuXHJcbiAgICB0aGlzLmh0dHAgPSBpbmplY3Rvci5nZXQoSHR0cENsaWVudCk7XHJcblxyXG4gICAgdGhpcy5SZWNvbm5lY3Rpb25BdHRlbXB0ID0gbmV3IFN1YmplY3Q8Ym9vbGVhbj4oKTtcclxuXHJcbiAgICB0aGlzLlNldHRpbmdzID0gaW5qZWN0b3IuZ2V0KExDVVNlcnZpY2VTZXR0aW5ncyk7XHJcblxyXG4gICAgY29uc3QgcnRVcmwgPSB0aGlzLmJ1aWxkSHViVXJsKCcnKTtcclxuXHJcbiAgICBjb25zdCBhY3Rpb25VcmwgPSB0aGlzLmxvYWRBY3Rpb25VcmwoJycpO1xyXG5cclxuICAgIHRoaXMucnQgPSBuZXcgUmVhbFRpbWVDb25uZWN0aW9uKHRoaXMuaHR0cCwgcnRVcmwsIGFjdGlvblVybCk7XHJcblxyXG4gICAgdGhpcy5ydC5SZWNvbm5lY3Rpb25BdHRlbXB0LnN1YnNjcmliZSgodmFsOiBib29sZWFuKSA9PiB7XHJcbiAgICAgIHRoaXMuUmVjb25uZWN0aW9uQXR0ZW1wdC5uZXh0KHZhbCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICB0aGlzLnNldHVwKCk7XHJcbiAgfVxyXG5cclxuICAvLyAgQVBJIE1ldGhvZHNcclxuICBwdWJsaWMgRXhlY3V0ZShhY3Rpb246IFN0YXRlQWN0aW9uKSB7XHJcbiAgICByZXR1cm4gdGhpcy5leGVjdXRlQWN0aW9uKGFjdGlvbik7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgJFJlZnJlc2goYXJnczogYW55ID0ge30pIHtcclxuICAgIHRoaXMuRXhlY3V0ZSh7XHJcbiAgICAgIEFyZ3VtZW50czogYXJncyxcclxuICAgICAgVHlwZTogJ1JlZnJlc2gnLFxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgYXN5bmMgU3RhcnQoc2hvdWxkVXBkYXRlOiBib29sZWFuKSB7XHJcbiAgICBpZiAoIXRoaXMuc3RhcnRTdWIpIHtcclxuICAgICAgdGhpcy5zdGFydFN1YiA9IHRoaXMucnQuU3RhcnRlZC5zdWJzY3JpYmUoYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IGdyb3VwTmFtZSA9IGF3YWl0IHRoaXMuY29ubmVjdFRvU3RhdGUoc2hvdWxkVXBkYXRlKTtcclxuXHJcbiAgICAgICAgdGhpcy5zZXR1cFJlY2VpdmVTdGF0ZShncm91cE5hbWUpO1xyXG5cclxuICAgICAgICB0aGlzLmNvbm5lY3RlZFRvU3RhdGUubmV4dCg8U3RhdHVzPnsgQ29kZTogMCwgTWVzc2FnZTogJ1N1Y2Nlc3MnIH0pO1xyXG5cclxuICAgICAgICB0aGlzLmNhbGxSZWZyZXNoKCk7XHJcbiAgICAgIH0pO1xyXG5cclxuICAgICAgdGhpcy5ydC5TdGFydCgpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLy8gIEhlbHBlcnNcclxuICBwcm90ZWN0ZWQgYnVpbGRBY3Rpb25VcmwodXJsUm9vdDogc3RyaW5nKSB7XHJcbiAgICBjb25zdCB1cmwgPSB0aGlzLmxvYWRBY3Rpb25VcmwodXJsUm9vdCk7XHJcblxyXG4gICAgcmV0dXJuIHVybDtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBidWlsZEh1YlVybCh1cmxSb290OiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHVybCA9IHRoaXMubG9hZEh1YlVybCh1cmxSb290KTtcclxuXHJcbiAgICByZXR1cm4gdXJsO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGNhbGxSZWZyZXNoKCkge1xyXG4gICAgdGhpcy4kUmVmcmVzaCgpO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGFzeW5jIGNvbm5lY3RUb1N0YXRlKHNob3VsZFVwZGF0ZTogYm9vbGVhbik6IFByb21pc2U8c3RyaW5nPiB7XHJcbiAgICBjb25zdCBzdGF0ZUtleSA9IHRoaXMubG9hZFN0YXRlS2V5KCk7XHJcblxyXG4gICAgY29uc3Qgc3RhdGVOYW1lID0gdGhpcy5sb2FkU3RhdGVOYW1lKCk7XHJcblxyXG4gICAgY29uc3QgZW52ID0gdGhpcy5sb2FkRW52aXJvbm1lbnQoKTtcclxuXHJcbiAgICByZXR1cm4gbmV3IFByb21pc2U8c3RyaW5nPigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XHJcbiAgICAgIHRoaXMucnRcclxuICAgICAgICAuSW52b2tlQWN0aW9uKCdDb25uZWN0VG9TdGF0ZScsIHRoaXMubG9hZEhlYWRlcnMoKSwge1xyXG4gICAgICAgICAgU2hvdWxkU2VuZDogc2hvdWxkVXBkYXRlLFxyXG4gICAgICAgICAgS2V5OiBzdGF0ZUtleSxcclxuICAgICAgICAgIFN0YXRlOiBzdGF0ZU5hbWUsXHJcbiAgICAgICAgICBFbnZpcm9ubWVudDogZW52LFxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgLnN1YnNjcmliZSh7XHJcbiAgICAgICAgICBuZXh0OiAocmVxOiBhbnkpID0+IHtcclxuICAgICAgICAgICAgaWYgKHJlcS5zdGF0dXMgJiYgcmVxLnN0YXR1cy5jb2RlID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgcmVzb2x2ZShyZXEuZ3JvdXBOYW1lKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICByZWplY3QoXHJcbiAgICAgICAgICAgICAgICByZXEuc3RhdHVzXHJcbiAgICAgICAgICAgICAgICAgID8gcmVxLnN0YXR1cy5tZXNzYWdlXHJcbiAgICAgICAgICAgICAgICAgIDogJ1Vua25vd24gaXNzdWUgY29ubmVjdGluZyB0byBzdGF0ZS4nXHJcbiAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSxcclxuICAgICAgICAgIGVycm9yOiAoZXJyKSA9PiByZWplY3QoZXJyKSxcclxuICAgICAgICAgIC8vIGNvbXBsZXRlOiAoKSA9PiBjb25zb2xlLmxvZygnT2JzZXJ2ZXIgZ290IGEgY29tcGxldGUgbm90aWZpY2F0aW9uJyksXHJcbiAgICAgICAgfSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBkZWZhdWx0VmFsdWUoKTogVCB7XHJcbiAgICByZXR1cm4gPFQ+e307XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgYXN5bmMgZXhlY3V0ZUFjdGlvbihhY3Rpb246IFN0YXRlQWN0aW9uKSB7XHJcbiAgICBjb25zdCBzdGF0ZUtleSA9IHRoaXMubG9hZFN0YXRlS2V5KCk7XHJcblxyXG4gICAgY29uc3Qgc3RhdGVOYW1lID0gdGhpcy5sb2FkU3RhdGVOYW1lKCk7XHJcblxyXG4gICAgcmV0dXJuIHRoaXMucnRcclxuICAgICAgLkludm9rZUFjdGlvbihhY3Rpb24uVHlwZSwgdGhpcy5sb2FkSGVhZGVycygpLCB7XHJcbiAgICAgICAgLi4uYWN0aW9uLFxyXG4gICAgICAgIEtleTogc3RhdGVLZXksXHJcbiAgICAgICAgU3RhdGU6IHN0YXRlTmFtZSxcclxuICAgICAgfSlcclxuICAgICAgLnN1YnNjcmliZSgpO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGxvYWRBY3Rpb25QYXRoKCkge1xyXG4gICAgY29uc3QgYWN0aW9uUm9vdCA9IHRoaXMubG9hZFN0YXRlQWN0aW9uUm9vdCgpO1xyXG5cclxuICAgIHJldHVybiBgJHthY3Rpb25Sb290fWA7IC8vID9sY3UtYXBwLWlkPSR7dGhpcy5TZXR0aW5ncy5BcHBDb25maWcuSUR9JmxjdS1hcHAtZW50LWFwaS1rZXk9JHt0aGlzLlNldHRpbmdzLkFwcENvbmZpZy5FbnRlcnByaXNlQVBJS2V5fWA7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgbG9hZEFjdGlvblVybCh1cmxSb290OiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IGFwaVJvb3QgPSB0aGlzLlNldHRpbmdzID8gdGhpcy5TZXR0aW5ncy5BUElSb290IHx8ICcnIDogJyc7XHJcblxyXG4gICAgY29uc3QgYWN0aW9uUGF0aCA9IHRoaXMubG9hZEFjdGlvblBhdGgoKTtcclxuXHJcbiAgICByZXR1cm4gYCR7YXBpUm9vdH0ke3VybFJvb3QgfHwgJyd9JHthY3Rpb25QYXRofWA7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgbG9hZEVudmlyb25tZW50KCkge1xyXG4gICAgbGV0IGVudiA9IHRoaXMuU2V0dGluZ3MuU3RhdGVDb25maWdcclxuICAgICAgPyB0aGlzLlNldHRpbmdzLlN0YXRlQ29uZmlnLkVudmlyb25tZW50XHJcbiAgICAgIDogbnVsbDtcclxuXHJcbiAgICBpZiAoIWVudikge1xyXG4gICAgICBlbnYgPSAnJztcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gZW52O1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGxvYWRIZWFkZXJzKCk6IHsgW2hlYWRlcjogc3RyaW5nXTogc3RyaW5nIHwgc3RyaW5nW10gfSB7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICAnbGN1LWVudC1hcGkta2V5JzogdGhpcy5TZXR0aW5ncy5BcHBDb25maWcuRW50ZXJwcmlzZUFQSUtleSxcclxuICAgICAgJ2xjdS1odWItbmFtZSc6IHRoaXMubG9hZFN0YXRlTmFtZSgpLFxyXG4gICAgICAnbGN1LXN0YXRlLWtleSc6IHRoaXMubG9hZFN0YXRlS2V5KCksXHJcbiAgICAgICdsY3UtZW52aXJvbm1lbnQnOiB0aGlzLmxvYWRFbnZpcm9ubWVudCgpLFxyXG4gICAgICAnbGN1LXVzZXJuYW1lLW1vY2snOiB0aGlzLmxvYWRVc2VybmFtZU1vY2soKSxcclxuICAgIH07XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgbG9hZEh1YlBhdGgoKSB7XHJcbiAgICBjb25zdCBzdGF0ZVJvb3QgPSB0aGlzLmxvYWRTdGF0ZVJvb3QoKTtcclxuXHJcbiAgICBjb25zdCBlbnYgPSB0aGlzLmxvYWRFbnZpcm9ubWVudCgpO1xyXG5cclxuICAgIGNvbnN0IHVubW9jayA9IHRoaXMubG9hZFVzZXJuYW1lTW9jaygpO1xyXG5cclxuICAgIHJldHVybiBgJHtzdGF0ZVJvb3R9P2xjdS1hcHAtZW50LWFwaS1rZXk9JHt0aGlzLlNldHRpbmdzLkFwcENvbmZpZy5FbnRlcnByaXNlQVBJS2V5fSZsY3UtZW52aXJvbm1lbnQ9JHtlbnZ9JmxjdS11c2VybmFtZS1tb2NrPSR7dW5tb2NrfWA7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgbG9hZEh1YlVybCh1cmxSb290OiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IGFwaVJvb3QgPSB0aGlzLlNldHRpbmdzID8gdGhpcy5TZXR0aW5ncy5BUElSb290IHx8ICcnIDogJyc7XHJcblxyXG4gICAgY29uc3QgaHViUGF0aCA9IHRoaXMubG9hZEh1YlBhdGgoKTtcclxuXHJcbiAgICByZXR1cm4gYCR7YXBpUm9vdH0ke3VybFJvb3QgfHwgJyd9JHtodWJQYXRofWA7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgbG9hZFN0YXRlS2V5KCk6IHN0cmluZztcclxuXHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGxvYWRTdGF0ZU5hbWUoKTogc3RyaW5nO1xyXG5cclxuICBwcm90ZWN0ZWQgbG9hZFN0YXRlUm9vdCgpIHtcclxuICAgIGNvbnN0IHN0YXRlUm9vdCA9XHJcbiAgICAgIHRoaXMuU2V0dGluZ3MuU3RhdGVDb25maWcgJiYgdGhpcy5TZXR0aW5ncy5TdGF0ZUNvbmZpZy5Sb290ICE9PSB1bmRlZmluZWRcclxuICAgICAgICA/IHRoaXMuU2V0dGluZ3MuU3RhdGVDb25maWcuUm9vdFxyXG4gICAgICAgIDogJyc7XHJcblxyXG4gICAgcmV0dXJuIGAke3N0YXRlUm9vdH0vJHt0aGlzLmxvYWRTdGF0ZU5hbWUoKX1gO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGxvYWRTdGF0ZUFjdGlvblJvb3QoKSB7XHJcbiAgICBjb25zdCBzdGF0ZUFjdGluUm9vdCA9XHJcbiAgICAgIHRoaXMuU2V0dGluZ3MuU3RhdGVDb25maWcgJiZcclxuICAgICAgdGhpcy5TZXR0aW5ncy5TdGF0ZUNvbmZpZy5BY3Rpb25Sb290ICE9PSB1bmRlZmluZWRcclxuICAgICAgICA/IHRoaXMuU2V0dGluZ3MuU3RhdGVDb25maWcuQWN0aW9uUm9vdFxyXG4gICAgICAgIDogJyc7XHJcblxyXG4gICAgcmV0dXJuIGAke3N0YXRlQWN0aW5Sb290fS8ke3RoaXMubG9hZFN0YXRlTmFtZSgpfWA7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgbG9hZFVzZXJuYW1lTW9jaygpIHtcclxuICAgIHJldHVybiB0aGlzLlNldHRpbmdzLlN0YXRlQ29uZmlnICYmIHRoaXMuU2V0dGluZ3MuU3RhdGVDb25maWcuVXNlcm5hbWVNb2NrXHJcbiAgICAgID8gdGhpcy5TZXR0aW5ncy5TdGF0ZUNvbmZpZy5Vc2VybmFtZU1vY2tcclxuICAgICAgOiAnJztcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBzZXR1cCgpIHtcclxuICAgIHRoaXMuU3RhcnQoZmFsc2UpLnRoZW4oKTtcclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBzZXR1cFJlY2VpdmVTdGF0ZShncm91cE5hbWU6IHN0cmluZykge1xyXG4gICAgdGhpcy5ydC5SZWdpc3RlckhhbmRsZXIoYFJlY2VpdmVTdGF0ZT0+JHtncm91cE5hbWV9YCkuc3Vic2NyaWJlKChyZXEpID0+IHtcclxuICAgICAgY29uc29sZS5sb2coYEhhbmRsZWQgc3RhdGUgZnJvbSAke2dyb3VwTmFtZX1gKTtcclxuXHJcbiAgICAgIHRoaXMuc3ViamVjdC5uZXh0KHJlcSk7XHJcbiAgICB9KTtcclxuICB9XHJcbn1cclxuIl19