import { __decorate } from "tslib";
import { HttpClient } from '@angular/common/http';
import { Component, Input, Output, EventEmitter, HostListener } from '@angular/core';
import { isString } from 'util';
import { FlatTreeControl } from '@angular/cdk/tree';
import { MatTreeFlattener, MatTreeFlatDataSource } from '@angular/material/tree';
import { of as observableOf } from 'rxjs';
import { MarkedRenderer } from 'ngx-markdown';
export class FileNode {
}
/** Flat node with expandable and level information */
export class FileFlatNode {
    constructor(expandable, filename, level, path) {
        this.expandable = expandable;
        this.filename = filename;
        this.level = level;
        this.path = path;
    }
}
export const originalHeading = new MarkedRenderer().heading;
export function markedOptionsFactory() {
    const renderer = new MarkedRenderer();
    let lastLevel = 0;
    renderer.heading = (text, level, raw) => {
        lastLevel = level;
        return '<h' + level + '>' + text + '</h' + level + '>\n';
    };
    renderer.link = (href, title, text) => {
        return `<a title="${title || ''}" href="${href}">${text ||
            title ||
            href}</a>`;
    };
    renderer.paragraph = (text) => {
        let pClass = '';
        switch (lastLevel) {
            case 1:
            case 2:
                pClass = 'mat-body-3';
                break;
            case 3:
            case 4:
                pClass = 'mat-body-2';
                break;
            default:
                pClass = 'mat-body-1';
                break;
        }
        return `<p class="${pClass}">${text}</p>`;
    };
    return { renderer };
}
const path = require('path-browserify');
let LcuDocsComponent = class LcuDocsComponent {
    //  Constructors
    constructor(http) {
        this.http = http;
        this.DocChange = new EventEmitter();
        this.TreeFlattener = new MatTreeFlattener(this.Transformer, this.getLevel, this.isExpandable, this.getChildren);
        this.TreeControl = new FlatTreeControl(this.getLevel, this.isExpandable);
        this.DataSource = new MatTreeFlatDataSource(this.TreeControl, this.TreeFlattener);
    }
    set Docs(docs) {
        this.http
            .get(path.join(docs, 'lcu.docs.json'))
            .subscribe((res) => {
            this.Config = res;
            this.Reload();
        });
    }
    //  Life Cycle
    ngOnInit() {
        this.Reload();
    }
    onClick(btn) {
        if (btn && btn.href && btn.href.endsWith('.md')) {
            const path = btn.href.replace(document.getElementsByTagName('base')[0].href, '');
            console.log(`Going to doc: ${path}`);
            this.GoToDoc(path);
            return false;
        }
    }
    //  API Methods
    BuildFileTree() {
        this.DataSource.data = this.buildFileTree(this.Config.Docs, 0);
    }
    FindDoc(path) {
        return this.Config.Docs.find(d => d.Path === path);
    }
    GoToDoc(docOpt) {
        const docPath = isString(docOpt)
            ? docOpt
            : docOpt.Path;
        if (this.ActiveDocPath !== docPath) {
            this.ActiveDocPath = docPath;
        }
        this.calculateActiveDocData();
        this.DocChange.emit({ DocPath: docPath });
    }
    HasChild(_, nodeData) {
        return nodeData.expandable;
    }
    Reload() {
        if (this.Config && this.Config.Docs && this.Config.Docs.length > 0) {
            this.BuildFileTree();
            this.GoToDoc(this.ActiveDocPath || this.Config.DefaultDocPath || this.Config.Docs[0]);
        }
    }
    Transformer(node) {
        return new FileFlatNode(!!node.children, node.filename, node.level, node.path);
    }
    //  Helpers
    buildFileTree(docs, level) {
        return docs.reduce((accumulator, doc) => {
            const node = this.buildFileNodeFromDoc(doc, level);
            return accumulator.concat(node);
        }, []);
    }
    buildFileNodeFromDoc(doc, level, bypassChildren) {
        const node = new FileNode();
        if (doc != null) {
            node.filename = doc.Title;
            node.level = level;
            if (!bypassChildren && doc.Children && doc.Children.length > 0) {
                node.children = this.buildFileTree(doc.Children, level + 1);
                const docCatch = Object.assign({}, doc);
                docCatch.Children = null;
            }
            else {
                node.path = doc.Path;
            }
        }
        return node;
    }
    calculateActiveDocData() {
        if (this.Config && this.ActiveDocPath) {
            this.ActiveDocData = path.join(this.Config.LocationRoot, this.ActiveDocPath);
        }
        else {
            this.ActiveDocData = null;
        }
    }
    getLevel(node) {
        return node.level;
    }
    isExpandable(node) {
        return node.expandable;
    }
    getChildren(node) {
        return observableOf(node.children);
    }
};
LcuDocsComponent.ctorParameters = () => [
    { type: HttpClient }
];
__decorate([
    Input('config')
], LcuDocsComponent.prototype, "Config", void 0);
__decorate([
    Input('docs')
], LcuDocsComponent.prototype, "Docs", null);
__decorate([
    Output('docChange')
], LcuDocsComponent.prototype, "DocChange", void 0);
__decorate([
    HostListener('click', ['$event.target'])
], LcuDocsComponent.prototype, "onClick", null);
LcuDocsComponent = __decorate([
    Component({
        selector: 'lcu-markdown-docs',
        template: "<div fxLayout=\"row\" *ngIf=\"Config\">\r\n  <div fxFlex=\"0 1 auto\">\r\n    <mat-tree [dataSource]=\"DataSource\" [treeControl]=\"TreeControl\">\r\n      <mat-tree-node\r\n        *matTreeNodeDef=\"let node\"\r\n        matTreeNodeToggle\r\n        [matTreeNodePadding]=\"Config.IndentVariant * node.level\"\r\n      >\r\n        <button mat-icon-button disabled></button>\r\n\r\n        <a mat-button (click)=\"GoToDoc(node.path)\">{{ node.filename }}</a>\r\n      </mat-tree-node>\r\n\r\n      <mat-tree-node\r\n        *matTreeNodeDef=\"let node; when: HasChild\"\r\n        [matTreeNodePadding]=\"Config.IndentVariant * node.level\"\r\n      >\r\n        <button\r\n          mat-icon-button\r\n          matTreeNodeToggle\r\n          [attr.aria-label]=\"'toggle ' + node.filename\"\r\n        >\r\n          <mat-icon class=\"mat-icon-rtl-mirror\">\r\n            {{ TreeControl.isExpanded(node) ? \"expand_more\" : \"chevron_right\" }}\r\n          </mat-icon>\r\n        </button>\r\n\r\n        <a mat-button matTreeNodeToggle>{{ node.filename }}</a>\r\n      </mat-tree-node>\r\n    </mat-tree>\r\n  </div>\r\n\r\n  <div fxFlex=\"auto\">\r\n    <div class=\"push-right\">\r\n      <ng-container *ngIf=\"!!ActiveDocData\">\r\n        <markdown [src]=\"ActiveDocData\"></markdown>\r\n      </ng-container>\r\n    </div>\r\n  </div>\r\n</div>\r\n",
        styles: [":host .mat-tree{padding:1rem}"]
    })
], LcuDocsComponent);
export { LcuDocsComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9jcy5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AbG93Y29kZXVuaXQvbGN1LWRvY3VtZW50YXRpb24tY29tbW9uLyIsInNvdXJjZXMiOlsibGliL2NvbnRyb2xzL2RvY3MvZG9jcy5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNsRCxPQUFPLEVBQ0wsU0FBUyxFQUVULEtBQUssRUFDTCxNQUFNLEVBQ04sWUFBWSxFQUNaLFlBQVksRUFDYixNQUFNLGVBQWUsQ0FBQztBQU12QixPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2hDLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUNwRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUscUJBQXFCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNqRixPQUFPLEVBQWMsRUFBRSxJQUFJLFlBQVksRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN0RCxPQUFPLEVBQWlCLGNBQWMsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUU3RCxNQUFNLE9BQU8sUUFBUTtDQUtwQjtBQUVELHNEQUFzRDtBQUN0RCxNQUFNLE9BQU8sWUFBWTtJQUN2QixZQUNTLFVBQW1CLEVBQ25CLFFBQWdCLEVBQ2hCLEtBQWEsRUFDYixJQUFZO1FBSFosZUFBVSxHQUFWLFVBQVUsQ0FBUztRQUNuQixhQUFRLEdBQVIsUUFBUSxDQUFRO1FBQ2hCLFVBQUssR0FBTCxLQUFLLENBQVE7UUFDYixTQUFJLEdBQUosSUFBSSxDQUFRO0lBQ2xCLENBQUM7Q0FDTDtBQUVELE1BQU0sQ0FBQyxNQUFNLGVBQWUsR0FBRyxJQUFJLGNBQWMsRUFBRSxDQUFDLE9BQU8sQ0FBQztBQUU1RCxNQUFNLFVBQVUsb0JBQW9CO0lBQ2xDLE1BQU0sUUFBUSxHQUFHLElBQUksY0FBYyxFQUFFLENBQUM7SUFFdEMsSUFBSSxTQUFTLEdB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QVEsRUFBRSxtQkFBbUI7UUFDN0IsdTFDQUFvQzs7S0FFckMsQ0FBQztHQUNXLGdCQUFnQixDQXVKNUI7U0F2SlksZ0JBQWdCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcclxuaW1wb3J0IHtcclxuICBDb21wb25lbnQsXHJcbiAgT25Jbml0LFxyXG4gIElucHV0LFxyXG4gIE91dHB1dCxcclxuICBFdmVudEVtaXR0ZXIsXHJcbiAgSG9zdExpc3RlbmVyXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7XHJcbiAgTGN1TWFya2Rvd25Eb2NzQ29uZmlnLFxyXG4gIExjdU1hcmtkb3duRG9jQ2hhbmdlRXZlbnQsXHJcbiAgTGN1TWFya2Rvd25Eb2NcclxufSBmcm9tICcuLi8uLi9tb2RlbHMvZG9jcy1jb25maWcnO1xyXG5pbXBvcnQgeyBpc1N0cmluZyB9IGZyb20gJ3V0aWwnO1xyXG5pbXBvcnQgeyBGbGF0VHJlZUNvbnRyb2wgfSBmcm9tICdAYW5ndWxhci9jZGsvdHJlZSc7XHJcbmltcG9ydCB7IE1hdFRyZWVGbGF0dGVuZXIsIE1hdFRyZWVGbGF0RGF0YVNvdXJjZSB9IGZyb20gJ0Bhbmd1bGFyL21hdGVyaWFsL3RyZWUnO1xyXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiBhcyBvYnNlcnZhYmxlT2YgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgTWFya2VkT3B0aW9ucywgTWFya2VkUmVuZGVyZXIgfSBmcm9tICduZ3gtbWFya2Rvd24nO1xyXG5cclxuZXhwb3J0IGNsYXNzIEZpbGVOb2RlIHtcclxuICBjaGlsZHJlbjogRmlsZU5vZGVbXTtcclxuICBmaWxlbmFtZTogc3RyaW5nO1xyXG4gIGxldmVsOiBudW1iZXI7XHJcbiAgcGF0aDogc3RyaW5nO1xyXG59XHJcblxyXG4vKiogRmxhdCBub2RlIHdpdGggZXhwYW5kYWJsZSBhbmQgbGV2ZWwgaW5mb3JtYXRpb24gKi9cclxuZXhwb3J0IGNsYXNzIEZpbGVGbGF0Tm9kZSB7XHJcbiAgY29uc3RydWN0b3IoXHJcbiAgICBwdWJsaWMgZXhwYW5kYWJsZTogYm9vbGVhbixcclxuICAgIHB1YmxpYyBmaWxlbmFtZTogc3RyaW5nLFxyXG4gICAgcHVibGljIGxldmVsOiBudW1iZXIsXHJcbiAgICBwdWJsaWMgcGF0aDogc3RyaW5nXHJcbiAgKSB7fVxyXG59XHJcblxyXG5leHBvcnQgY29uc3Qgb3JpZ2luYWxIZWFkaW5nID0gbmV3IE1hcmtlZFJlbmRlcmVyKCkuaGVhZGluZztcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBtYXJrZWRPcHRpb25zRmFjdG9yeSgpOiBNYXJrZWRPcHRpb25zIHtcclxuICBjb25zdCByZW5kZXJlciA9IG5ldyBNYXJrZWRSZW5kZXJlcigpO1xyXG5cclxuICBsZXQgbGFzdExldmVsID0gMDtcclxuXHJcbiAgcmVuZGVyZXIuaGVhZGluZyA9ICh0ZXh0OiBzdHJpbmcsIGxldmVsOiBudW1iZXIsIHJhdzogc3RyaW5nKSA9PiB7XHJcbiAgICBsYXN0TGV2ZWwgPSBsZXZlbDtcclxuICAgIHJldHVybiAnPGgnICsgbGV2ZWwgKyAnPicgKyB0ZXh0ICsgJzwvaCcgKyBsZXZlbCArICc+XFxuJztcclxuICB9O1xyXG5cclxuICByZW5kZXJlci5saW5rID0gKGhyZWY6IHN0cmluZywgdGl0bGU6IHN0cmluZywgdGV4dDogc3RyaW5nKSA9PiB7XHJcbiAgICByZXR1cm4gYDxhIHRpdGxlPVwiJHt0aXRsZSB8fCAnJ31cIiBocmVmPVwiJHtocmVmfVwiPiR7dGV4dCB8fFxyXG4gICAgICB0aXRsZSB8fFxyXG4gICAgICBocmVmfTwvYT5gO1xyXG4gIH07XHJcblxyXG4gIHJlbmRlcmVyLnBhcmFncmFwaCA9ICh0ZXh0OiBzdHJpbmcpID0+IHtcclxuICAgIGxldCBwQ2xhc3MgPSAnJztcclxuXHJcbiAgICBzd2l0Y2ggKGxhc3RMZXZlbCkge1xyXG4gICAgICBjYXNlIDE6XHJcbiAgICAgIGNhc2UgMjpcclxuICAgICAgICBwQ2xhc3MgPSAnbWF0LWJvZHktMyc7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICAgIGNhc2UgMzpcclxuICAgICAgY2FzZSA0OlxyXG4gICAgICAgIHBDbGFzcyA9ICdtYXQtYm9keS0yJztcclxuICAgICAgICBicmVhaztcclxuICAgICAgZGVmYXVsdDpcclxuICAgICAgICBwQ2xhc3MgPSAnbWF0LWJvZHktMSc7XHJcbiAgICAgICAgYnJlYWs7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGA8cCBjbGFzcz1cIiR7cENsYXNzfVwiPiR7dGV4dH08L3A+YDtcclxuICB9O1xyXG5cclxuICByZXR1cm4geyByZW5kZXJlciB9O1xyXG59XHJcblxyXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aC1icm93c2VyaWZ5Jyk7XHJcblxyXG5AQ29tcG9uZW50KHtcclxuICBzZWxlY3RvcjogJ2xjdS1tYXJrZG93bi1kb2NzJyxcclxuICB0ZW1wbGF0ZVVybDogJy4vZG9jcy5jb21wb25lbnQuaHRtbCcsXHJcbiAgc3R5bGVVcmxzOiBbJy4vZG9jcy5jb21wb25lbnQuc2NzcyddXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBMY3VEb2NzQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcclxuXHJcbiAgLy8gIFByb3BlcnRpZXNcclxuICBwdWJsaWMgQWN0aXZlRG9jRGF0YTogc3RyaW5nO1xyXG4gIHB1YmxpYyBBY3RpdmVEb2NQYXRoOiBzdHJpbmc7XHJcbiAgcHVibGljIERhdGFTb3VyY2U6IE1hdFRyZWVGbGF0RGF0YVNvdXJjZTxGaWxlTm9kZSwgRmlsZUZsYXROb2RlPjtcclxuICBwdWJsaWMgVHJlZUNvbnRyb2w6IEZsYXRUcmVlQ29udHJvbDxGaWxlRmxhdE5vZGU+O1xyXG4gIHB1YmxpYyBUcmVlRmxhdHRlbmVyOiBNYXRUcmVlRmxhdHRlbmVyPEZpbGVOb2RlLCBGaWxlRmxhdE5vZGU+O1xyXG5cclxuICBASW5wdXQoJ2NvbmZpZycpIHB1YmxpYyBDb25maWc6IExjdU1hcmtkb3duRG9jc0NvbmZpZztcclxuXHJcbiAgQElucHV0KCdkb2NzJylcclxuICBwdWJsaWMgc2V0IERvY3MoZG9jczogc3RyaW5nKSB7XHJcbiAgICB0aGlzLmh0dHBcclxuICAgICAgLmdldChwYXRoLmpvaW4oZG9jcywgJ2xjdS5kb2NzLmpzb24nKSlcclxuICAgICAgLnN1YnNjcmliZSgocmVzOiBMY3VNYXJrZG93bkRvY3NDb25maWcpID0+IHtcclxuICAgICAgICB0aGlzLkNvbmZpZyA9IHJlcztcclxuICAgICAgICB0aGlzLlJlbG9hZCgpO1xyXG4gICAgICB9KTtcclxuICB9XHJcblxyXG4gIEBPdXRwdXQoJ2RvY0NoYW5nZScpXHJcbiAgcHVibGljIERvY0NoYW5nZTogRXZlbnRFbWl0dGVyPExjdU1hcmtkb3duRG9jQ2hhbmdlRXZlbnQ+O1xyXG5cclxuICAvLyAgQ29uc3RydWN0b3JzXHJcbiAgY29uc3RydWN0b3IocHJvdGVjdGVkIGh0dHA6IEh0dHBDbGllbnQpIHtcclxuICAgIHRoaXMuRG9jQ2hhbmdlID0gbmV3IEV2ZW50RW1pdHRlcigpO1xyXG5cclxuICAgIHRoaXMuVHJlZUZsYXR0ZW5lciA9IG5ldyBNYXRUcmVlRmxhdHRlbmVyKFxyXG4gICAgICB0aGlzLlRyYW5zZm9ybWVyLFxyXG4gICAgICB0aGlzLmdldExldmVsLFxyXG4gICAgICB0aGlzLmlzRXhwYW5kYWJsZSxcclxuICAgICAgdGhpcy5nZXRDaGlsZHJlblxyXG4gICAgKTtcclxuXHJcbiAgICB0aGlzLlRyZWVDb250cm9sID0gbmV3IEZsYXRUcmVlQ29udHJvbDxGaWxlRmxhdE5vZGU+KFxyXG4gICAgICB0aGlzLmdldExldmVsLFxyXG4gICAgICB0aGlzLmlzRXhwYW5kYWJsZVxyXG4gICAgKTtcclxuXHJcbiAgICB0aGlzLkRhdGFTb3VyY2UgPSBuZXcgTWF0VHJlZUZsYXREYXRhU291cmNlKFxyXG4gICAgICB0aGlzLlRyZWVDb250cm9sLFxyXG4gICAgICB0aGlzLlRyZWVGbGF0dGVuZXJcclxuICAgICk7XHJcbiAgfVxyXG5cclxuICAvLyAgTGlmZSBDeWNsZVxyXG4gIHB1YmxpYyBuZ09uSW5pdCgpOiB2b2lkIHtcclxuICAgIHRoaXMuUmVsb2FkKCk7XHJcbiAgfVxyXG5cclxuICBASG9zdExpc3RlbmVyKCdjbGljaycsIFsnJGV2ZW50LnRhcmdldCddKVxyXG4gIHB1YmxpYyBvbkNsaWNrKGJ0bjogYW55KSB7XHJcbiAgICBpZiAoYnRuICYmIGJ0bi5ocmVmICYmIChidG4uaHJlZiBhcyBzdHJpbmcpLmVuZHNXaXRoKCcubWQnKSkge1xyXG4gICAgICBjb25zdCBwYXRoID0gYnRuLmhyZWYucmVwbGFjZShkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYmFzZScpWzBdLmhyZWYsICcnKTtcclxuXHJcbiAgICAgIGNvbnNvbGUubG9nKGBHb2luZyB0byBkb2M6ICR7cGF0aH1gKTtcclxuXHJcbiAgICAgIHRoaXMuR29Ub0RvYyhwYXRoKTtcclxuXHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vICBBUEkgTWV0aG9kc1xyXG4gIHB1YmxpYyBCdWlsZEZpbGVUcmVlKCk6IHZvaWQge1xyXG4gICAgdGhpcy5EYXRhU291cmNlLmRhdGEgPSB0aGlzLmJ1aWxkRmlsZVRyZWUodGhpcy5Db25maWcuRG9jcywgMCk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgRmluZERvYyhwYXRoOiBzdHJpbmcpOiBMY3VNYXJrZG93bkRvYyB7XHJcbiAgICByZXR1cm4gdGhpcy5Db25maWcuRG9jcy5maW5kKGQgPT4gZC5QYXRoID09PSBwYXRoKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBHb1RvRG9jKGRvY09wdDogTGN1TWFya2Rvd25Eb2MgfCBzdHJpbmcpOiB2b2lkIHtcclxuICAgIGNvbnN0IGRvY1BhdGggPSBpc1N0cmluZyhkb2NPcHQpXHJcbiAgICAgID8gZG9jT3B0IGFzIHN0cmluZ1xyXG4gICAgICA6IChkb2NPcHQgYXMgTGN1TWFya2Rvd25Eb2MpLlBhdGg7XHJcblxyXG4gICAgaWYgKHRoaXMuQWN0aXZlRG9jUGF0aCAhPT0gZG9jUGF0aCkge1xyXG4gICAgICB0aGlzLkFjdGl2ZURvY1BhdGggPSBkb2NQYXRoO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuY2FsY3VsYXRlQWN0aXZlRG9jRGF0YSgpO1xyXG4gICAgdGhpcy5Eb2NDaGFuZ2UuZW1pdCh7IERvY1BhdGg6IGRvY1BhdGggfSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgSGFzQ2hpbGQoXzogbnVtYmVyLCBub2RlRGF0YTogRmlsZUZsYXROb2RlKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gbm9kZURhdGEuZXhwYW5kYWJsZTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBSZWxvYWQoKTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5Db25maWcgJiYgdGhpcy5Db25maWcuRG9jcyAmJiB0aGlzLkNvbmZpZy5Eb2NzLmxlbmd0aCA+IDApIHtcclxuICAgICAgdGhpcy5CdWlsZEZpbGVUcmVlKCk7XHJcblxyXG4gICAgICB0aGlzLkdvVG9Eb2MoXHJcbiAgICAgICAgdGhpcy5BY3RpdmVEb2NQYXRoIHx8IHRoaXMuQ29uZmlnLkRlZmF1bHREb2NQYXRoIHx8IHRoaXMuQ29uZmlnLkRvY3NbMF1cclxuICAgICAgKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyBUcmFuc2Zvcm1lcihub2RlOiBGaWxlTm9kZSk6IEZpbGVGbGF0Tm9kZSB7XHJcbiAgICByZXR1cm4gbmV3IEZpbGVGbGF0Tm9kZSghIW5vZGUuY2hpbGRyZW4sIG5vZGUuZmlsZW5hbWUsIG5vZGUubGV2ZWwsIG5vZGUucGF0aCk7XHJcbiAgfVxyXG5cclxuICAvLyAgSGVscGVyc1xyXG4gIHByb3RlY3RlZCBidWlsZEZpbGVUcmVlKGRvY3M6IExjdU1hcmtkb3duRG9jW10sIGxldmVsOiBudW1iZXIpOiBGaWxlTm9kZVtdIHtcclxuICAgIHJldHVybiBkb2NzLnJlZHVjZTxGaWxlTm9kZVtdPigoYWNjdW11bGF0b3IsIGRvYykgPT4ge1xyXG4gICAgICBjb25zdCBub2RlID0gdGhpcy5idWlsZEZpbGVOb2RlRnJvbURvYyhkb2MsIGxldmVsKTtcclxuXHJcbiAgICAgIHJldHVybiBhY2N1bXVsYXRvci5jb25jYXQobm9kZSk7XHJcbiAgICB9LCBbXSk7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgYnVpbGRGaWxlTm9kZUZyb21Eb2MoZG9jOiBMY3VNYXJrZG93bkRvYywgbGV2ZWw6IG51bWJlciwgYnlwYXNzQ2hpbGRyZW4/OiBib29sZWFuKTogRmlsZU5vZGUge1xyXG4gICAgY29uc3Qgbm9kZSA9IG5ldyBGaWxlTm9kZSgpO1xyXG5cclxuICAgIGlmIChkb2MgIT0gbnVsbCkge1xyXG4gICAgICBub2RlLmZpbGVuYW1lID0gZG9jLlRpdGxlO1xyXG4gICAgICBub2RlLmxldmVsID0gbGV2ZWw7XHJcblxyXG4gICAgICBpZiAoIWJ5cGFzc0NoaWxkcmVuICYmIGRvYy5DaGlsZHJlbiAmJiBkb2MuQ2hpbGRyZW4ubGVuZ3RoID4gMCkge1xyXG4gICAgICAgIG5vZGUuY2hpbGRyZW4gPSB0aGlzLmJ1aWxkRmlsZVRyZWUoZG9jLkNoaWxkcmVuLCBsZXZlbCArIDEpO1xyXG4gICAgICAgIGNvbnN0IGRvY0NhdGNoID0gey4uLmRvY307XHJcbiAgICAgICAgZG9jQ2F0Y2guQ2hpbGRyZW4gPSBudWxsO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIG5vZGUucGF0aCA9IGRvYy5QYXRoO1xyXG4gICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIG5vZGU7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgY2FsY3VsYXRlQWN0aXZlRG9jRGF0YSgpOiB2b2lkIHtcclxuICAgIGlmICh0aGlzLkNvbmZpZyAmJiB0aGlzLkFjdGl2ZURvY1BhdGgpIHtcclxuICAgICAgdGhpcy5BY3RpdmVEb2NEYXRhID0gcGF0aC5qb2luKHRoaXMuQ29uZmlnLkxvY2F0aW9uUm9vdCwgdGhpcy5BY3RpdmVEb2NQYXRoKTtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuQWN0aXZlRG9jRGF0YSA9IG51bGw7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgZ2V0TGV2ZWwobm9kZTogRmlsZUZsYXROb2RlKTogbnVtYmVyIHtcclxuICAgIHJldHVybiBub2RlLmxldmVsO1xyXG4gIH1cclxuXHJcbiAgcHJvdGVjdGVkIGlzRXhwYW5kYWJsZShub2RlOiBGaWxlRmxhdE5vZGUpOiBib29sZWFuIHtcclxuICAgIHJldHVybiBub2RlLmV4cGFuZGFibGU7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgZ2V0Q2hpbGRyZW4obm9kZTogRmlsZU5vZGUpOiBPYnNlcnZhYmxlPEZpbGVOb2RlW10+IHtcclxuICAgIHJldHVybiBvYnNlcnZhYmxlT2Yobm9kZS5jaGlsZHJlbik7XHJcbiAgfVxyXG59XHJcbiJdfQ==